L.TileLayer.Functional=L.TileLayer.extend({_tileFunction:null,_tilesSubscriptions:{},initialize:function(e,i,t){this._subscribe=e,this._unsubscribe=i,L.TileLayer.prototype.initialize.call(this,null,t)},getTileData:function(e){var i=this._map,t=i.options.crs,o=this.options.tileSize,n=this._getZoomForUrl(),r=e.multiplyBy(o),a=r.add(new L.Point(o,o)),l=t.project(i.unproject(r,n)),s=t.project(i.unproject(a,n)),f=([l.x,s.y,s.x,l.y].join(","),{crs:t,nw:l,se:s,z:n,y:this.options.tms?this._tileNumBounds.max.y-e.y:e.y,x:e.x});return console.error("map ",i,e),this._subscribe(f)},_update:function(){if(this._map){var e=this._map,i=e.getPixelBounds(),t=e.getZoom(),o=this._getTileSize();if(!(t>this.options.maxZoom||t<this.options.minZoom)){var n=L.bounds(i.min.divideBy(o)._floor(),i.max.divideBy(o)._floor());this._addTilesFromCenterOut(n),this._removeOtherTiles(n)}}},_removeOtherTiles:function(e){var i,t,o,n;for(n in this._tilesSubscriptions)i=n.split(":"),t=parseInt(i[0],10),o=parseInt(i[1],10),(t<e.min.x||t>e.max.x||o<e.min.y||o>e.max.y)&&this._removeTile(n)},_removeTile:function(e){var i=this._tilesSubscriptions[e];return delete this._tilesSubscriptions[e],this._unsubscribe(i)},_tileShouldBeLoaded:function(e){if(e.x+":"+e.y in this._tilesSubscriptions)return!1;var i=this.options;if(!i.continuousWorld){var t=this._getWrapTileNum();if(i.noWrap&&(e.x<0||e.x>=t.x)||e.y<0||e.y>=t.y)return!1}if(i.bounds){var o=this._getTileSize(),n=e.multiplyBy(o),r=n.add([o,o]),a=this._map.unproject(n),l=this._map.unproject(r);if(i.continuousWorld||i.noWrap||(a=a.wrap(),l=l.wrap()),!i.bounds.intersects([a,l]))return!1}return!0},_addTile:function(e){var i=this._map,t=i.options.crs,o=this.options.tileSize,n=this._map._zoom,r=e.multiplyBy(o),a=r.add(new L.Point(o,o)),l=t.project(i.unproject(r,n)),s=t.project(i.unproject(a,n)),f=([l.x,s.y,s.x,l.y].join(","),{crs:t,nw:l,se:s,z:n,y:this.options.tms?this._tileNumBounds.max.y-e.y:e.y,x:e.x});return this._tilesSubscriptions[e.x+":"+e.y]=f,this._subscribe(f)}}),L.tileLayer.functional=function(e,i){return new L.TileLayer.Functional(e,i)};