L.TileLayer.Functional=L.TileLayer.extend({_tileFunction:null,initialize:function(e,t){this._tileFunction=e,L.TileLayer.prototype.initialize.call(this,null,t)},getTileUrl:function(e){var t=this._map,r=t.options.crs,a=this.options.tileSize,o=e.z,n=e.multiplyBy(a),i=n.add(new L.Point(a,a)),l=r.project(t.unproject(n,o)),s=r.project(t.unproject(i,o)),c=[l.x,s.y,s.x,l.y].join(","),u={bbox:c,width:a,height:a,zoom:o,tile:{row:this.options.tms?this._tileNumBounds.max.y-e.y:e.y,column:e.x},subdomain:this._getSubdomain(e)};return this._tileFunction(u)},_loadTile:function(e,t){e._layer=this,e.onload=this._tileOnLoad,e.onerror=this._tileOnError,this._adjustTilePoint(t);var r=this.getTileUrl(t);if("string"==typeof r)e.src=r,this.fire("tileloadstart",{tile:e,url:e.src});else if("function"==typeof r.then){var a=this;r.then(function(t){e.src=t,a.fire("tileloadstart",{tile:e,url:e.src})})}}}),L.tileLayer.functional=function(e,t){return new L.TileLayer.Functional(e,t)};