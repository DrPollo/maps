angular.module("firstlife.factories").factory("entityFactory",["$http","$q","$rootScope","$log","myConfig","MemoryFactory",function(e,r,t,o,i,a){function m(t,i){var a=r.defer();if(n.markerDetailsList[t])a.resolve(n.markerDetailsList[t]);else if(!i&&n.markerList[t])a.resolve(n.markerList[t]);else{var s=c.concat("/").concat(t).concat("/details").concat(d).concat("?detail=full").concat(" "),l={url:s,method:"GET",headers:{"Content-Type":"application/json"},data:{}};e(l).then(function(e){b(e.data).then(function(e){y(e,!0),a.resolve(e)},function(e){a.reject(e),o.error("EntityFactory, get, entityToMarker, error: ",e)})},function(e){a.reject(u),o.error("getMarker, error",e)})}return a.promise}function v(e,r){for(el in e){var t=e[el];n.markerList[t.id]=t,r&&(n.markerDetailsList[t.id]=t)}}function y(e,r){r?n.markerDetailsList[e.id]=e:n.markerList[e.id]=e}function _(e){if(!e)return[];var r=e,t=r.features,o=[];for(f=0;f<t.length;f++)if(t[f]&&null!=t[f]&&"undefined"!=t[f]){var i=h(t[f]);i&&o.push(i)}return o}function b(e){var t=r.defer(),i={},a=[];if("22P02"===e)t.reject("Bug, risposta: 22P02"),o.error("entityToMarker, error 22P02 ",e);else if(e&&e.features&&(a=e.features),a&&Array.isArray(a)&&a.length>0){if(i=a[0],n.mainCategories){var s=h(i);s?t.resolve(s):(o.error("Impossibile creare il marker!"),t.reject("Impossibile creare il marker!"))}else if(i){var s=h(i);s?t.resolve(s):(o.error("Impossibile creare il marker!"),t.reject("Impossibile creare il marker!"))}}else e.id?t.resolve({id:-2}):(o.error("Impossibile creare il marker!"),t.reject("no data"));return t.promise}function h(e){Array.isArray(e.properties)&&(e.properties=e.properties[0]);var r=e.properties.categories[0],t=n.categories.map(function(e){return e.category_space}).indexOf(r.category_space.id),o=n.categories[t].categories,a=i.design.colors,s=n.config.map.marker_size,l=n.config.map.marker_ancor,p={},f=n.config.types.list,d=f[f.map(function(e){return e.key}).indexOf(e.properties.entity_type)];if(!d)return null;p[0]={type:"div",className:"css-pin-marker",iconSize:s,iconAnchor:l,color:a[d.index],name:d.name,index:d.index,icon:d.icon,html:'<div class="pin-marker" style="background-color:'+a[d.index]+'"></div><div class="icon-box"><i class="icon '+d.icon+'"></i></div>'};for(x in e.properties.categories){var u=e.properties.categories[x],g=n.categories[n.categories.map(function(e){return e.category_space}).indexOf(u.category_space.id)],m=g.categories,v=parseInt(m.map(function(e){return e.id}).indexOf(e.properties.categories[x].category_space.categories[0].id)),y=m[v];g.is_visible&&(p[u.category_space.id]={type:"div",className:"css-pin-marker",name:y.name,iconSize:s,iconAnchor:l,color:y.color,index:y.colorIndex,icon:y.icon,html:'<div class="pin-marker" style="background-color:'+y.color+'"></div><div class="icon-box"><i class="icon '+y.icon+'"></i></div>'})}var t=parseInt(o.map(function(e){return e.id}).indexOf(e.properties.categories[0].category_space.categories[0].id)),_=o[t],b=e.properties.entity_type,h=n.config.types.list[n.config.types.list.map(function(e){return e.key}).indexOf(b)];h.color=a[h.index];for(var k=[],x=0;x<e.properties.categories.length;x++){var m=angular.copy(e.properties.categories[x].category_space.categories.map(function(e){return e.id}));k=k.concat(m)}if(!_)return null;var F="";F=F.concat('<i class="dotEventIcon icon ').concat(p[0].icon).concat(" color").concat(p[0].index).concat('"></i>');var w=(!angular.equals(e.properties.valid_to,e.properties.valid_from)||!e.properties.valid_from||!e.properties.valid_to,null);if(config.map&&config.map.area&&config.map.area.levels){var T=config.map.area.levels,v=T.map(function(e){return e.key}).indexOf(e.properties.level?e.properties.level:0);v>-1&&(w=T[v].name)}var j={popupOptions:{closeOnClick:!0},id:parseInt(e.properties.id),type:parseInt(e.properties.type),coordinates:e.geometry.coordinates,lat:parseFloat(e.geometry.coordinates[1]),lng:parseFloat(e.geometry.coordinates[0]),focus:!1,draggable:!1,categoryColor:_.color,colorIndex:_.colorIndex,categories:e.properties.categories,category_list:k,category:_,entity_type:b,type_info:h,catIndex:_,layer:"pie",images:Array(),icons:p,icon:p[0],name:e.properties.name,description:e.properties.description,text:e.properties.text?e.properties.text:null,message_text:e.properties.message?e.properties.message:null,tags:e.properties.tags,user:e.properties.user,parent_id:e.properties.parent_id?e.properties.parent_id:null,parent:{},group_id:e.properties.group_id?e.properties.group_id:null,group_of:e.properties.group_of?e.properties.group_of:null,location:e.properties.location?e.properties.location:null,article_of:e.properties.article_of?e.properties.article_of:null,comment_of:e.properties.comment_of?e.properties.comment_of:null,level:e.properties.level?e.properties.level:0,children_id:e.properties.children,children:{},valid_from:e.properties.valid_from,valid_to:e.properties.valid_to,id_wp:e.properties.id_wp,self:c.concat("/").concat(e.id).concat(".html"),link_url:e.properties.link_url,display_name:e.properties.display_name,last_update:e.properties.last_update,eTimeline:e.properties.valid_from||e.properties.valid_to?{id:parseInt(e.properties.id),icon:p[r.category_space]?p[r.category_space]:p[0],lat:parseFloat(e.geometry.coordinates[1]),lng:parseFloat(e.geometry.coordinates[0]),start:moment(e.properties.valid_from),end:moment(e.properties.valid_to),interval:moment.interval(moment(e.properties.valid_from),moment(e.properties.valid_to)),content:F,group:w?w:null,editable:!1,type:b,color:p[0].color}:null};return j}function k(t){var i=r.defer(),a={url:t,method:"GET",data:""},n=!1;return e(a).then(function(e){var r=_(e.data);v(r,n),i.resolve(r)},function(e){o.error("EntityFactory, errore: ",e),i.reject(e)}),i.promise}function x(e){if(e.parent_bbox){o.log("Distributed mode ON");var i=e.parent_bbox.hash;for(f=0;f<n.bboxHistory.length;f++){var t=n.bboxHistory[f];if(t.valid&&t.hash!=i&&F(t,e))return f}return(0==n.bboxHistory.length||n.bboxHistory.length>0&&n.bboxHistory[0].hash!=e.parent_bbox.hash)&&(e.parent_bbox.timestamp=new Date,e.parent_bbox.valid=!0,n.bboxHistory.unshift(e.parent_bbox)),s&&console.log("NEW history: "+n.bboxHistory.length),s&&console.log(n.bboxHistory),-1}for(f=0;f<n.bboxHistory.length;f++){var t=n.bboxHistory[f];if(t.valid){if(e.ne_lat<=t.ne_lat&&e.ne_lng<=t.ne_lng&&e.sw_lat>=t.sw_lat&&e.sw_lng>=t.sw_lng)return f;e.ne_lat>=t.ne_lat&&e.ne_lng>=t.ne_lng&&e.sw_lat<=t.sw_lat&&e.sw_lng<=t.sw_lng&&(n.bboxHistory[f].valid=!1)}s&&console.log(n.bboxHistory)}return n.bboxHistory.filter(function(e){return 0==e.timestamp?!1:!0}),e.timestamp=new Date,e.valid=!0,n.bboxHistory.push(e),-1}function F(e,r){return r.ne_lat<=e.ne_lat&&r.ne_lng<=e.ne_lng&&r.sw_lat>=e.sw_lat&&r.sw_lng>=e.sw_lng}function L(e){var r='{"type":"Feature", "properties":{}, "geometry": {}}',t=angular.fromJson(r);for(f in e)t.properties[f]=e[f];return e.coordinates?t.geometry={type:"Point",coordinates:e.coordinates}:e.coordinates?t.geometry={type:"Point",coordinates:[parseFloat(e.coordinates[0]),parseFloat(e.coordinates[1])]}:e.lat&&(t.geometry={type:"Point",coordinates:[parseFloat(e.lng),parseFloat(e.lat)]}),t}var n=this;n.config=i;for(var s=!1,c=i.backend_things,l=i.backend_bbox,p="?types=",f=0;f<n.config.types.list.length;f++)f>0&&(p=p.concat(",")),p=p.concat(n.config.types.list[f].key);n.config.map.bbox_details&&(p=p.concat("&detail=full"));var d=config.format,u=null;n.markerList={},n.markerDetailsList={},n.geoJSON={},n.timestamp=null,n.BBOX_TIMEOUT=i.behaviour.bbox_timeout,n.categories=n.config.types.categories,n.mainCategories=n.categories[0].categories;var g=[];n.bboxHistory={};for(f in n.config.types.list)g[n.config.types.list[f].key]=n.config.types.list[f].url,n.bboxHistory[n.config.types.list[f].key]=[];return{markerCreate:function(e){return h(e)},getAll:function(){{var e=r.defer();urlPlace.concat(d)}return e.resolve(n.markerList),e.promise},getAllFromCache:function(){return n.markerList},get:function(e,r){return m(e,r)},getList:function(t,o){var i=r.defer();if(n.markerDetailsList[id])i.resolve(n.markerDetailsList[id]);else if(!o&&n.markerList[id])i.resolve(n.markerList[id]);else{var a=c.concat("/").concat("details").concat(d).concat("?detail=full").concat("&things=").concat(t.join(",")),l={url:a,method:"get",headers:{"Content-Type":"application/json"},data:""};e(l).then(function(e){var r=_(e.data,!0);y(r,!0),i.resolve(r)},function(e){i.reject(e)})}return i.promise},update:function(t){var c=g[t.entity_type].concat("/").concat(t.id).concat("/update").concat(d),l=r.defer();s&&console.log("UPDATE TO: ",c,t);var p=L(t);s&&console.log("PlaceFactory, token: ",f),s&&console.log("PlaceFactory, update place query: ",t,p);var f=a.get("token"),u={url:c,method:"PUT",headers:{"Content-Type":"application/json",Authorization:f},data:p};return e(u).then(function(e){s&&console.log("entityFactory, update, response: ",e),delete n.markerDetailsList[e.data.id],delete n.markerList[e.data.id],m(e.data.id,!0).then(function(e){l.resolve(e)},function(r){o.error("entityFactory, update, get del risultato ",r),l.reject(e.data)})},function(e){l.reject(e),o.error("Update Place on the server: error! ",e)}),l.promise},create:function(t){var i=g[t.entity_type].concat("/add").concat(d),n=r.defer(),c=L(t),l=a.get("token"),p={url:i,method:"POST",headers:{"Content-Type":"application/json",Authorization:l},data:c};return s&&console.log("entityFactory, create: ",angular.toJson(c)),e(p).then(function(e){m(e.data.id,!0).then(function(e){n.resolve(e)},function(r){o.error("entityFactory, create error ",r),n.reject(e.data)})},function(e){n.reject(e),o.error("Created entity on the server: error! ",e)}),n.promise},remove:function(r){s&&console.log("placeFactory, remove id: ",r);var t=c.concat("/").concat(r).concat("/delete").concat(d);delete n.markerDetailsList[r],delete n.markerList[r];var o=a.get("token");s&&console.log("PlaceFactory, token: ",o);var i={url:t,method:"DELETE",headers:{"Content-Type":"application/json",Authorization:o},data:""};return e(i)},getBBox:function(e,t){var i=r.defer(),a=l.concat(d),s=x(e),c=p,f=!1;if(t?n.bboxHistory=[]:t=!1,c=c.concat("&ne_lat="+e.ne_lat+"&ne_lng="+e.ne_lng+"&sw_lat="+e.sw_lat+"&sw_lng="+e.sw_lng+"&limit=6000").concat("&fields=valid_from,valid_to,parent_id,location,comment_of,article_of,group_of,group_id,categories,geometry,name,user"),e.from&&(c+="&from="+e.from),e.to&&(c+="&to="+e.to),n.config.behaviour.marker_cache&&s>-1&&!t){var u=n.bboxHistory[s];u.timestamp.getTime()+n.BBOX_TIMEOUT<(new Date).getTime()?c+="&since="+u.timestamp.toISOString():(i.reject("nothing to check"),f=!0)}return f||k(a.concat(c)).then(function(e){i.resolve(e)},function(e){i.reject("getBbox, error: ",e),o.error("getBBox, error ",e)}),i.promise}}}]);