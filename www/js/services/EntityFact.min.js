angular.module("firstlife.factories").factory("entityFactory",["$http","$q","$rootScope","$log","myConfig","MemoryFactory",function(e,t,o,r,i,a){function m(o,i){var a=t.defer();if(n.markerDetailsList[o])a.resolve(n.markerDetailsList[o]);else if(!i&&n.markerList[o])a.resolve(n.markerList[o]);else{var l=s.concat("/").concat(o).concat("/details").concat(u).concat("?detail=full").concat(" "),c={url:l,method:"GET",headers:{"Content-Type":"application/json"},data:{}};e(c).then(function(e){r.debug(e),h(e.data).then(function(e){y(e,!0),a.resolve(e)},function(e){a.reject(e),r.error("EntityFactory, get, entityToMarker, error: ",e)})},function(e){a.reject(p),r.error("getMarker, error",e)})}return a.promise}function v(e,t){for(el in e){var o=e[el];n.markerList[o.id]=o,t&&(n.markerDetailsList[o.id]=o)}}function y(e,t){t?n.markerDetailsList[e.id]=e:n.markerList[e.id]=e}function _(e){if(!e)return[];var t=e,o=t.features,r=[];for(f=0;f<o.length;f++)if(o[f]&&null!=o[f]&&"undefined"!=o[f]){var i=E(o[f]);i&&r.push(i)}return r}function h(e){r.debug(e);var o=t.defer(),i={},a=[];if("22P02"===e)o.reject("Bug, risposta: 22P02"),r.error("entityToMarker, error 22P02 ",e);else if(e&&e.features&&(a=e.features),a&&Array.isArray(a)&&a.length>0){if(i=a[0],n.mainCategories){var l=E(i);l?o.resolve(l):(r.error("Impossibile creare il marker!"),o.reject("Impossibile creare il marker!"))}else if(i){var l=E(i);l?o.resolve(l):(r.error("Impossibile creare il marker!"),o.reject("Impossibile creare il marker!"))}}else e.id?o.resolve({id:-2}):(r.error("Impossibile creare il marker!"),o.reject("no data"));return o.promise}function E(e){Array.isArray(e.properties)&&(e.properties=e.properties[0]);var t=e.properties.categories[0],o=n.categories.map(function(e){return e.category_space}).indexOf(t.category_space.id),a=n.categories[o].categories,l=i.design.colors,c=n.config.map.marker_size,d=n.config.map.marker_ancor,f={},u=n.config.types.list,p=u[u.map(function(e){return e.key}).indexOf(e.properties.entity_type)];if(!p)return null;f[0]={type:"div",className:"css-pin-marker",iconSize:c,iconAnchor:d,color:l[p.index],name:p.name,index:p.index,icon:p.icon,html:'<div class="pin-marker" style="background-color:'+l[p.index]+'"></div><div class="icon-box"><i class="icon '+p.icon+'"></i></div>'};for(S in e.properties.categories){var g=e.properties.categories[S],m=n.categories[n.categories.map(function(e){return e.category_space}).indexOf(g.category_space.id)],v=m.categories,y=parseInt(v.map(function(e){return e.id}).indexOf(e.properties.categories[S].category_space.categories[0].id)),_=v[y];m.is_visible&&(f[g.category_space.id]={type:"div",className:"css-pin-marker",name:_.name,iconSize:c,iconAnchor:d,color:_.color,index:_.colorIndex,icon:_.icon,html:'<div class="pin-marker" style="background-color:'+_.color+'"></div><div class="icon-box"><i class="icon '+_.icon+'"></i></div>'})}var o=parseInt(a.map(function(e){return e.id}).indexOf(e.properties.categories[0].category_space.categories[0].id)),h=a[o],E=e.properties.entity_type,C=n.config.types.list[n.config.types.list.map(function(e){return e.key}).indexOf(E)];C.color=l[C.index];for(var k=[],S=0;S<e.properties.categories.length;S++){var v=angular.copy(e.properties.categories[S].category_space.categories.map(function(e){return e.id}));k=k.concat(v)}if(!h)return null;var T="";T=T.concat('<i class="dotEventIcon icon ').concat(f[0].icon).concat(" color").concat(f[0].index).concat('"></i>');var b=(!angular.equals(e.properties.valid_to,e.properties.valid_from)||!e.properties.valid_from||!e.properties.valid_to,null);if(config.map&&config.map.area&&config.map.area.levels){var A=config.map.area.levels,y=A.map(function(e){return e.key}).indexOf(e.properties.level?e.properties.level:0);y>-1&&(b=A[y].name)}var w={popupOptions:{closeOnClick:!0},id:parseInt(e.properties.id),type:parseInt(e.properties.type),coordinates:e.geometry.coordinates,lat:parseFloat(e.geometry.coordinates[1]),lng:parseFloat(e.geometry.coordinates[0]),focus:!1,draggable:!1,categoryColor:h.color,colorIndex:h.colorIndex,categories:e.properties.categories,category_list:k,category:h,entity_type:E,type_info:C,catIndex:h,layer:"pie",images:Array(),icons:f,icon:f[0],name:e.properties.name,description:e.properties.description,text:e.properties.text?e.properties.text:null,message_text:e.properties.message?e.properties.message:null,tags:e.properties.tags,user:e.properties.user,parent_id:e.properties.parent_id?e.properties.parent_id:null,parent:{},group_id:e.properties.group_id?e.properties.group_id:null,group_of:e.properties.group_of?e.properties.group_of:null,location:e.properties.location?e.properties.location:null,article_of:e.properties.article_of?e.properties.article_of:null,comment_of:e.properties.comment_of?e.properties.comment_of:null,level:e.properties.level?e.properties.level:0,children_id:e.properties.children,children:{},valid_from:e.properties.valid_from,valid_to:e.properties.valid_to,id_wp:e.properties.id_wp,self:s.concat("/").concat(e.id).concat(".html"),link_url:e.properties.link_url,display_name:e.properties.display_name,last_update:e.properties.last_update,eTimeline:e.properties.valid_from||e.properties.valid_to?{id:parseInt(e.properties.id),icon:f[t.category_space]?f[t.category_space]:f[0],lat:parseFloat(e.geometry.coordinates[1]),lng:parseFloat(e.geometry.coordinates[0]),start:moment(e.properties.valid_from),end:moment(e.properties.valid_to),interval:moment.interval(moment(e.properties.valid_from),moment(e.properties.valid_to)),content:T,group:b?b:null,editable:!1,type:E,color:f[0].color}:null};return r.debug("Creazione del marker dal'entita': ",e,w),w}function C(o){var i=t.defer(),a={url:o,method:"GET",data:""},n=!1;return e(a).then(function(e){var t=_(e.data);v(t,n),i.resolve(t)},function(e){r.error("EntityFactory, errore: ",e),i.reject(e)}),i.promise}function k(e){if(e.parent_bbox){r.log("Distributed mode ON");var i=e.parent_bbox.hash;for(f=0;f<n.bboxHistory.length;f++){var o=n.bboxHistory[f];if(o.valid&&o.hash!=i&&S(o,e))return f}return(0==n.bboxHistory.length||n.bboxHistory.length>0&&n.bboxHistory[0].hash!=e.parent_bbox.hash)&&(e.parent_bbox.timestamp=new Date,e.parent_bbox.valid=!0,n.bboxHistory.unshift(e.parent_bbox)),l&&console.log("NEW history: "+n.bboxHistory.length),l&&console.log(n.bboxHistory),-1}for(f=0;f<n.bboxHistory.length;f++){var o=n.bboxHistory[f];if(o.valid){if(e.ne_lat<=o.ne_lat&&e.ne_lng<=o.ne_lng&&e.sw_lat>=o.sw_lat&&e.sw_lng>=o.sw_lng)return f;e.ne_lat>=o.ne_lat&&e.ne_lng>=o.ne_lng&&e.sw_lat<=o.sw_lat&&e.sw_lng<=o.sw_lng&&(n.bboxHistory[f].valid=!1)}l&&console.log(n.bboxHistory)}return n.bboxHistory.filter(function(e){return 0==e.timestamp?!1:!0}),e.timestamp=new Date,e.valid=!0,n.bboxHistory.push(e),-1}function S(e,t){return t.ne_lat<=e.ne_lat&&t.ne_lng<=e.ne_lng&&t.sw_lat>=e.sw_lat&&t.sw_lng>=e.sw_lng}function T(e){var t='{"type":"Feature", "properties":{}, "geometry": {}}',o=angular.fromJson(t);for(f in e)o.properties[f]=e[f];return e.coordinates?o.geometry={type:"Point",coordinates:e.coordinates}:e.coordinates?o.geometry={type:"Point",coordinates:[parseFloat(e.coordinates[0]),parseFloat(e.coordinates[1])]}:e.lat&&(o.geometry={type:"Point",coordinates:[parseFloat(e.lng),parseFloat(e.lat)]}),o}var n=this;n.config=i;for(var l=!1,s=i.backend_things,c=i.backend_bbox,d="?types=",f=0;f<n.config.types.list.length;f++)f>0&&(d=d.concat(",")),d=d.concat(n.config.types.list[f].key);n.config.map.bbox_details&&(d=d.concat("&detail=full"));var u=config.format,p=null;n.markerList={},n.markerDetailsList={},n.geoJSON={},n.timestamp=null,n.BBOX_TIMEOUT=i.behaviour.bbox_timeout,n.categories=n.config.types.categories,n.mainCategories=n.categories[0].categories;var g=[];n.bboxHistory={};for(f in n.config.types.list)g[n.config.types.list[f].key]=n.config.types.list[f].url,n.bboxHistory[n.config.types.list[f].key]=[];return{markerCreate:function(e){return E(e)},getAll:function(){{var e=t.defer();urlPlace.concat(u)}return e.resolve(n.markerList),e.promise},getAllFromCache:function(){return n.markerList},get:function(e,t){return m(e,t)},getList:function(o,r){var i=t.defer();if(n.markerDetailsList[id])i.resolve(n.markerDetailsList[id]);else if(!r&&n.markerList[id])i.resolve(n.markerList[id]);else{var a=s.concat("/").concat("details").concat(u).concat("?detail=full").concat("&things=").concat(o.join(",")),c={url:a,method:"get",headers:{"Content-Type":"application/json"},data:""};e(c).then(function(e){var t=_(e.data,!0);y(t,!0),i.resolve(t)},function(e){i.reject(e)})}return i.promise},update:function(o){var s=g[o.entity_type].concat("/").concat(o.id).concat("/update").concat(u),c=t.defer();l&&console.log("UPDATE TO: ",s,o);var d=T(o);l&&console.log("PlaceFactory, token: ",f),l&&console.log("PlaceFactory, update place query: ",o,d);var f=a.get("token"),p={url:s,method:"PUT",headers:{"Content-Type":"application/json",Authorization:f},data:d};return e(p).then(function(e){l&&console.log("entityFactory, update, response: ",e),delete n.markerDetailsList[e.data.id],delete n.markerList[e.data.id],m(e.data.id,!0).then(function(e){c.resolve(e)},function(t){r.error("entityFactory, update, get del risultato ",t),c.reject(e.data)})},function(e){c.reject(e),r.error("Update Place on the server: error! ",e)}),c.promise},create:function(o){var i=g[o.entity_type].concat("/add").concat(u),n=t.defer(),s=T(o),c=a.get("token"),d={url:i,method:"POST",headers:{"Content-Type":"application/json",Authorization:c},data:s};return l&&console.log("entityFactory, create: ",angular.toJson(s)),e(d).then(function(e){r.debug("entityFactory, create, get del risultato ",e),m(e.data.id,!0).then(function(e){n.resolve(e)},function(t){r.error("entityFactory, create error ",t),n.reject(e.data)})},function(e){n.reject(e),r.error("Created entity on the server: error! ",e)}),n.promise},remove:function(t){l&&console.log("placeFactory, remove id: ",t);var o=s.concat("/").concat(t).concat("/delete").concat(u);delete n.markerDetailsList[t],delete n.markerList[t];var r=a.get("token");l&&console.log("PlaceFactory, token: ",r);var i={url:o,method:"DELETE",headers:{"Content-Type":"application/json",Authorization:r},data:""};return e(i)},getBBox:function(e,o){var i=t.defer(),a=c.concat(u),l=k(e),s=d,f=!1;if(o?n.bboxHistory=[]:o=!1,s=s.concat("&ne_lat="+e.ne_lat+"&ne_lng="+e.ne_lng+"&sw_lat="+e.sw_lat+"&sw_lng="+e.sw_lng+"&limit=6000").concat("&fields=valid_from,valid_to,parent_id,location,comment_of,article_of,group_of,group_id,categories,geometry,name,user"),e.from&&(s+="&from="+e.from),e.to&&(s+="&to="+e.to),n.config.behaviour.marker_cache&&l>-1&&!o){var p=n.bboxHistory[l];p.timestamp.getTime()+n.BBOX_TIMEOUT<(new Date).getTime()?s+="&since="+p.timestamp.toISOString():(i.reject("nothing to check"),f=!0)}return f||C(a.concat(s)).then(function(e){i.resolve(e)},function(e){i.reject("getBbox, error: ",e),r.error("getBBox, error ",e)}),i.promise}}}]);