angular.module("firstlife.services").service("EntityService",["myConfig","MemoryFactory","$filter","$log",function(e,t,o,i){function r(e){var r=t.get("user");self.config.dev&&i.debug("EntityFactory, getDefaults ",e,r);var n=new Date,l=o("date")(n,"dd/MM/yyyy, HH:mm"),s=d(e),c=s.key;self.config.dev&&i.debug("EntityFactory, getDefaults, type ",s);var f=o("translate")(s.name).concat(", ").concat(o("translate")("CREATED_BY")).concat(" ").concat(r.displayName).concat(" - ").concat(l),u="Lorem ipsum dolor sit amet, consectetur adipiscing elit. Duis varius dolor non mauris cursus consectetur. Cras eget interdum ipsum, non accumsan ligula. In ultricies fermentum velit in finibus. Fusce euismod posuere nisi id tempor. Aliquam erat volutpat. Ut pulvinar a mauris nec maximus. In volutpat justo ac est convallis, vitae pellentesque orci ultricies.",g=o("translate")(s.name).concat(" ").concat(o("translate")("OF")).concat(" ").concat(l),m=s.perms,p={};for(key in m){var v=m[key];p[key]=angular.copy(v.default)}switch(p.coordinates=[self.config.map.map_default_lng,self.config.map.map_default_lat],p.user=r?parseInt(r.id):-1,p.entity_type=c,i.debug("check entity_type",c),c){case"FL_PLACES":p.valid_from=null,p.valid_to=null;break;case"FL_EVENTS":self.config.dev&&(p.description=u);break;case"FL_ARTICLES":p.valid_from=n,self.config.dev&&(p.text=u.concat(" Mauris id venenatis arcu. Curabitur a blandit orci. Mauris eu erat turpis. Donec eget aliquam nunc. Proin nec risus quis ipsum tempus varius sed eu lorem. Ut lacus elit, semper in lobortis eget, dictum id tellus. Donec dictum auctor diam, eu sollicitudin nibh viverra sed. Etiam ut tellus eu nunc auctor porttitor. Donec metus sapien, commodo eget magna vel, maximus tristique odio. Proin aliquet in leo sit amet elementum. Vivamus dolor lacus, fermentum eu facilisis ac, gravida id augue."));break;case"FL_GROUPS":p.valid_from=n,p.valid_to=null;break;case"FL_IMAGES":p.valid_from=n,p.valid_to=n;break;case"FL_COMMENTS":p.valid_from=n,p.valid_to=n,self.config.dev&&(p.message_text=u),self.config.dev&&(p.name=g);break;case"comment":p.message=g,self.config.dev&&(p.message=u);break;default:p.type=1,self.config.dev&&(p.description=u)}var y=[];a&&i.debug("EntityService, getDefaults, init categories, cat: ",self.categories);for(var E=0;E<self.categories.length;E++){var _=self.categories[E];if(a&&i.debug("EntityService, getDefaults, init category, cat: ",_,c),_.entities.indexOf(c)>-1&&(_.is_editable||!_.is_visible&&_.is_mandatory)){var h={categories:[],category_space:_.category_space};a&&i.debug("EntityService, getDefaults, init category, c ",h),!_.is_visible&&_.is_mandatory&&(a&&i.debug("Categoria invisibile e obbligatoria ",_),h.categories.push(_.categories[0].id)),y.push(h)}}return p.categories=y,self.config.dev&&(p.name=g),i.debug("EntityService, getDefaults ",p,f),p}function n(e){for(var t=angular.copy(e),o=[],a=0;a<t.categories.length;a++){i.debug("develop ",t.categories[a]);for(var r=t.categories[a],n=[],l=0;l<r.category_space.categories.length;l++)n.push(r.category_space.categories[l].id);o.push({category_space:r.category_space.id,categories:n})}return t.categories=o,t.valid_from?t.valid_from&&(i.debug("converto data ",t.valid_from),t.valid_from=new Date(t.valid_from)):t.valid_from=null,t.valid_to?t.valid_to&&(i.debug("converto data ",t.valid_to),t.valid_to=new Date(t.valid_to)):t.valid_to=null,i.debug("EntityService, editPreProcessing, marker ",e," conversione ",t),t}function l(e){var t=d(e.entity_type),o={};a&&i.debug("processData init: ",e,t);var r=t.perms;for(var n in r)e[n]&&(o[n]=e[n]);switch(a&&i.debug("processData, type properties : ",e,o),e.entity_type){case"FL_EVENTS":o=s(e,o);break;case"FL_COMMENTS":o.valid_to=o.valid_from,o.message=o.message_text;break;case"FL_IMAGES":break;case"FL_ARTICLES":break;case"FL_GROUPS":break;default:e.type?(a&&i.debug("trovato il type: ",e.type),o.type=parseInt(e.type)):o.type=1}return o.valid_to=o.valid_to?o.valid_to.toISOString():null,o.valid_from=o.valid_from?o.valid_from.toISOString():null,a&&i.debug("EntityService, processData, semantica del tipo: ",e,o),o.entity_type=e.entity_type,o=c(e,o),e.coordinates&&(o.coordinates=[parseFloat(e.coordinates[0]),parseFloat(e.coordinates[1])]),i.debug("check data for server",o),o}function s(e,t){var o=0;if(i.debug("Set data valid_from , valid_to, door_time, close_time, duration ",e.valid_from,e.valid_to,e.door_time,e.close_time,e.duration),e.valid_from&&e.valid_to&&e.valid_from.getTime()>e.valid_to.getTime()&&(e.valid_to=angular.copy(e.valid_from)),e.valid_from&&(t.valid_from=moment(e.valid_from),e.door_time&&(t.valid_from.set({hour:0,minute:0,second:0,millisecond:0}),t.valid_from.add(e.door_time,"seconds")),i.debug("Set data valid_from Risultato ",t.valid_from)),e.valid_to&&(t.valid_to=moment(e.valid_to),e.close_time?(t.valid_to.set({hour:0,minute:0,second:0,millisecond:0}),t.valid_to.add(e.close_time,"seconds")):t.valid_to.set({hour:23,minute:59,second:59,millisecond:999}),i.debug("Set data valid_to Risultato ",t.valid_to)),t.valid_from&&t.valid_to&&(o=e.valid_to.getTime()-e.valid_from.getTime(),i.debug("EditorCtrl, calcolo durata da valid_to - valid_from:",o),t.duration=o),t.door_time){var a=parseInt(e.door_time%60);t.door_time=a}return i.debug("Set data valid_from , valid_to, door_time, close_time, duration ",t.valid_from,t.valid_to,t.door_time,t.close_time,t.duration),t}function c(e,t){var o=[];a&&i.debug("EntityService, processData, check categorie: ",e.categories);for(var r=0;r<e.categories.length;r++){var n=e.categories[r];n&&n.categories&&n.categories.length>0?o.push(n):n&&n.category_space&&n.category_space.categories&&n.category_space.categories.length>0&&o.push(n)}return t.categories=o,a&&i.debug("EntityService, processData, check categorie: ",o,e.categories,t),t}function d(e){var t=f(e);return t>-1?self.config.types.list[t]:null}function f(e){var t=self.config.types.list.map(function(e){return e.slug}).indexOf(e);return 0>t&&(t=self.config.types.list.map(function(e){return e.key}).indexOf(e)),t}self=this,self.config=e,self.categories=self.config.types.categories;var a=!1;return{getDefaults:function(e){return r(e)},processData:function(e){return l(e)},preprocessMarker:function(e){return n(e)}}}]);