angular.module("firstlife.factories").factory("groupsFactory",["$http","$q","$log","myConfig","MemoryFactory","rx",function(e,t,o,r,i,a){function d(r,a){var n=t.defer(),d=i.get("user"),f=i.get("token");if(o.debug("joining 5 ",d,f),d&&f){var u=s.concat("group/").concat(r).concat("/member/").concat(a).concat(l),p={},g={url:u,method:"delete",headers:{"Content-Type":"application/json",Authorization:f},data:p};e(g).then(function(e){o.debug(e),n.resolve(e.data),delete c[r][a]},function(e){o.error("groupsFactory, leave member, error ",e),n.reject(e)})}else n.reject({message:"no user or token"});return n.promise}var n=r,l=n.format,s=n.domain_signature,c={};return{check:function(){return!0},joinGroup:function(r){o.debug("joining 4 ",r);var a=t.defer(),n=i.get("user"),c=i.get("token");if(o.debug("joining 5 ",n,c),n&&c){var d=s.concat("member").concat(l),f={groupId:r,memberId:n.id},u={url:d,method:"post",headers:{"Content-Type":"application/json",Authorization:c},data:f};e(u).then(function(e){o.debug(e),a.resolve(e)},function(e){o.error("groupsFactory, join member, error ",e),a.reject(e)})}else a.reject({message:"no user or token"});return a.promise},leaveGroup:function(e){var o=t.defer(),r=i.get("user"),a=i.get("token");return r&&a?d(e,r.id):(o.reject({message:"no user or token"}),o.promise)},removeUser:function(e,t){return d(e,t)},checkMembership:function(r){var a=t.defer(),n=i.get("user");if(c[r]||(c[r]={}),n&&c[r][n.id])return a.resolve(c[r][n.id]),a.promise;if(n){var d=s.concat("group/").concat(r).concat("/member/").concat(n.id).concat(l),f={url:d,method:"get",headers:{"Content-Type":"application/json"},data:{}};e(f).then(function(e){a.resolve(e.data[0]),c[r][n.id]=e.data[0]},function(e){o.error("groupsFactory, check membership, error ",e),a.reject(e)})}else a.reject({message:"no user"});return a.promise},getMembers:function(o){var r=t.defer(),i=s.concat("group/").concat(o).concat("/member").concat(l),a={url:i,method:"get",headers:{"Content-Type":"application/json"},data:{}};return e(a).then(function(e){r.resolve(e.data),c[o]||(c[o]={});for(var t in e.data)c[o][e.data[t].memberId]=e.data[t]},function(e){r.reject(e)}),r.promise},getMembersRx:function(t){var o=s.concat("group/").concat(t).concat("/member").concat(l),r={url:o,method:"get",headers:{"Content-Type":"application/json"},data:{}};return members=a.Observable.fromPromise(e(r)).map(function(e){return e.data}).do(function(e){c[t]||(c[t]={});for(var o in e)c[t][e[o].memberId]=e[o]}).retry().share()}}}]);