angular.module("firstlife.directives").directive("userHandler",function(){return{restrict:"E",scope:{check:"="},templateUrl:"/templates/map-ui-template/userHandlerOmnibar.html",controller:["$scope","$log","$filter","$timeout","$state","$ionicModal","$location","notificationFactory","MemoryFactory","myConfig",function(e,t,o,r,i,a,n,l,s,c){function m(){e.user=s.get("user"),e.highlight=!1,t.debug("check user notification",e.user),e.user?v():r.cancel(f)}function v(){e.highlights=0,e.news=[],g()}function y(){l.get(u).then(function(o){e.last=new Date,t.debug("check get notfications ",o),o.length>0&&(e.highlight=!0);for(var r=0;r<o.length;r++){p<=new Date(o[r].timestamp)&&(o[r].new=!0);var i=e.news.map(function(e){return e.id}).indexOf(o[r].id);0>i&&e.news.push(o[r])}},function(e){t.error("check get notfications ",e)}),u=new Date}function h(){a.fromTemplateUrl("templates/modals/notifications.html",{scope:e,animation:"fade-in"}).then(function(t){e.notifications=t,e.notifications.show()},function(e){t.error("notification modal error",e)}),e.close=function(){t.debug("hide close"),e.notifications.hide()},e.$on("$destroy",function(){e.notifications.remove()}),e.$on("notifications.hidden",function(){t.debug("chiuse le notifiche")}),e.$on("notifications.removed",function(){}),e.$on("notifications.shown",function(){})}e.$on("$destroy",function(t){t.preventDestroyUserHandler||(t.preventDestroyUserHandler=!0,r.cancel(f),e.notifications&&e.notifications.unsubscribe(),delete e)}),e.$watch("check",function(e,t){e!=t&&m()});var d=c.behaviour.bbox_reload_time,f=!1,u=null,p=new Date;e.last=new Date;var g=function(){t.log("check notifications!"),r.cancel(f),y(),f=r(function(){g()},d)};m(),e.login=function(){i.go("login",{action:"login"})},e.show=function(){t.debug("show notifications ",e.news),h(),e.highlight=!1},e.go=function(o){t.debug("check notification ",o),o.new=!1,e.close(),n.search("entity",o.object)},e.clear=function(){e.news=[],l.consume(e.last).then(function(){},function(e){t.error("impossibile cancellare le notifiche",e)})},e.consume=function(o){var r=e.news.map(function(e){return e.id}).indexOf(o.id);r>-1&&e.news.splice(r,1),l.read(o.id).then(function(){},function(e){t.error("impossibile cancellare la notifica",e)})}}]}});