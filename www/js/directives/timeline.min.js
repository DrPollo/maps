angular.module("firstlife.timeline",[]).directive("timeline",function(){return{restrict:"EG",scope:{},templateUrl:"/templates/map-ui-template/timeline.html",controller:["$scope","$rootScope","$log","$filter","myConfig","MapService","PlatformService","leafletData",function(e,t,r,o,n,i,a){function u(){var t=angular.copy(e.moment),o=(f(t),d(t));e.now=p(moment()),e.context=m(t),e.timewindow=[];for(var n=0;n<o.length;n++)e.timewindow.push(o[n]);w()}function f(t){var r;return r="day"==c?t.date():"month"==c?t.get(e.indexDefaultUnit)+1:t.get(e.indexDefaultUnit)}function d(t){var o={hour:0,minute:0,second:0,millisecond:0},n={hour:23,minute:59,second:59,millisecond:999},i=["Notte","Mattina","Pomeriggio","Sera"];switch(e.units[e.indexDefaultUnit].key){case"hour":var a=parseInt(24/i.length),s=angular.copy(t);s.set(o);for(var l=[],c=0;c<i.length;c++){var u=angular.copy(s);u.add(c*a,"hour");var f=angular.copy(s);f.add((c+1)*a,"hour").subtract(1,"millisecond");var d=moment.interval(u,f);l.push({label:i[c],interval:d})}return l;case"day":for(var p=(moment.weekdays(),e.isMobile?"ddd":"dddd"),m=[],c=0;7>c;c++){var u=angular.copy(t).weekday(c).set(o),f=angular.copy(t).weekday(c).set(n),d=moment.interval(u,f),v={label:u.format(p),interval:d};m.push(v)}return m;case"date":for(var y=[],h=angular.copy(t),k=h.daysInMonth()+h.day(),b=1,S=1;k+6>=S;S+=7){h.date(S);var u=angular.copy(h).weekday(0),f=angular.copy(h).weekday(6),d=angular.copy(moment.interval(u,f)),_="";if(t.month()==u.month())_=_.concat(b++).concat("a ").concat("Settimana");else{if(!(u.month()<t.month()||u.year()<t.year()))break;var C=angular.copy(t).endOf("month").subtract(1,"month").day("Monday").date()-1;_=_.concat(parseInt(C/7)+1).concat("a ").concat("Settimana")}y.push({label:_,interval:d}),r.debug("check interval date ",d.start().format("DD/MM/YYYY"),d.end().format("DD/MM/YYYY"))}return y;case"month":for(var m=[],S=1;S<=t.daysInMonth();S++){var u=angular.copy(t).date(S).set(o),f=angular.copy(t).date(S).set(n),d=moment.interval(u,f);m.push({label:S,interval:d})}return m;case"year":for(var w=[],p=e.isMobile?"M":"MMM",$=angular.copy(t),c=0;12>c;c++){$.month(c);var u=angular.copy($).date(1).set(o),f=angular.copy($).date($.daysInMonth()).set(n),d=moment.interval(u,f);w.push({label:u.format(p),interval:d})}return w;default:return[]}}function p(t){var r=t;switch(e.units[e.indexDefaultUnit].key){case"hour":r=parseInt(r.hour()/6);break;case"day":r=angular.copy(r.isoWeekday())-1;break;case"date":r=parseInt(r.date()/7),"Monday"!=angular.copy(t).date(1).day()&&r++;break;case"month":r=r.date()-1;break;case"year":r=r.month();break;default:return-1}return m(t)==m(e.moment)?r:-1}function m(t){var r="";switch(e.units[e.indexDefaultUnit].key){case"hour":r=r.concat(t.format("dddd")).concat(" ").concat(t.format("D"));break;case"day":r=r.concat("dal ").concat(t.isoWeekday(1).format("D")),r=r.concat(" al ").concat(t.isoWeekday(7).format("D")),r=r.concat(" di ").concat(l._months[t.month()]);break;case"date":case"month":r=r.concat(l._months[t.month()]).concat(" ");default:r=r.concat(t.year())}return r}function v(){switch(e.units[e.indexDefaultUnit].key){case"hour":return"day";case"day":return"week";case"date":return"month";case"month":return"month";default:return"year"}return null}function y(e){if(!e)return!1;S();i.getMapBounds().then(function(t){h(e,t)},function(){})}function h(t,r){for(var o=0;o<e.timewindow.length;o++)_(t,e.timewindow[o],r)}function k(e,t){return t.contains([e.lat,e.lng])}function b(){var t={};return t.from=new Date(e.timewindow[0].interval.start().toISOString()),t.to=new Date(e.timewindow[e.timewindow.length-1].interval.end().toISOString()),t}function S(){return moment.interval(e.timewindow[0].interval.start(),e.timewindow[e.timewindow.length-1].interval.end())}function _(e,t,r){t.markers={},t.total=0;for(var o in e)if(e[o].eTimeline&&k(e[o],r)){var n=e[o].eTimeline;if(C(n.interval,t.interval)){var i=n.type;t.markers[i]||(t.markers[i]={counter:0,color:n.color}),t.markers[i].counter++,t.total++}}}function C(e,t){return e.start()&&e.start()>=t.start()&&e.start()<=t.end()?!0:e.end()&&e.end()>=t.start()&&e.end()<=t.end()?!0:e.start()&&e.end()&&e.start()<=t.start()&&e.end()>=t.end()?!0:!1}function w(){var e=b();i.setTimeFilters(e),t.$emit("timeUpdate",{time:e})}e.$on("destroy",function(){e.stopClock(),delete e}),e.data={},t.$on("timeline.refresh",function(t,r){t.preventTimelineRefresh||(t.preventTimelineRefresh=!0,angular.equals(e.data,r.list)||(e.data=angular.copy(r.list),y(r.list)))}),e.isMobile=a.isMobile(),e.show=e.isMobile?!1:!0,e.toggle=function(){e.show=!e.show},moment.locale("it"),moment().isoWeek(1);var l=moment.localeData();e.defaultUnit=1,e.indexDefaultUnit=e.defaultUnit,e.units=[{key:"hour",label:"HOUR_BUTTON"},{key:"day",label:"DAY_BUTTON"},{key:"date",label:"DATE_BUTTON"},{key:"year",label:"YEAR_BUTTON"}];var c=e.units[e.indexDefaultUnit].key;e.moment=moment(),u(),e.forward=function(){var t=v();e.moment=e.moment.add(1,t),u()},e.rewind=function(){var t=v();r.debug("subtract a ",t),e.moment=e.moment.subtract(1,t),u()},e.scaleUp=function(){e.indexDefaultUnit<e.units.length-1&&(e.indexDefaultUnit++,u())},e.scaleDown=function(t){e.indexDefaultUnit>0&&(e.moment=angular.copy(t.interval.start()),e.indexDefaultUnit--,u())},e.reset=function(){e.indexDefaultUnit=e.defaultUnit,e.moment=moment(),u()},e.resetNow=function(){e.moment=moment(),u()},e.scaleUpTo=function(t){return 0>t||t>=e.units.length||t<e.indexDefaultUnit?!1:t==e.indexDefaultUnit?!0:void(t>e.indexDefaultUnit&&(e.indexDefaultUnit=t,u()))};var g;e.clock=function(){angular.isDefined(g)||(stop=$interval(function(){p(moment())},6e4))},e.stopClock=function(){angular.isDefined(g)&&($interval.cancel(g),stop=void 0)}}]}});