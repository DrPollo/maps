angular.module("firstlife.timeline",[]).directive("timeline",function(){return{restrict:"EG",scope:{},templateUrl:"/templates/map-ui-template/timeline.html",controller:["$scope","$rootScope","$log","$filter","myConfig","MapService","PlatformService","leafletData",function(e,t,r,a,o,n,i){function u(){var t=angular.copy(e.moment),a=(p(t),f(t));e.now=m(moment()),e.context=v(t),e.timewindow=[];for(var o=0;o<a.length;o++)e.timewindow.push(a[o]);D()}function p(t){var r;return r="day"==c?t.date():"month"==c?t.get(e.indexDefaultUnit)+1:t.get(e.indexDefaultUnit)}function f(t){var r={hour:0,minute:0,second:0,millisecond:0},a={hour:23,minute:59,second:59,millisecond:999},o=["Notte","Mattina","Pomeriggio","Sera"];switch(e.units[e.indexDefaultUnit].key){case"hour":var n=parseInt(24/o.length),i=angular.copy(t);i.set(r);for(var s=[],l=0;l<o.length;l++){var c=angular.copy(i);c.add(l*n,"hour");var u=angular.copy(i);u.add((l+1)*n,"hour").subtract(1,"millisecond");var p=moment.interval(c,u);s.push({label:o[l],interval:p})}return s;case"day":for(var d=(moment.weekdays(),e.isMobile?"ddd":"dddd"),m=[],l=0;7>l;l++){var c=angular.copy(t).weekday(l).set(r),u=angular.copy(t).weekday(l).set(a),p=moment.interval(c,u),v={label:c.format(d),interval:p};m.push(v)}return m;case"date":for(var g=[],y=angular.copy(t),h=y.daysInMonth()+y.day(),_=1,b=1;h+6>=b;b+=7){y.date(b);var c=angular.copy(y).weekday(0),u=angular.copy(y).weekday(6),p=angular.copy(moment.interval(c,u)),k="";if(t.month()==c.month())k=k.concat(_++).concat("a ").concat("Settimana");else{if(!(c.month()<t.month()||c.year()<t.year()))break;var x=angular.copy(t).endOf("month").subtract(1,"month").day("Monday").date()-1;k=k.concat(parseInt(x/7)+1).concat("a ").concat("Settimana")}g.push({label:k,interval:p})}return g;case"month":for(var m=[],b=1;b<=t.daysInMonth();b++){var c=angular.copy(t).date(b).set(r),u=angular.copy(t).date(b).set(a),p=moment.interval(c,u);m.push({label:b,interval:p})}return m;case"year":for(var w=[],d=e.isMobile?"M":"MMM",D=angular.copy(t),l=0;12>l;l++){D.month(l);var c=angular.copy(D).date(1).set(r),u=angular.copy(D).date(D.daysInMonth()).set(a),p=moment.interval(c,u);w.push({label:c.format(d),interval:p})}return w;default:return[]}}function m(t){var r=t;switch(e.units[e.indexDefaultUnit].key){case"hour":r=parseInt(r.hour()/6);break;case"day":r=angular.copy(r.isoWeekday())-1;break;case"date":r=parseInt(r.date()/7),"Monday"!=angular.copy(t).date(1).day()&&r++;break;case"month":r=r.date()-1;break;case"year":r=r.month();break;default:return-1}return v(t)==v(e.moment)?r:-1}function v(t){var r="";switch(e.units[e.indexDefaultUnit].key){case"hour":r=r.concat(t.format("dddd")).concat(" ").concat(t.format("D"));break;case"day":r=r.concat("dal ").concat(t.isoWeekday(1).format("D")),r=r.concat(" al ").concat(t.isoWeekday(7).format("D")),r=r.concat(" di ").concat(l._months[t.month()]);break;case"date":case"month":r=r.concat(l._months[t.month()]).concat(" ");default:r=r.concat(t.year())}return r}function g(){switch(e.units[e.indexDefaultUnit].key){case"hour":return"day";case"day":return"week";case"date":return"month";case"month":return"month";default:return"year"}return null}function y(e){if(!e)return!1;k();n.getMapBounds().then(function(t){h(e,t)},function(){})}function h(t,r){for(var a=0;a<e.timewindow.length;a++)x(t,e.timewindow[a],r)}function _(e,t){return t.contains([e.lat,e.lng])}function b(){var t={};return t.from=new Date(e.timewindow[0].interval.start().toISOString()),t.to=new Date(e.timewindow[e.timewindow.length-1].interval.end().toISOString()),t}function k(){return moment.interval(e.timewindow[0].interval.start(),e.timewindow[e.timewindow.length-1].interval.end())}function x(e,t,r){t.markers={},t.total=0;for(var a in e)if(e[a].eTimeline&&_(e[a],r)){var o=e[a].eTimeline;if(w(o.interval,t.interval)){var n=o.type;t.markers[n]||(t.markers[n]={counter:0,color:o.color}),t.markers[n].counter++,t.total++}}}function w(e,t){return e.start()&&e.start()>=t.start()&&e.start()<=t.end()?!0:e.end()&&e.end()>=t.start()&&e.end()<=t.end()?!0:e.start()&&e.end()&&e.start()<=t.start()&&e.end()>=t.end()?!0:!1}function D(){var e=b();n.setTimeFilters(e),t.$emit("timeUpdate",{time:e})}e.$on("destroy",function(){e.stopClock(),delete e}),e.data={},t.$on("timeline.refresh",function(t,a){t.preventTimelineRefresh||(t.preventTimelineRefresh=!0,angular.equals(e.data,a.list)||(e.data=angular.copy(a.list),r.debug("timeline, timeline.refresh !"),y(a.list)))}),e.isMobile=i.isMobile(),e.show=e.isMobile?!1:!0,e.toggle=function(){e.show=!e.show},moment.locale("it"),moment().isoWeek(1);var l=moment.localeData();e.defaultUnit=1,e.indexDefaultUnit=e.defaultUnit,e.units=[{key:"hour",label:"HOUR_BUTTON"},{key:"day",label:"DAY_BUTTON"},{key:"date",label:"DATE_BUTTON"},{key:"year",label:"YEAR_BUTTON"}];var c=e.units[e.indexDefaultUnit].key;e.moment=moment(),u(),e.forward=function(){var t=g();e.moment=e.moment.add(1,t),u()},e.rewind=function(){var t=g();e.moment=e.moment.subtract(1,t),u()},e.scaleUp=function(){e.indexDefaultUnit<e.units.length-1&&(e.indexDefaultUnit++,u())},e.scaleDown=function(t){e.indexDefaultUnit>0&&(e.moment=angular.copy(t.interval.start()),e.indexDefaultUnit--,u())},e.reset=function(){e.indexDefaultUnit=e.defaultUnit,e.moment=moment(),u()},e.resetNow=function(){e.moment=moment(),u()},e.scaleUpTo=function(t){return 0>t||t>=e.units.length||t<e.indexDefaultUnit?!1:t==e.indexDefaultUnit?!0:void(t>e.indexDefaultUnit&&(e.indexDefaultUnit=t,u()))};var d;e.clock=function(){angular.isDefined(d)||(stop=$interval(function(){m(moment())},6e4))},e.stopClock=function(){angular.isDefined(d)&&($interval.cancel(d),stop=void 0)}}]}});