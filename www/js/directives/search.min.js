angular.module("firstlife.directives").directive("searchCards",function(){return{restrict:"E",scope:{},templateUrl:"/templates/map-ui-template/SearchCards.html",controller:["$scope","$location","$log","$stateParams","myConfig","MemoryFactory","MapService",function(e,t,o,r,i,a,n){function f(t){for(var o in t){var r=c.indexOf(o);if(r>-1)for(var i=t[o].toString().split(","),a=0;a<i.length;a++){var n=o.toString().concat(i[a]);e.cards[n]||u(o,i[a],s[r],n)}}for(var o in e.cards){var n=e.cards[o].search_param;t[n]||delete e.cards[o]}}function u(t,r,i,l){var s=angular.copy(i);switch(s.value=r,t){case"q":s.label2=r,e.cards.q=s;break;case"users":var c=a.get("user");r==c.id&&c.displayName?(s.label2=c.displayName,e.cards[l]=s):o.error("utente sconosciuto o mancanza di displayName",r,c);break;case"groups":n.get(r).then(function(o){o.entity_type==i.entity_type?(s.label2=o.name,e.cards[l]=s):p(t,r)},function(e){o.error("non trovo il gruppo ",r,", errore ",e),p(t,r)});break;default:o.error("Non so gestire il parametro search: ",l,r,i)}}function p(e,o){o||t.search(e,null);var r=t.search();if(r[e]){for(var i=r[e],a=i.toString().split(","),n=0;n<a.length;n++)a[n]==o&&a.splice(n,1);var l=a.join(",");""!=l?t.search(e,l):t.search(e,null)}}var l=i,s=l.map.filters,c=s.map(function(e){return e.search_param});e.cards||(e.cards={},f(t.search())),e.$on("$destroy",function(t){t.preventSearchCards||(t.preventSearchCards=!0,delete e)}),e.$watch(function(){return t.search()},function(){f(t.search())},!0),e.closeCard=function(t,o){p(t,o);var r=t.toString().concat(o);e.cards[r]&&delete e.cards[r],e.cards[t]&&delete e.cards[t]}}]}});