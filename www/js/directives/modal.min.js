angular.module("firstlife.directives").directive("simpleEntityList",function(){return{restrict:"EG",scope:{id:"=id",entityType:"=entityType",owner:"=owner",logged:"="},templateUrl:"/templates/map-ui-template/simpleEntityList.html",controller:["$scope","$log","$filter","$ionicModal","$ionicPopup","$ionicActionSheet","$timeout","SimpleEntityFactory","myConfig","MemoryFactory",function(e,t,o,r,a,n,l,s,c,d){function g(){e.groups=[];for(var t in e.types){var o=e.types[t];if(!o.exclude||o.exclude.indexOf(e.entityType)<0){var r=angular.copy(o);r.list=[],(!o.excludeAdd||o.excludeAdd.indexOf(e.entityType)<0)&&(r.enable=!0),e.groups.push(r)}}p()}function m(){for(var t=0;t<e.groups.length;t++)v(t)}function v(o){function r(t,o){for(var r=e.groups[o],i=0;i<t.length;i++){var a=t[i][r.idKey],n=r.list.map(function(e){return e[r.idKey]}).indexOf(a);0>n&&r.list.push(t[i])}for(var l=0;l<r.list.length;l++){var a=r.list[l][r.idKey],n=t.map(function(e){return e[r.idKey]}).indexOf(a);0>n&&r.list.slice(l,1)}}s.get(e.id,e.groups[o].key).then(function(e){Array.isArray(e)&&r(e,o)},function(e){t.error("groupsFactory, getMembers, error ",e)})}function y(e){var r="SUCCESS";e||(r="ERROR");n.show({titleText:o("translate")(r),cancelText:'<i class="icon ion-ios-arrow-down"></i>',cancel:function(){t.log("CANCELLED")}})}function h(o){e.boxEntity={},e.simpleEntity={type:o.key,parent:e.id,label:o.label,contentKey:o.contentKey};for(var r in o.fields)e.simpleEntity[r]=o.fields[r].default;t.debug("check simple entity init ",e.simpleEntity,o.fields)}function _(){r.fromTemplateUrl("templates/modals/simpleEditor.html",{scope:e,animation:"fade-in",backdropClickToClose:!0,hardwareBackButtonClose:!0,focusFirstInput:!0}).then(function(t){e.editor=t,e.editor.show()},function(e){t.error("open modal ",e)})}e.config=c,e.types=c.types.simpleEntities,e.groups=[],e.user=d.get("user");var f=c.behaviour.modal_relaod_time,u=!1,p=function(){t.log("simple entity polling ",e),l.cancel(u),m(),u=l(function(){p()},f)};e.$on("$destroy",function(t){t.preventSimpleEntityList||(t.preventSimpleEntityList=!0,l.cancel(u),delete e)}),e.$watch("id",function(e,t){e!=t&&(l.cancel(u),g())}),e.toggle=0,e.setToggle=function(t){e.toggle=t},e.altro=e.owner,e.$watch("owner",function(t,o){t!=o&&(e.altro=e.owner)}),g(),e.delete=function(r,i,n){e.showConfirm=function(){var l=a.confirm({title:o("translate")("DELETE"),template:o("translate")("DELETE_ASK")});l.then(function(o){o?s.delete(r,i).then(function(){var o=e.groups[n].list.map(function(t){return t[e.groups[n].idKey]}).indexOf(r);console.debug("check delete",r,i,n,e.groups[n].list,o),o>-1&&e.groups[n].list.splice(o,1),y(!0)},function(e){t.error("memers list, SimpleEntityFactory.delete, errore ",e)}):t.log("cancellazione annullata")})},e.showConfirm()},e.edit=function(t,o,r){var i=e.groups[r].list.map(function(t){return t[e.groups[r].idKey]}).indexOf(t);i>-1&&(e.publish=!1,e.type=angular.copy(e.types[o]),e.boxEntity={},e.simpleEntity=angular.copy(e.groups[r].list[i]),e.simpleEntity.type=e.type.key,e.simpleEntity.label=e.type.label,e.simpleEntity.contentKey=e.type.contentKey,e.simpleEntity.parent=e.id,_())},e.update=function(){var o={};for(var r in e.type.fields)o[r]=e.simpleEntity[r];s.update(e.simpleEntity[e.type.idKey],o,e.simpleEntity.type).then(function(){var o=e.groups.map(function(e){return e.key}).indexOf(e.simpleEntity.type),r=e.groups[o].list.map(function(t){return t[e.groups[o].idKey]}).indexOf(e.simpleEntity[e.type.idKey]);r>-1&&e.groups[o].list.splice(r,1),e.editor.hide(),y(!0)},function(e){t.error("memers list, SimpleEntityFactory.update, errore ",e)})},e.gallery={},e.slider={},e.slider.images=[],e.slider.pointer=0,e.openGallery=function(o,i){e.slider.images=i,isNaN(o)||(e.slider.pointer=o),r.fromTemplateUrl("templates/modals/gallery.html",{scope:e,animation:"fade-in"}).then(function(t){console.log("gallery modal",t),e.gallery=t,e.gallery.show()},function(e){t.error("gallery error",e)}),e.gallery.close=function(){e.gallery.hide(),$rootScope.galleryStatus=!1},e.$on("$destroy",function(){e.gallery.remove()}),e.$on("gallery.hide",function(){}),e.$on("gallery.removed",function(){}),e.$on("gallery.shown",function(){console.log("Gallery is shown!")}),e.gallery.slideChanged=function(t){e.gallery.slideIndex=t},e.slider.next=function(){e.slider.pointer<e.slider.images.length-1?e.slider.pointer++:e.slider.pointer=0},e.slider.prev=function(){e.slider.pointer>0?e.slider.pointer--:e.slider.pointer=e.slider.images.length-1},e.slider.slideTo=function(t){t>-1&&t<e.slider.images.length-1&&(e.slider.pointer=t)}},e.add=function(o){e.publish=!0,e.type=angular.copy(e.types[o]),t.debug("check type init simple entity ",e.type),h(e.type),_()},e.addEntity=function(){function a(o){s.add(o.parent,o,o.type).then(function(){e.editor.hide(),y(!0)},function(e){t.error("SimpleEditorCtrl, addComment, error: ",e),y(!1)})}if(Array.isArray(e.simpleEntity[e.simpleEntity.contentKey]))for(i in e.simpleEntity[e.simpleEntity.contentKey]){var o=e.simpleEntity[e.simpleEntity.contentKey][i],r=angular.copy(e.simpleEntity);r[r.contentKey]=o,a(r)}else a(e.simpleEntity)}}]}}).directive("entityRelations",function(){return{restrict:"EG",scope:{marker:"=marker",click:"=click"},templateUrl:"/templates/map-ui-template/entityRelations.html",controller:["$scope","$log","$filter","myConfig","MapService",function(e,t,o,r,i){function a(){if(e.marker&&e.marker.entity_type){e.relations={};var t=e.config.types.child_relations[e.marker.entity_type],r={};for(key in t){var a=t[key],n=i.searchFor(e.marker.id,a.field);if(!o("isEmpty")(n)){r[key]=angular.copy(a);for(var l=0;l<n.length;l++){var s=n[l];r[s.entity_type]||(r[s.entity_type]=angular.copy(t[s.entity_type])),r[s.entity_type].list||(r[s.entity_type].list=[]);var c=r[s.entity_type].list.map(function(e){return e.id}).indexOf(s.id);0>c&&r[s.entity_type].list.push(s)}}}e.relations.children=r;var d=e.config.types.parent_relations[e.marker.entity_type],f={},u={};for(key in d){var p=d[key];if(!o("isEmpty")(e.marker[p.field])&&!u[p.field]){u[p.field]=!0;var g=i.searchFor(e.marker[p.field],"id");f[key]=angular.copy(p),f[key].list=g}}e.relations.parents=f}}e.config=r,e.$on("$destroy",function(t){t.preventDestroyEntityRelations||(t.preventDestroyEntityRelations=!0,delete e)}),e.$watch("marker",function(e,t){e.preventEntityRelationsUpdateMarker||!e||!e.id||t&&e.id==t.id||(e.preventEntityRelationsUpdateMarker=!0,a())}),a()}]}}).directive("relationsActions",function(){return{restrict:"EG",scope:{relations:"=relations",callback:"=callback",label:"=label",id:"=id"},templateUrl:"/templates/map-ui-template/AddChildren.html",controller:["$rootScope","$scope","$log","$filter","myConfig","AuthService","groupsFactory",function(e,t,o,r,i,a){function c(){t.relationsList=angular.copy(t.relations),t.count=0;for(var e in t.relationsList)t.relationsList[e].rel.check?(d(t.relationsList[e],t.relationsList[e].rel.check),t.relationsList[e].check=!1):(t.relationsList[e].check=!0,t.count++),t.relationsList[e].color=s[t.relationsList[e].index]}function d(e,r){switch(r){case"membership":console.log("checker ",l),l.subscribe(function(){e.check=!0,t.count++},function(){o.log("no member!")},function(){})}}t.$on("$destroy",function(e){e.preventDestroyRelationsActions||(e.preventDestroyRelationsActions=!0,delete t)}),e.$on("groupReset",function(e){e.preventGroupResetRelationActions||(e.preventGroupResetRelationActions=!0,l=a.checkMembershipRx(t.id),c())});var l=a.checkMembershipRx(t.id),s=i.design.colors;c()}]}}).directive("subscribersCounter",function(){return{restrict:"EG",scope:{id:"=id",details:"="},templateUrl:"/templates/map-ui-template/subscribersCounter.html",controller:["$rootScope","$scope","$log","$filter","notificationFactory",function(e,t,o,r,i){function n(){t.counter=1,a.subscribe(function(e){o.debug("initSubscribers fired!"),Array.isArray(e)&&(t.counter=e.length)},function(e){o.error("groupsFactory, getMembers, error ",e)},function(){})}var a=i.subscribersRx(t.id);n(),t.$on("$destroy",function(e){if(!e.preventDestroyNotificationCounter){if(e.preventDestroyNotificationCounter=!0,a)try{a.unsubscribe()}catch(e){}delete t}}),t.$watch("id",function(e,t){e!=t&&n()}),e.$on("subscribersReset",function(e,t){e.preventSubscribersResetCouter||(e.preventSubscribersResetCouter=!0,a=t.observable,n())})}]}}).directive("entityActions",function(){return{restrict:"EG",scope:{actions:"=actions",marker:"=marker",close:"=close",label:"=label"},templateUrl:"/templates/map-ui-template/actionsModal.html",controller:["$rootScope","$scope","$location","$log","$filter","$ionicLoading","$ionicPopup","$ionicActionSheet","$q","AuthService","groupsFactory","MemoryFactory","notificationFactory",function(e,t,o,r,i,a,n,l,s,c,d,f,u){function g(){var e=[];"FL_GROUPS"==t.marker.entity_type&&e.push(m()),e.push(v());var o=s.all(e);o.then(function(){y()},function(e){r.error("init entityActions, err ",e)})}function m(){var e=s.defer();return d.getMembersRx(t.marker.id).subscribe(function(o){t.users=o;var r=o.map(function(e){return e.memberId}).indexOf(t.user.id);r>-1?(t.member=!0,"owner"==o[r].role&&(t.owner=!0)):(t.member=!1,t.owner=!1),e.resolve()},function(){r.log("the user is not a group member!"),t.member=!1,t.owner=!1,e.reject()},function(){e.resolve()}),e.promise}function v(){var e=s.defer();return p.subscribe(function(o){if(r.debug("initSubscribers fired!"),t.user)var i=o.indexOf(t.user.id);t.subscriber=0>i?!1:!0,e.resolve()},function(t){r.error("check subscribers ",t),e.reject(t)},function(){e.resolve()}),e.promise}function y(){t.actionList=angular.copy(t.actions);for(var e in t.actionList)switch(t.actionList[e].check){case"membership":angular.extend(t.actionList[e],{check:t.member});break;case"ownership":angular.extend(t.actionList[e],{check:t.owner});break;case"noOwnership":angular.extend(t.actionList[e],{check:!t.owner&&t.member});break;case"noMembership":angular.extend(t.actionList[e],{check:!t.member&&!t.owner});break;case"subscriber":angular.extend(t.actionList[e],{check:t.subscriber});break;case"noSubscriber":angular.extend(t.actionList[e],{check:!t.subscriber});break;default:angular.extend(t.actionList[e],{check:!0})}r.debug("check actionList ",t.actionList)}function E(e){var t="SUCCESS";e||(t="ERROR");l.show({titleText:i("translate")(t),cancelText:'<i class="icon ion-ios-arrow-down"></i>',cancel:function(){r.log("CANCELLED")}})}function C(o){switch(o){case"members":e.$emit("groupReset",{observable:d.getMembersRx(t.marker.id)});break;case"subscribers":e.$emit("subscribersReset",{observable:u.subscribersRx(t.marker.id)})}}t.member=!1,t.owner=!1,t.subscriber=!1,t.user||(t.user=f.get("user")),t.$on("$destroy",function(e){e.preventDestroyActions||(e.preventDestroyActions=!0,delete t)}),t.$watch("marker",function(e,o){!e||!e.id||o&&e.id==o.id||(p=u.subscribersRx(t.marker.id),g())});var p=null;t.marker&&(p=u.subscribersRx(t.marker.id),g()),t.actionEntity=function(e,a){switch(r.debug("check action ",e,a),e){case"unsubscribe":t.showConfirm=function(){var e=n.confirm({title:i("translate")("ENTITY_UNSUBSCRIBE"),template:i("translate")("ENTITY_UNSUBSCRIBE_ASK")});e.then(function(e){e?u.unsubscribe(t.marker.id).then(function(){t.subscriber=!1,y(),C("subscribers"),E(!0)},function(e){r.error("notificationFactory, unsubscribe, errore",e),E(!1)}):r.log("unsubscribe annullata")})},t.showConfirm();break;case"subscribe":t.showConfirm=function(){var e=n.confirm({title:i("translate")("ENTITY_SUBSCRIBE"),template:i("translate")("ENTITY_SUBSCRIBE_ASK")});e.then(function(e){e?u.subscribe(t.marker.id).then(function(){t.subscriber=!0,y(),C("subscribers"),E(!0)},function(e){r.error("notificationFactory, subscribe, errore",e),E(!1)}):r.log("subscribe annullata")})},t.showConfirm();break;case"view":o.search(a,t.marker.id),t.close();break;case"join":t.showConfirm=function(){var e=n.confirm({title:i("translate")("GROUP_JOIN"),template:i("translate")("GROUP_JOIN_ASK")});e.then(function(e){e?d.joinGroup(t.marker.id).then(function(e){t.member=!0,"owner"==e.role&&(t.owner=!0),y(),C("members"),E(!0)},function(e){r.error("actionEntity, join, errore",e),E(!1)}):r.log("join annullata")})},t.showConfirm();break;case"leave":t.showConfirm=function(){var e=n.confirm({title:i("translate")("GROUP_LEAVE"),template:i("translate")("GROUP_LEAVE_ASK")});e.then(function(e){e?d.leaveGroup(t.marker.id).then(function(){t.member=!1,t.owner=!1,y(),C("members"),E(!0)},function(e){r.error("actionEntity, leave, errore",e),r.error(e),E(!1)}):r.log("cancellazione annullata")})},t.showConfirm();break;case"users":}}}]}}).directive("loader",function(){return{scope:{},restrict:"E",template:'<div style="width:100%;text-align:center;padding:40px;"><ion-spinner icon="android" class="spinner-positive"></ion-spinner></div>'}});