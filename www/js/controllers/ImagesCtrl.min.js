angular.module("firstlife.controllers").controller("ImagesCtrl",["$scope","$state","$q","$ionicModal","$ionicSlideBoxDelegate","$ionicLoading","$ionicPopup","$rootScope","$filter","myConfig","ImageService","CamerasFactory","SenderFactory","PlatformService","MemoryFactory",function(e,t,o,i,r,a,n,l,s,c,d,f,u,g,m){function h(t){var a=o.defer();return console.log("ImagesCtrl, openGallery, params: ",t),isNaN(t)||(e.slider.pointer=t),i.fromTemplateUrl("templates/gallery.html",{scope:e,animation:"fade-in"}).then(function(o){console.log("gallery ",o),e.gallery=o,e.gallery.show(),a.resolve(!0)},function(e){console.log("gallery error",e),console.log(e),a.reject(!1)}),e.gallery.close=function(){e.gallery.hide(),r.galleryStatus=!1},e.$on("$destroy",function(){e.gallery.remove()}),e.$on("gallery.hide",function(){}),e.$on("gallery.removed",function(){}),e.$on("gallery.shown",function(){console.log("Gallery is shown!")}),e.gallery.slideChanged=function(t){e.gallery.slideIndex=t},console.log("ImagesCtrl, openGallery, gallery: ",e.gallery),a.promise}function _(t,o){size=e.isMobile?v:y,e.entity&&t==e.entity||(e.entity=t,e.images=[]);for(var i=0;i<o.length;i++){var r=e.images.map(function(e){return e.image_id}).indexOf(o[i].image_id);0>r&&e.images.push(o[i])}}e.isMobile=ionic.Platform.isIPad()||ionic.Platform.isIOS()||ionic.Platform.isAndroid()||ionic.Platform.isWindowsPhone(),e.isLoggedIn=r.isLoggedIn,e.config=c,e.images=[],e.imageCache=[],e.isPendingImages=!1,e.gallery={},e.slider={},e.slider.images=[],e.slider.pointer=0,e.isLoggedIn=!1;var p=m.get("user");p&&(e.isLoggedIn=!0);var v="thumb",y="medium";e.config.design.show_thumbs&&e.$on("checkImagePlaceModal",function(t,o){t.defaultPrevented||(t.defaultPrevented=!0,e.loadImages(o.marker.id,o.marker.entity_type))}),e.loadGallery=function(t,o,i){console.log("ImagesCtrl, loadGallery, entityId: ",t,", index: ",o);var r={size:"full",cache:!1};d.getImages(t,r,i).then(function(t){console.log("loadGallery, getImages, risultato: ",t);var i=t.images;angular.extend(e.slider.images,i),h(o)},function(e){console.log("loadGallery, getImages, errore: ",e)})},e.slider.next=function(){e.slider.pointer<e.slider.images.length-1?e.slider.pointer++:e.slider.pointer=0,console.log("ImageCtrl, slider.pointer: ",e.slider.pointer)},e.slider.prev=function(){e.slider.pointer>0?e.slider.pointer--:e.slider.pointer=e.slider.images.length-1,console.log("ImageCtrl, slider.pointer: ",e.slider.pointer)},e.slider.slideTo=function(t){t>-1&&t<e.slider.images.length-1&&(e.slider.pointer=t),console.log("ImageCtrl, slider.pointer: ",e.slider.pointer)},e.removeImage=function(t){e.imageCache.length>0&&e.imageCache.splice(t,1),e.imageCache.length<1&&(e.isPendingImages=!1)},e.loadCamera=function(){console.log("Getting camera"),f.getPicture({destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.CAMERA,quality:70,targetWidth:800,targetHeight:800,saveToPhotoAlbum:!1}).then(function(t){e.addToImageCache(t)},function(e){console.log(e)})},e.imagePicker=function(){var t={quality:70,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.PHOTOLIBRARY,targetWidth:800,targetHeight:800};$cordovaCamera.getPicture(t).then(function(t){e.addToImageCache(t)},function(e){console.log("error"+e)})},e.onLoad=function(t,o,i,r,a,n){console.log("ImagesCtrl, onLoad, fileObj: ",n),e.addToImageCache(n)},e.sendPhoto=function(t,o){console.log("immagini da salvare",e.imageCache,t),Array(e.imageCache).length>0&&u.images(e.imageCache,t,o).then(function(){e.resetImageCache(),e.refreshImages(t,o)},function(t){e.resetImageCache();var o=s("translate")("ERROR"),i=s("translate")("UNKNOWN_ERROR");switch(t.status){case"413":i=s("translate")("SIZE_ERROR")}l.alert({title:o,template:i});console.log("sendPhoto, errore",t)})},e.resetImageCache=function(){e.imageCache=[],e.isPendingImages=!1},e.loadImages=function(t,o){var i={cache:!0};e.isMobile&&(i.size="small"),e.getImages(t,i,o)},e.refreshImages=function(t,o){var i={cache:!1};e.getImages(t,i,o)},e.getImages=function(e,t,o){d.getImages(e,t,o).then(function(t){{var i=t.images;t.id}_(e,i,o)},function(e){$log.error("getImages, errore: ",e)})},e.addToImageCache=function(t){e.imageCache.indexOf(t)<0&&(e.imageCache.push(t),e.isPendingImages=!0),console.log("cache",e.imageCache,e.isPendingImages)}}]);