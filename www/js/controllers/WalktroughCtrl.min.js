angular.module("firstlife.controllers").controller("WalktroughCtrl",["$log","$scope","$state","$rootScope","$ionicPopup","$stateParams","$location","$ionicLoading","$filter","$window","UserService","myConfig","MemoryFactory",function(e,t,o,r,i,a,n,l,s,c,d,f,u){function g(e){e&&"undefined"!==e||(e=s("translate")("LOGGIN_IN")),l.show({template:e})}function m(){l.hide()}function v(){if("redirect"===a.action){var e={};a.params&&!angular.equals({},a.params)&&(p&&console.log("LoginCtrl, pre redirect a: ",a.from," con parametri: ",a.params,angular.equals({},a.params)),e=angular.fromJson(a.params));var t=a.from;delete a.from,delete a.params,p&&console.log("LoginCtrl, redirect a: ",t," con parametri: ",e),o.go(t,e)}else o.go("app.maps")}t.user={},t.defaults=f;var p=!1;t.action="login",t.$on("$stateChangeSuccess",function(e,o){e.preventDefault();var s=a.action;if(p&&console.log("sono in login, questi i parametri ",o,s),"login"===o.name){switch(s){case"logout":p&&console.log("Richiesta di logout..."),d.logout(),n.search("action","login"),t.action="login";break;case"signup":p&&console.log("Richiesta di registrazione..."),t.action="signup";break;case"password-retrieve":p&&console.log("Richiesta di recupero password..."),t.action="password-retrieve";break;case"redirect":p&&console.log("redirect a login, parametri: ",a);break;default:p&&console.log("Richiesta di login..."),t.action="login"}r.isLoggedIn||u.get("user"),r.isLoggedIn||!config.behaviour.is_login_required&&null==s?(p&&console.log("parametri di login: ",a),v()):p&&console.log("User undefined!")}}),t.defaults.dev?(t.user.email="test@firstlife.org ",t.user.password="firstlife"):(t.user.email="",t.user.password=""),t.doLogIn=function(){g(),d.login(t.user.email,t.user.password).then(function(e){m(),p&&console.log("utente loggato: ",e),r.currentUser=e,r.isLoggedIn=!0,t.isLoggedIn=!0,v()},function(o){e.error("Login data error...",o),m(),p&&console.log("Login fallito, codice: ",o);if(o.status)switch(o.status){case 403:var a=i.show({title:s("translate")("LOGIN_ERROR"),template:s("translate")("EMAIL_NOT_VERIFIED"),scope:t,buttons:[{text:s("translate")("GOT_IT"),type:"button-default",onTap:function(e){return e.preventDefault(),a.close(),!1}},{text:s("translate")("SEND_MAIL_AGAIN"),type:"button-positive",onTap:function(e){return e.preventDefault(),d.sendVerification(t.user.email).then(function(){i.alert({title:s("translate")("SUCCESS"),template:s("translate")("VERIFICATION_SENT")})},function(){i.alert({title:s("translate")("ERORR"),template:s("translate")("UNKOWN_ERROR")})}),a.close(),!0}}]});break;case 404:var a=i.alert({title:s("translate")("LOGIN_ERROR"),template:s("translate")("EMAIL_NOT_FOUND")});break;case 401:var a=i.show({title:s("translate")("LOGIN_ERROR"),template:s("translate")("WRONG_CREDENTIALS"),scope:t,buttons:[{text:s("translate")("GOT_IT"),type:"button-default",onTap:function(e){return e.preventDefault(),a.close(),!1}},{text:s("translate")("RECOVER"),type:"button-positive",onTap:function(e){return e.preventDefault(),d.retrievePassword(t.user.email).then(function(){i.alert({title:s("translate")("SUCCESS"),template:s("translate")("RECOVER_LINK_SENT")})},function(){i.alert({title:s("translate")("ERORR"),template:s("translate")("UNKOWN_ERROR")})}),a.close(),!0}}]});break;case 400:var a=i.alert({title:s("translate")("LOGIN_ERROR"),template:s("translate")("BAD_REQUEST")});break;default:var a=i.alert({title:s("translate")("LOGIN_ERROR"),template:s("translate")("UNKOWN_ERROR")})}})},t.doSignUp=function(){if(t.user.password===t.user.password2){var e=t.user;delete e.password2,g(s("translate")("SAVING_MESSAGE")),d.register(e).then(function(e){m();{var o=s("translate")("SUCCESS"),r=s("translate")("REGISTRATION_SUCCESS");i.alert({title:o,template:r})}p&&console.log("Register data...",e),t.backToLogin()},function(e){if(m(),p&&console.log("SignupCtrl, doSignUp, error: ",e),422===e.status||401===e.status){var t=s("translate")("ERROR"),o=s("translate")("USED_EMAIL");i.alert({title:t,template:o})}else{var t=s("translate")("ERROR"),o=s("translate")("UNKNOWN_ERROR");i.alert({title:t,template:o})}})}else{var o=s("translate")("ERROR"),r=s("translate")("UNKNOWN_ERROR");i.alert({title:o,template:r})}},t.retrievePassword=function(){g(s("translate")("SENDING_REQUEST")),d.retrievePassword(t.user.email).then(function(e){p&&console.log("LoginCtrl, retrievePassword, response: ",e),m();{var o=s("translate")("SUCCESS"),r=s("translate")("CHECK_EMAIL");i.alert({title:o,template:r})}t.backToLogin()},function(e){m(),console.log("LoginCtrl, retrievePassword, error: ",e);var t=s("translate")("ERROR"),o=s("translate")("UNKNOWN_ERROR");switch(e.status){case 404:o=s("translate")("EMAIL_NOT_FOUND")}i.alert({title:t,template:o})})},t.externalLinks={terms:s("translate")("TERMS_LINK"),license:s("translate")("LICENSE_LINK")},t.openExternalLink=function(e){console.log("openExternalLink",e),c.open(t.externalLinks[e])},t.goToRetrieve=function(){n.search("action","password-retrieve")},t.goToSignUp=function(){n.search("action","signup")},t.backToLogin=function(){n.search("action","login")},t.selected_tab="",t.$on("my-tabs-changed",function(e,o){t.selected_tab=o.title})}]);