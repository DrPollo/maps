angular.module("firstlife.controllers").controller("EditorCtrl",["myConfig","entityFactory","$state","$scope","$stateParams","$ionicPopup","entityFactory","EntityService","$window","$filter","TagsService","MemoryFactory","MapService","$ionicLoading","$previousState","$log",function(e,t,o,r,a,n,t,l,s,c,d,f,u,g,m,p){function E(){}function h(){y&&console.log("process data:",v.wizard.dataForm),k(c("translate")("SAVING_MESSAGE"),v.wizard.dataForm);var e=v.wizard.dataForm;null!=e.parent_id&&null!=e.parent_id.originalObject&&null!=e.parent_id.originalObject.id&&(y&&console.log("parent_id normalizzato",e.parent_id.originalObject.id),e.parent_id=e.parent_id.originalObject.id);for(var i in v.wizard.dataForm.tags)e.tags[i]=v.wizard.dataForm.tags[i].tag;v.valid_from||(e.valid_from=null),v.valid_to||(e.valid_to=null),e.title&&delete e.title,e=l.processData(e),null!=a.id&&""!=a.id?t.update(e,a.id).then(function(e){return S(),y&&console.log("update completed: ",e),o.go("app.maps",{entity:e.id}),e.id},function(e){return S(),y&&console.log("update failed: ",e),o.go("app.maps",{lat:a.lat,lng:a.lng,zoom:a.zoom,entity:-1}),-1}):u.createMarker(e).then(function(e){return S(),o.go("app.maps",{entity:e.id}),e.id},function(e){S(),p.error("creation error ",e);var t=-2;return 500==e.status&&(t=-1),o.go("app.maps",{entity:t}),-1})}function _(e){var t=l.preprocessMarker(e);t.entity_type&&(typeIndex=v.types.list.map(function(e){return e.key}).indexOf(t.entity_type),type=v.types.list[typeIndex].key,y&&console.log("EditorCtrl, edit marker, tipo: ",type," con indice: ",typeIndex," permessi: ",v.perms[typeIndex])),v.checkList=angular.copy(v.types.perms[type]),y&&console.log("EditorCtrl, setToEdit, checkList: ",v.checkList),y&&console.log("EditorCtrl received marker: ",t,v.types.list[typeIndex]),v.wizard.dataForm=angular.copy(t),v.wizard.title=v.labels.edit,v.wizard.entityLabel=v.types.list[typeIndex].name,t.coordinates&&(v.wizard.dataForm.coordinates=[t.lng,t.lat]),v.currentUser.id&&(v.wizard.dataForm.user=parseInt(v.currentUser.id)),t.id_wp&&(v.wizard.dataForm.id_wp=parseInt(t.id_wp)),null!=t.parent_id&&"undefined"!==t.parent_id&&(y&&console.log("ha un parent! ",t.parent_id),v.wizard.dataForm.parent_id=parseInt(t.parent_id),C(t.parent_id)),v.checkList.door_time&&!v.wizard.dataForm.door_time&&(y&&console.log("Entro in initDoorTime"),T()),v.checkList.duration&&!v.wizard.dataForm.duration&&(y&&console.log("Entro in initDuration"),A()),y&&console.log("EditorCtrl, checkList: ",v.checkList)}function C(e){y&&console.log("carico il parent ",e),t.get(parseInt(e)).then(function(e){y&&console.log("parent ",e),v.wizard.dataForm.parent_id=e,v.wizard.dataForm.parent_id.originalObject={},v.wizard.dataForm.parent_id.originalObject.id=e.id,y&&console.log("set del parent ",v.wizard.dataForm.parent_id)})}function k(e){"undefined"===e&&(e=c("translate")("LOADING_MESSAGE")),g.show({template:e})}function S(){g.hide()}function T(){y&&console.log("EditorCtrl, initDoorTime, c'e' door_time? ",v.checkList.door_time,v.wizard.dataForm.door_time);var e=null;v.wizard.dataForm.door_time&&(e=angular.copy(v.wizard.dataForm.door_time)),angular.extend(v.checkList.door_time,{template:{inputEpochTime:e,step:15,format:24,titleLabel:c("translate")(v.checkList.door_time.label),setLabel:'<i class="icon ion-checkmark-round"></i>',closeLabel:'<i class="icon ion-close-round"></i>',setButtonType:"button-positive",closeButtonType:"button-stable",callback:function(e){L(e)}}}),v.wizard.dataForm.door_time=angular.copy(v.checkList.door_time.template.inputEpochTime),y&&console.log("EditorCtrl, initDoorTime, aggiunta durata ",v.checkList.door_time.template," a ",v.wizard.dataForm.door_time)}function L(e){if(e)if(y&&console.log("Valore orario:",e),v.wizard.dataForm.close_time){var t=0;t+=v.wizard.dataForm.valid_to-v.wizard.dataForm.valid_from,y&&console.log("considero le date, durata:",t),86400>t&&(t=0),y&&console.log("considero le date, durata:",t," differenza tra orari? ",v.wizard.dataForm.close_time,e),t+=v.wizard.dataForm.close_time-e,y&&console.log("considero anche l'orario, durata:",t),t>=0?(v.wizard.dataForm.door_time=e,v.wizard.dataForm.duration=t):v.wizard.dataForm.door_time=v.wizard.dataForm.close_time}else v.wizard.dataForm.door_time=e;else v.wizard.dataForm.door_time=null}function A(){v.checkList.close_time=angular.copy(v.checkList.duration),v.wizard.dataForm.close_time=null;var e=null;v.wizard.dataForm.close_time&&(e=angular.copy(v.wizard.dataForm.close_time)),angular.extend(v.checkList.close_time,{template:{inputEpochTime:e,step:15,format:24,titleLabel:c("translate")(v.checkList.close_time.label),setLabel:'<i class="icon ion-checkmark-round"></i>',closeLabel:'<i class="icon ion-close-round"></i>',setButtonType:"button-positive",closeButtonType:"button-stable",callback:function(e){w(e)}}}),v.wizard.dataForm.close_time=angular.copy(v.checkList.close_time.template.inputEpochTime),y&&console.log("EditorCtrl, initDuration, aggiunta durata ",v.checkList.close_time.template," a ",v.wizard.dataForm.close_time)}function w(e){if(e)if(y&&console.log("Valore orario:",e),v.wizard.dataForm.door_time){var t=0;t+=v.wizard.dataForm.valid_to-v.wizard.dataForm.valid_from,y&&console.log("considero le date, durata:",t),86400>t&&(t=0),y&&console.log("considero le date, durata:",t," differenza tra orari? ",v.wizard.dataForm.close_time,e),t+=e-v.wizard.dataForm.door_time,y&&console.log("considero anche l'orario, durata:",t),t>=0?(v.wizard.dataForm.close_time=e,v.wizard.dataForm.duration=t):v.wizard.dataForm.close_time=v.wizard.dataForm.door_time}else v.wizard.dataForm.close_time=e;else v.wizard.dataForm.close_time=null}var v=this;v.config=e,v.translator=c("translate"),v.form={};var y=!1;v.wizard={},v.wizard.steps=["Info","Category"],v.wizard.step=0,v.valid_from=!1,v.valid_to=!1,v.types=v.config.types,v.categories=e.types.categories,y&&console.log("categorie in EditorCtrl",v.categories),v.currentUser=f.get("user"),v.labels={edit:"EDIT",create:"CREATE"},v.perms=v.types.perms,v.checkList={},v.timePickerObject={inputEpochTime:60*(new Date).getHours()*60,step:15,format:24,titleLabel:"12-hour Format",setLabel:"Set",closeLabel:"Close",setButtonType:"button-positive",closeButtonType:"button-stable",callback:function(e){E(e)}},v.removeThumbnail=function(){return delete v.wizard.dataForm.thumbnail,!1},r.$on("$stateChangeSuccess",function(e,i,r,n,s){v.wizard.dataForm={},v.wizard.step=0;var c=m.get();if(c&&c.state&&"app.maps"===c.state.name){y&&console.log("sono in EditorCtrl e vengo da ",c," parametri di cambio stato: ",a,i,r,n,s),v.currentUser=f.get("user");var d=v.types.default.key,u=v.types.default.id;if(null!=a.id&&""!=a.id)t.get(a.id,!0).then(function(e){e.coordinates=[a.lng,a.lat],e.lat=a.lat,e.lng=a.lng,_(e),v.wizard.dataForm.valid_from&&(v.valid_from=!0),v.wizard.dataForm.valid_to&&(v.valid_to=!0)},function(e){y&&console.log("EditorCtrl, cambio di stato, edit marker, entityFactory.get, errore: ",e)});else{a.entity_type&&(u=v.types.list.map(function(e){return e.slug}).indexOf(a.entity_type),d=v.types.list[u].key,v.wizard.title=v.labels.create,v.wizard.entityLabel=v.types.list[u].name),v.checkList=v.config.types.perms[d],angular.extend(v.wizard.dataForm,l.getDefaults(a.entity_type)),v.wizard.dataForm.valid_from&&(v.valid_from=!0),v.wizard.dataForm.valid_to&&(v.valid_to=!0),a.lng&&a.lng&&(v.wizard.dataForm.coordinates=[parseFloat(a.lng),parseFloat(a.lat)]);for(var g=v.config.types.relations,E=0;E<g.list.length;E++){var h=g.list[E],C=g.map[h];a[h]&&(v.wizard.dataForm[C]=parseInt(a[h]))}v.checkList.door_time&&T(),v.checkList.duration&&A(),p.debug("EditCtrl, init del form: ",v.wizard.dataForm)}}else y&&console.log("Ignoro perche' vengo da un altro stato o via link diretto, faccio redirect a app.maps"),a&&a.lat&&a.lng?o.go("app.maps",{lat:a.lat,lng:a.lng}):o.go("app.maps")}),v.greaterThan=function(e,t){return function(o){return o[e]>t}},v.differentThan=function(e,t){return function(o){return o[e]!=t}},v.datePickerFrom=function(e){y&&console.log("date picker from!",e),"undefined"==typeof e?(y&&console.log("Date not selected"),v.valid_from=!1,v.wizard.dataForm.valid_from=null):(y&&console.log("Selected date is : ",e),v.valid_from=!0)},v.datePickerTo=function(e){y&&console.log("date picker to!",e),"undefined"==typeof e?(y&&console.log("Date not selected"),v.valid_to=!1,v.wizard.dataForm.valid_to=null):(y&&console.log("Selected date is : ",e),v.valid_to=!0)},v.loadTags=function(e){return d.query(e).then(function(t){return y&&console.log("EditorCtrl, loadTags response: ",t),t.filter(function(t){return y&&console.log(t),-1!=t.tag.toLowerCase().indexOf(e.toLowerCase())})})},r.isCatRelevant=function(e){var t=e.entities.indexOf(v.wizard.dataForm.entity_type)>-1&&e.is_editable;return t},v.normalizeTags=function(e){var t=e,o="";for(i in e)o+=String(t[i].tag)+",",y&&console.log("tag",o[i]);return o.substring(0,o.length-1).split(",")},v.close=function(){y&&console.log("Editor Ctrl, chiudo wizard ",a),v.wizard.dataForm={},o.go("app.maps",{lat:a.lat,lng:a.lng})},v.wizard.isFirstStep=function(){return 0===v.wizard.step},v.wizard.isLastStep=function(){return v.wizard.step===v.wizard.steps.length-1},v.wizard.isCurrentStep=function(e){return v.wizard.step===e},v.wizard.setCurrentStep=function(e){v.wizard.step=e},v.wizard.getCurrentStep=function(){return v.wizard.steps[v.wizard.step]},v.wizard.getNextLabel=function(){return y&&console.log(v.form),v.wizard.isLastStep()?"Submit":"Next"},v.wizard.handlePrevious=function(){v.wizard.step-=v.wizard.isFirstStep()?0:1},v.wizard.handleNext=function(e){y&&console.log("handlenext: ",v.wizard.dataForm),y&&console.log(e),e?v.wizard.isLastStep()?(y&&console.log("form valido ",v.wizard.dataForm),h()):v.wizard.step+=1:y&&console.log("errore, form non valido!")},v.wizard.save=function(){y&&console.log("form valido ",v.wizard.dataForm),h()}}]);