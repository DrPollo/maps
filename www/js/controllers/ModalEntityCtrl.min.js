angular.module("firstlife.controllers").controller("ModalEntityCtrl",["$scope","$ionicModal","$ionicPopover","$ionicActionSheet","$ionicLoading","$ionicPopup","$log","$filter","myConfig","MapService","MemoryFactory","AuthService","groupsFactory",function(e,t,o,r,a,i,n,l,s,c,d,f){function v(t){e.obs=c.getDetailsRx(t).subscribe(function(t){e.infoPlace.marker=angular.copy(t),e.$emit("openPlaceModal",{marker:t.id}),e.loaded=!0,C(t.user),S(t.entity_type)},function(t){n.error("changeModal, errore ",t),e.loaded=!0,e.error=!0,h()},function(){})}function E(){e.popover&&e.popover.hide(),e.infoPlace.modal&&e.infoPlace.modal.remove(),e.$emit("closePlaceModal"),n.debug("check closePlaceModal"),delete e.infoPlace.modal;try{p()}catch(t){}}function h(e){e||(e={}),e.title||(e.title=l("translate")("ERROR")),e.text||(e.text=l("translate")("UNKNOWN_ERROR"));i.alert({title:e.title,template:e.text})}function C(t){if(e.user||(e.user=d.get("user")),!e.user)return!1;var o="others";return t==e.user.id&&(o="self"),e.checkPerms=f.checkPerms(o),e.perms}function S(t){var o=e.config.types.list.map(function(e){return e.key}).indexOf(t);e.currentType=e.config.types.list[o]}e.config=s,e.infoPlace={},e.now=new Date;var g=!1,p=null;e.isMobile=ionic.Platform.isIPad()||ionic.Platform.isIOS()||ionic.Platform.isAndroid()||ionic.Platform.isWindowsPhone(),e.$on("ModalEntityCtrl",function(t){t.ModalEntityCtrlPrevented||(t.ModalEntityCtrlPrevented=!0,e.closeModal())}),e.$on("markerClick",function(t,o){t.markerClickPrevented||(t.markerClickPrevented=!0,o.markerId&&e.showMCardPlace(o.markerId))}),e.$on("markerClickClose",function(t){t.markerClickClosePrevented||(t.markerClickClose=!0,e.closeModal())}),e.$on("$destroy",function(t){if(!t.destroyModalDestroyPrevented){t.destroyModalDestroyPrevented=!0,n.debug("destroy modal");try{e.obs.unsubscribe()}catch(t){}delete e}}),e.showMCardPlace=function(o){e.loaded=!1,e.error=!1,delete e.infoPlace.marker,n.debug("check hide!",p,o),p||(n.debug("init hide"),p=e.$on("modal.hidden",function(t){e.infoPlace.modal&&!t.modalHiddenPrevented&&(t.modalHiddenPrevented=!0,n.debug("check hide listner!",p),p(),p=null,E())})),e.infoPlace.modal?e.infoPlace.modal.show():(e.infoPlace={},e.infoPlace.modify=!1,e.infoPlace.dataForm={},t.fromTemplateUrl("templates/modals/cardPlace.html",{scope:e,animation:"fade-in",backdropClickToClose:!0,hardwareBackButtonClose:!0}).then(function(t){n.debug("infoPlace, apro modal modal: ",t),e.infoPlace.modal=t,e.openModalPlace()})),v(o),e.openModalPlace=function(){e.infoPlace.modal.show(),e.showPopoverMenu()},e.closeModal=function(){E()}},e.showASDeletedPlace=function(e){var t="";t=l("translate")(-1===e?"ERROR_CANCEL":"SUCCESS_CANCEL");var o=r.show({titleText:t,cancelText:'<i class="icon ion-ios-arrow-down"></i>',cancel:function(){n.debug("Deleted place cancelled: "+e)}});n.debug("actionSheet",o)},e.showPopoverMenu=function(){o.fromTemplateUrl("templates/map-ui-template/ModalPopoverMenu.html",{scope:e}).then(function(t){e.popover=t}),e.openPopover=function(t){e.popover.show(t)},e.closePopover=function(){e.popover.hide()},e.removeButtonPopover=function(){var t=e.infoPlace.marker;g&&console.log("rimuovo il place ",t),e.closePopover(),e.remove(t)},e.updateButtonPopover=function(){var t=e.infoPlace.marker;e.closePopover(),e.updateEntity(t)},e.$on("$destroy",function(){e.popover.remove()})},e.remove=function(t){g&&console.log("ModalPlaceController, showASRemove, id: ",t.id),e.showConfirm=function(){var o=i.confirm({title:l("translate")("DELETE"),template:l("translate")("DELETE_ASK")});o.then(function(o){o?c.removeMarker(t.id).then(function(){e.showASDeletedPlace(t.id),e.$emit("deleteMarker",{id:t.id}),e.closeModal()},function(t){e.showASDeletedPlace(-1),n.error("Failed to get required marker, result is "+t)}):n.log("cancellazione annullata")})},e.showConfirm()},e.showASDeleted=function(e){var t="";t=l("translate")(-1===e?"ERROR_CANCEL":"SUCCESS_CANCEL");r.show({titleText:t,cancelText:'<i class="icon ion-ios-arrow-down"></i>',cancel:function(){}})},e.updateEntity=function(t){var o={lat:t.lat,lng:t.lng,id:t.id};e.$emit("startEditing",o),e.closeModal()},e.addChildEntity=function(t,o){var r=t.slug,a=t.key,i=e.currentType.relations;n.debug("check add children ",a,r,o,i);var l=!1;i[a].bounded&&(l=!0),n.debug("add child ",r,o),r||(type=parent_type);var s=e.infoPlace.marker,c={lat:s.lat,lng:s.lng,entity_type:r,skip:l};c[o]=s.id,e.$emit("startEditing",c),e.closeModal()}}]);