angular.module("firstlife.controllers").controller("MapCtrl",["$scope","$state","$stateParams","$ionicModal","$ionicActionSheet","$ionicPopup","$cordovaGeolocation","$ionicLoading","$q","$ionicPopover","$rootScope","$window","$location","$filter","$timeout","$log","leafletData","leafletMapEvents","entityFactory","MapService","myConfig","PlatformService","MemoryFactory","AreaService","leafletMarkersHelpers","indexingFactory",function(e,t,o,n,r,a,l,s,c,f,u,d,p,m,g,v,y,h,C,b,_,x,w,M,F,S){function I(t){var i=t.properties,o=e.markersFilteredArray.length,n={fillColor:"#6C93B3",weight:2,opacity:.5,color:"#6C93B3",dashArray:"1",fillOpacity:.05};return i.entities.length>0&&(n.fillColor="rgb(136, 186, 92)",n.color="rgb(136, 186, 92)",n.fillOpacity=i.entities.length/20),i.entities.length>20&&(n.fillColor="rgb(255,179,16)",n.color="rgb(255,179,16)",n.fillOpacity=i.entities.length/60),i.entities.length>40&&(n.fillColor="rgb(221,91,42)",n.color="rgb(221,91,42)",n.fillOpacity=i.entities.length/(3*o)),n}function R(t){T&&console.log("markerClick! ",t),e.$broadcast("markerClick",{markerId:parseInt(t)})}function q(){var e=p.search();b.getCenter().then(function(t){T&&console.log("centro della mappa, ",t),(e.lat!=t.lat||e.lng!=t.lng||e.zoom!=t.zoom)&&U(t)},function(e){T&&console.log("updatePositionInSearch, MapService.getCenter, errore: ",e)})}function B(e){b.getCenter().then(function(t){t.entity=e,U(t)},function(e){T&&console.log("updatePlaceInSearch, MapService.getCenter, errore: ",e)})}function U(e){for(key in e)self.watchSearchEnabled=!1,p.search(key,e[key]);T&&console.log("nuovi parametri search: ",p.search(),e)}function N(e){self.watchSearchEnabled=!1,p.search(e,null),self.watchSearchEnabled=!0}function W(t){if(T&&console.log("centro su luogo, id: "+typeof t+" ",t),"object"==typeof t&&"entity"in t&&t.entity)st(t.entity);else if("number"==typeof t)st(t);else if("object"==typeof t&&"bound"in t)T&&console.log("centro su bounds: ",t),G(t);else if("object"==typeof t&&"lat"in t&&"lng"in t&&t.lat&&t.lng){T&&console.log("centro su coordinate: ",t);var i={lat:parseFloat(t.lat),lng:parseFloat(t.lng),zoom:parseInt(t.zoom?t.zoom:z.map.zoom_create)};T&&console.log("centro su coordinate: ",i),G(i)}else if("user"===t)s.show({content:'<div>Localizzazione in corso...<br> Assicurati di aver abilitato il gps o il browser!<i class="icon ion-loading-c"></i></div>',animation:"fade-in",showBackdrop:!1,maxWidth:50,showDelay:0}),l.getCurrentPosition().then(function(i){T&&console.log(t),e.markersFiltered[0]={lat:i.coords.latitude,lng:i.coords.longitude,focus:!0,draggable:!1};var o={lat:i.coords.latitude,lng:i.coords.longitude,zoom:parseInt(z.map.zoom_create)};G(o),s.hide()},function(e){T&&console.log("Location error: ",e),s.hide()});else{var i={lat:parseFloat(e.config.map.map_default_lat),lng:parseFloat(e.config.map.map_default_lng),zoom:parseInt(e.config.map.zoom_level)};G(i)}}function G(e){y.getMap("mymap").then(function(t){if(T&&console.log("MapService, setMapCenter, response: ",t," params ",e),e.bound)t.fitBounds(e.bound);else if(e.zoom){var i=new L.LatLng(e.lat,e.lng);t.setView(i,e.zoom)}else{var i=new L.LatLng(e.lat,e.lng);t.panTo(i)}var o=t.getCenter(),n=t.getZoom(),r={lat:o.lat,lng:o.lng,zoom:n};T&&console.log("Nuovo centro della mappa",r)},function(e){T&&console.log("MapService, setMapCenter, errore: ",e)})}function H(e){v.debug("MapCtrl, backFromEditor, entityId: ",e);var t={};if(-1==e){t.title=m("translate")("ERROR"),t.text=m("translate")("UNKNOWN_ERROR");var i=r.show({titleText:t.text,cancelText:'<i class="icon ion-ios-arrow-down"></i>',cancel:function(){T&&console.log("CANCELLED")}});T&&console.log("actionSheet",i),u.actionSheet=i,u.actionStatus=!0}if(-2==e){t.title=m("translate")("SUCCESS"),t.text=m("translate")("SUCCESS_MODARATION");var i=r.show({titleText:t.text,cancelText:'<i class="icon ion-ios-arrow-down"></i>',cancel:function(){T&&console.log("CANCELLED")}});T&&console.log("actionSheet",i),u.actionSheet=i,u.actionStatus=!0}else if(e>0){t.title=m("translate")("SUCCESS"),t.text=m("translate")("SAVE_SUCCESS"),nt(e),R(e);var i=r.show({titleText:t.text,cancelText:'<i class="icon ion-ios-arrow-down"></i>',cancel:function(){T&&console.log("CANCELLED")}});T&&console.log("actionSheet",i),u.actionSheet=i,u.actionStatus=!0}else T&&console.log("creazione/modifica ok!")}function Z(t){var o=!1,n=function(e,t,i){return T&&console.log("markerFilter, comparison, a, b, equal ",e,t,i),Array.isArray(e)?i?(T&&console.log(e,"==",t,"? ",e==t),e.indexOf(t)>=0):e.indexOf(t)<0:i?(T&&console.log(e,"==",t,"? ",e==t),e==t):(T&&console.log(e,"!=",t,"? ",e!=t),e!=t)};T&&console.log("entry: ",t," Condizioni: ",e.filterConditions);for(key in e.filterConditions){T&&console.log("il tipo e' da includere? ",e.filterConditions[key].includeTypes.indexOf(t.entity_type)>-1);var r=0;if(e.filterConditions[key].includeCondition){var a=t[e.filterConditions[key].includeCondition.property],l=Object.keys(e.filterConditions[key].includeCondition.value)[0];r=a.map(function(e){return e[l].id}).indexOf(e.filterConditions[key].includeCondition.value[l]),T&&console.log("check per includeCondition ",r>-1)}if(T&&console.log("il tipo e' da includere? ",e.filterConditions[key].includeTypes.indexOf(t.entity_type)>-1),!e.filterConditions[key].excludeRule&&e.filterConditions[key].includeTypes.indexOf(t.entity_type)>-1&&r>-1){if(e.filterConditions[key].excludeProperty){var s=t[e.filterConditions[key].key];if(T&&console.log("Check esclusione regola: ",e.filterConditions[key].excludeProperty,t,e.filterConditions[key].key,s),!(!s||null===s||"undefined"===s||Array.isArray(s)&&0==s.length||angular.isObject(s)&&angular.equals(s,{})))return!1;console.log("property non impostata per: ",t,"prorpieta'",e.filterConditions[key].key)}var c=e.filterConditions[key].mandatory.condition,f=e.filterConditions[key].mandatory.values,u=e.filterConditions[key].equal,d=f;for(T&&console.log("Condizione: ",e.filterConditions[key]),i=0;i<e.filterConditions[key].values.length;i++)if(T&&console.log("valore i = ",i," valore valutato ",t," per chiave ",e.filterConditions[key].key),n(t[e.filterConditions[key].key],e.filterConditions[key].values[i],u)){if(f&&c)return T&&console.log("checkValues && checkCondition: true, esco "),!1;f&&(T&&console.log("checkValues: true, check = false "),d=!1)}else T&&console.log("val[key] == $scope.filterConditions[key].values[i]"),f||(T&&console.log("!checkValues, check = true"),d=!0);if(c&&!d)return!1;d&&(o=!0)}}return T&&console.log("Test entry: ",t,o),o}function K(){function t(t){for(var i=0;i<t.length;i++){var o=t[i];o.icon=o.icons[e.favCat]?o.icons[e.favCat]:o.icon,o.eTimeline&&(o.eTimeline.icon=o.icons[e.favCat]?o.icons[e.favCat]:o.icon),T&&console.log("Check update ",o.id,!e.markersFiltered[o.id]),e.markersFiltered[o.id]||(e.markersFiltered[o.id]=o,T&&console.log("Aggiungo ",o,e.markersFiltered[o.id]))}}function i(t){for(key in e.markersFiltered){var i=e.markersFiltered[key];T&&console.log("Check delete ",i.id,t.map(function(e){return e.id}).indexOf(i.id),t.map(function(e){return e.id}).indexOf(i.id)<0),t.map(function(e){return e.id}).indexOf(i.id)<0&&(T&&console.log("Rimuovo ",e.markersFiltered[key]),delete e.markersFiltered[key])}}function o(){for(var t in e.markersFiltered){var i=e.markersFiltered[t],o=e.config.types.parent_relations[i.entity_type];for(var n in o){var r=o[n];!r.exclude&&i[r.field]&&e.markersFiltered[i[r.field]]&&delete e.markersFiltered[t]}}}e.markersFilteredArray=angular.copy(e.filtred),e.query&&(e.markersFilteredArray=m("filter")(e.markersFilteredArray,e.query)),t(e.markersFilteredArray),i(e.markersFilteredArray),u.$emit("timeline.refresh",{list:angular.copy(e.markersFiltered)}),o()}function Y(){b.updateMarkersDistributed().then(function(t){T&&console.log("updateMarkersDistributed, markers: ",t),angular.extend(e.map.markers,t),K()},function(e){console.log("updateMarkersDistributed, error",e)}),q()}function J(){b.resetMarkersDistributed().then(function(t){T&&console.log("updateMarkersDistributed, markers: ",t),e.map.markers=angular.copy(t),K()},function(e){console.log("updateMarkersDistributed, error",e)}),q()}function Q(){e.markersFiltered={},e.markersFilteredArray=[],e.favCat=0,e.filters={},e.filterConditions=[];var t=e.config.types.list,i="key",o="entity_type",n=[],r={key:o,name:o,values:[],mandatory:{condition:!0,values:!1},equal:!1,excludeRule:!1,excludeProperty:!1,includeTypes:[]};e.filters[o]={list:t,toggle:1,iconSwitcher:!0,label:"TYPES",check:i,name:o,category_space:0,visible:!0};for(var a=0;a<e.filters[o].list.length;a++)e.filters[o].list[a].visible=!0,r.values.push(e.filters[o].list[a].key),r.includeTypes.push(e.filters[o].list[a].key),n.push(e.filters[o].list[a].key);e.filterConditions.push(r),T&&console.log("MapCtrl, init filtro entity_type: ",e.filters);for(var l=e.config.types.categories,a=0;a<l.length;a++){var s=l[a];if(s.is_visible){0==e.favCat&&s.is_visible&&(e.favCat=s.category_space);var o=s.name,i="id",r={key:"category_list",name:o,values:[],mandatory:{condition:!0,values:!1},equal:!1,excludeRule:!1,excludeProperty:!1,includeTypes:s.entities,includeCondition:{value:{category_space:s.category_space},property:"categories"}};for(e.filters[o]={list:s.categories,toggle:1,iconSwitcher:!0,label:o,check:i,name:o,category_space:s.category_space,visible:s.is_visible},j=0;j<e.filters[o].list.length;j++)e.filters[o].list[j].visible=!0,e.filters[o].list[j].key=e.filters[o].list[j].id,r.values.push(e.filters[o].list[j].id);e.filterConditions.push(r)}}if(e.config.map.area&&P.check&&P.list.length>1){var c="level",f="Levels",r={key:c,name:f,values:[],mandatory:{condition:!0,values:!1},equal:!1,excludeRule:!1,excludeProperty:!1,includeTypes:n,callbackPush:function(e){ut(e)},callbackPop:function(){}};e.filters[f]={list:P.list,toggle:1,iconSwitcher:!1,label:"Level",check:c,name:f,visible:!0};for(var a=0;a<e.filters[f].list.length;a++)e.filters[f].list[a].visible=!0,r.values.push(e.filters[f].list[a].key);e.filterConditions.push(r),T&&console.log("MapCtrl, init filtro level: ",e.filters[f],r)}}function it(){var i=[],o=m("orderBy")(e.config.types.list,"id");for(k in o){var n="",a=m("translate")(o[k].name);n=n.concat('<i class="icon ').concat(o[k].icon).concat('"></i>'),n=n.concat(" ").concat(a),T&&console.log("test ",a),T&&console.log("MapCtrl, creazione dell'action sheet, aggiungo bottone: ",n),i.push({text:n,type:o[k].slug,simple_editor:o[k].simple_editor})}var l=m("translate")("CREATION_TEXT");T&&console.log("test ",l);var s=r.show({titleText:l,buttons:i,cancelText:'<i class="icon ion-ios-arrow-down"></i>',cancel:function(){T&&console.log("CANCELLED")},buttonClicked:function(i,o){T&&console.log("BUTTON CLICKED",i,o),e.switchEditMode(),s(),b.getCenter().then(function(i){var n={lat:i.lat,lng:i.lng,id:null,entity_type:o.type};o.simple_editor?e.$broadcast("simpleInsert",n):(console.log("MapCtrl, clickToAdd, params ",e.map,n),t.go("app.editor",n))},function(e){console.log("MapCtrl, clickToAdd, MapService.getCenter, error ",e)})}});T&&console.log("actionSheet",s),u.actionSheet=s,u.actionStatus=!0}function ot(t){var i=rt(t);return i>-1?(delete e.map.markers[i],!0):!1}function nt(t){return 1>t?!1:void b.get(t).then(function(i){T&&console.log("MapCtrl, updateMarker, entityFactory.get, refresh marker ",t,i);var o=rt(i.id);o>-1?e.map.markers[o]=i:e.map.markers.push(i)},function(e){console.log("MapCtrl, updateMarker, entityFactory.get, errore ",e)})}function rt(t){var i=e.map.markers.map(function(e){return e.id}).indexOf(t);return i>-1?i:-1}function at(t){if(t===!1)for(var i in e.map.layers.overlays)console.log("spengo livello ",i),e.map.layers.overlays[i].visible=!1;else if(t===!0)for(var o in e.map.layers.overlays)e.map.layers.overlays[o].visible=!0;else if(0!==t||e.map.layers.overlays[0].visible)if(0===t&&e.map.layers.overlays[0].visible)for(var r in self.map.layers.overlays)e.map.layers.overlays[r].visible=!1;else e.map.layers.overlays[t].visible=e.map.layers.overlays[t].visible?!1:!0;else for(var n in self.map.layers.overlays)e.map.layers.overlays[n].visible=!0}function lt(t){switch(t){case"edit":e.editMode=!0;break;default:e.editMode=!1}b.changeMode(t),at(!e.editMode)}function st(t){var i=rt(t);if(i>-1){var o=e.map.markers[i];T&&console.log("Location: ",o);var n={lat:o.lat,lng:o.lng};G(n),T&&console.log("nuova posizione",self.map.center)}else T&&console.log("chiamo per :",t),b.get(t).then(function(t){T&&console.log("Location: ",t),T&&console.log("nuova posizione",e.map.center);var i={lat:t.lat,lng:t.lng};G(i)},function(e){T&&console.log("Location error: ",e)})}function ut(t){e.geojson&&e.geojson.data&&e.config.map.area&&e.config.map.area.data&&(e.geojson.data=m("filter")(e.config.map.area.data.features,dt("level",t)),e.$broadcast("timeline.groups.setgroup",{group:t}),e.$apply(function(){pt("level",t)}))}function dt(e,t){return function(i){return!i.properties[e]&&0!==i.properties[e]||i.properties[e]==t?!0:!1}}function pt(t,i){var o=e.config.design.colors[e.config.design.disabled_color];for(var n in e.markersFiltered)if(e.markersFiltered[n][t]!==i){var r=angular.copy(e.markersFiltered[n].icons[e.favCat]?e.markersFiltered[n].icons[e.favCat]:e.markersFiltered[n].icon),a='<div class="pin-marker" style="background-color:'+o+'"></div><div class="icon-box"><i class="icon '+r.icon+'"></i></div>';r.html=a,r.color=o,r.index=e.config.design.disabled_color,e.markersFiltered[n].icon=r}else e.markersFiltered[n].icon=e.markersFiltered[n].icons[e.favCat]?e.markersFiltered[n].icons[e.favCat]:e.markersFiltered[n].icons[0]}function mt(t){for(var o=z.map.filters,n=0;n<o.length;n++){var r=o[n].search_param,a=o[n],l=e.filterConditions.map(function(e){return e.name}).indexOf(a.key);if(!a.skip)if(t[r]){var s={key:a.property,name:a.key,values:[t[r]],mandatory:{condition:!0,values:!1},equal:!1,excludeRule:!1,excludeProperty:!1,includeTypes:z.types.list.map(function(e){return e.key})};l>-1?e.filterConditions[l]=s:e.filterConditions.push(s)}else{var l=e.filterConditions.map(function(e){return e.name}).indexOf(a.key);l>-1&&e.filterConditions.splice(l,1)}}}function gt(){if(E){var t=z.map.min_zoom_geometry_layer;y.getMap("mymap").then(function(i){var o=i.getBounds(),n=i.getZoom(),r={lat:o._southWest.lat,lng:o._southWest.lng},a={lat:o._northEast.lat,lng:o._northEast.lng};n>=t?S.get(n,r,a).then(function(t){e.geojson.data=t},function(e){v.error(e)}):e.geojson.data.features=[]},function(e){v.error("MapService, getMapBounds, errore: ",e)})}}function vt(t){if(t.embed)switch(v.debug("modalita embed",t.embed),t.embed){case"viewer":e.viewer=!0}else e.viewer=!1}function yt(t){t.lat&&t.lng&&t.zoom&&(e.map.center.lat!=t.lat||t.lng!=e.map.center.lng||t.zoom!=e.map.center.zoom)&&W(t)}function ht(t,i){t.entity?(T&&console.log("trovato parametro entity, devo aprire una modal: ",t.entity),R(t.entity),W(parseInt(t.entity))):i.entity&&e.$broadcast("markerClickClose")}function kt(t,i){if(!t)return!1;var o=t.q,n=i&&i.q?i.q:null;return o&&n&&o==n?!1:(o&&""!=o?(v.debug("modalita filtro per testo q = ",o),e.query=o,K()):""==o&&p.search("q",null),void(n&&""!=n&&!o&&(e.query=null,K())))}var T=!1,P={check:!1};_.map.area.levels&&(P={check:!0},P.list=e.config.map.area.levels),e.config||(e.config=_);var z=_,E=z.map.geometry_layer;e.isMobile||(e.isMobile=ionic.Platform.isIPad()||ionic.Platform.isIOS()||ionic.Platform.isAndroid()||ionic.Platform.isWindowsPhone()),e.locate||(e.locate=W),e.area||(e.area=M.getArea(),e.buildings=e.area.places,T&&console.log("Area e favPlaces: ",e.area)),"undefined"===e.isLoggedIn&&(e.isLoggedIn=!1),"undefined"===self.watchSearchEnabled&&(self.watchSearchEnabled=!0),(!e.map||angular.equals(e.map,{}))&&(e.map=map),e.categories||(e.categories=e.config.types.categories),e.events={map:{enable:["click","moveend","focus","drag"],logic:"broadcast"},marker:{enable:["click"],logic:"broadcast"}},e.options1=null,e.details1="",e.editMode=!1;{var $,O=z.behaviour.moveend_delay;z.behaviour.bbox_reload_time}e.markersFiltered||Q(),e.geojson={data:{type:"FeatureCollection",features:[]},style:I},e.config.map.area&&e.config.map.area.data&&(e.geojson.data=angular.copy(e.config.map.area.data),e.config.map.area.style&&(e.geojson.style=angular.copy(e.config.map.area.style)),e.geojson.levels=P.check?P.list:null);var D=null;D||y.getMap("mymap").then(function(e){return D=new L.TileLayer.Functional(function(e){v.debug("map view",e),u.$emit("grid-change",e)}),D.addTo(e),v.debug("init map",e),null},{reuseTiles:!1,updateWhenIdle:!0,unloadInvisibleTiles:!0}),e.$on("$stateChangeSuccess",function(){if(self.watchSearchEnabled=!1,vt(p.search()),kt(p.search()),v.log("sono in app.map e vengo da ",u.previousState,o),"app.maps"!==u.previousState){var t=w.get("user");switch(t?(T&&console.log("isLoggedIn? ",!0),e.isLoggedIn=!0):e.isLoggedIn=!1,e.map=b.getMap(),v.debug("MapCtrl, map all'ingresso di stato ",e.map),u.previousState){case"app.editor":T&&console.log("MapCtrl, cambio stato da intro: ",o),o.entity&&H(o.entity),o.entity&&o.entity>-1&&W(o);break;case"login":W(o),o.entity&&R(o.entity),o&&mt(o,{});break;default:T&&console.log("MapCtrl, gestione stato, default",o),o.entity&&R(o.entity),o&&mt(o,{})}}else T&&console.log("MapCtrl, gestione stato, ignorato perche' vengo da ",u.previousState)}),e.$on("leafletDirectiveMarker.mymap.click",function(t,i){v.log("MARKER CLICK...controlla, args: ",i,t),t.preventMapMarkerClick||(t.preventMapMarkerClick=!0,e.editMode||(i.model.focus=!1,R(i.model.id)))}),e.$on("leafletDirectiveMap.mymap.moveend",function(t){t.preventMapMoveend||(t.preventMapMoveend=!0,T&&console.log("Event: moveend...",e.map),e.config.map.area.data||gt(),e.editMode||(O>0?($&&(T&&console.log("clearTimeout"),clearTimeout($)),$=setTimeout(Y,O)):Y()))}),e.$on("openPlaceModal",function(e,t){e.preventOpenPlaceModal||(e.preventOpenPlaceModal=!0,B(t.marker))}),e.$on("closePlaceModal",function(e){e.preventClosePlaceModal||(e.preventClosePlaceModal=!0,N("entity"))}),e.$watch(function(){return p.search()},function(e,t){self.watchSearchEnabled&&(T&&console.log("check paramentro entity, old: ",t.entity," nuovo: ",e.entity," scelta ",!t.entity&&e.entity||t&&e.entity!=parseInt(t.entity)),yt(e),ht(e,t),mt(e,t),vt(e),kt(e,t)),self.watchSearchEnabled=!0},!0),e.filtred=[],e.$watch("map.markers",function(){e.map&&e.map.markers&&(T&&console.log("cambio dei Markers: ",e.map.markers,e.map.markers.length),e.filtred=m("filter")(e.map.markers,Z),T&&console.log("cambio dei Markers, nuovi markers filtrati: ",e.filtred,e.filtred.length))},!0),e.$watch("filterConditions",function(){e.map&&e.map.markers&&(e.filtred=m("filter")(e.map.markers,Z))},!0),e.$watch("filtred",function(e,t){angular.equals(e,t)||K()},!0),e.$watch("query",function(e,t){v.debug("change query ",e),angular.equals(e,t)||kt(e,t)},!0),e.$on("startEditing",function(t,i){e.updateEntity=i,v.debug("check start editing ",i),i.skip?e.showASEdit():(W(i),lt("edit"))}),e.$on("endEditing",function(e,t){H(t.marker.id),e.preventDefault()}),e.$on("deleteMarker",function(e,t){ot(t.id),e.preventDefault()}),u.$on("timeUpdate",function(e){J(),e.preventDefault()}),e.$on("clickMarker",function(e,t){R(t.id),W(t.id),e.preventDefault()}),e.$on("switchMapLevel",function(e,t){P.check&&ut(t.level),e.preventDefault()}),e.isString=function(e){return"string"==typeof e?!0:!1},e.greaterThan=function(e,t){return function(i){return i[e]>t}},e.differentThan=function(e,t){return function(i){return i[e]!=t}},e.switchEditMode=function(){e.config.dev&&T&&console.log("MapCtrl, switchEditMode editMode ",e.map.mode),e.editMode?(lt("view"),e.updateEntity=null):lt("edit")},e.showModalFavPlace=function(){e.filterFavPlace={},T&&console.log("check area: ",e.area),n.fromTemplateUrl("templates/form/filterFavPlace.html",{scope:e,animation:"fade-in",backdropClickToClose:!0,hardwareBackButtonClose:!0,focusFirstInput:!0}).then(function(t){e.filterFavPlace.modal=t,e.openFilterFavPlace(),u.modal=t,u.modalStatus=!0}),e.openFilterFavPlace=function(){e.filterFavPlace.modal.show()},e.closeFilterFavPlace=function(){e.filterFavPlace.modal.remove()},e.$on("modal.hidden",function(){delete e.filterFavPlace.modal}),e.$on("$destroy",function(){e.filterFavPlace.modal.remove()})},e.showMFilterCat=function(){e.filterCat={},n.fromTemplateUrl("templates/modals/filterCat.html",{scope:e,animation:"fade-in"}).then(function(t){e.filterCat.modal=t,e.openFilterCat(),u.modal=t,u.modalStatus=!0}),e.openFilterCat=function(){e.filterCat.modal.show()},e.closeFilterCat=function(){e.filterCat.modal.remove()},e.$on("modal.hidden",function(){delete e.filterCat.modal}),e.$on("$destroy",function(){e.filterCat.modal.remove()})},e.showASEdit=function(){if(e.updateEntity&&e.updateEntity.id){var i={lat:e.map.center.lat,lng:e.map.center.lng,id:e.updateEntity.id};t.go("app.editor",i),lt("view")}if(e.updateEntity){var i={};for(var o in e.updateEntity)i[o]=e.updateEntity[o];i.lat=e.map.center.lat,i.lng=e.map.center.lng,t.go("app.editor",i),lt("view")}else it()},e.toggleFilter=function(t,i){var o=e.filterConditions.map(function(e){return e.name}).indexOf(t);if(v.debug("Indice regola filtro: ",o,t,i),0>o&&(e.filterConditions[o]={},e.filterConditions[o].values=[null],e.filterConditions[o].mandatory={condition:!0,values:!1},e.filterConditions[o].equal=!1,e.filterConditions[o].excludeRule=!1,e.filterConditions[o].excludeProperty=!1,T&&console.log("Init della regola: ",e.filterConditions[o])),T&&console.log("Chiave? ",i),i||0===i){var n=e.filterConditions[o].values.indexOf(i);T&&console.log("Aggiungo/rimuovo chiave: ",i," a ",e.filterConditions[o].values," indice: ",n),T&&console.log("Intervengo qui: ",e.filters[t].list);var r=e.filters[t].list.map(function(e){return e.key}).indexOf(i);0>n?(e.filterConditions[o].values.push(i),e.filters[t].list[r].visible=!0,e.filterConditions[o].callbackPush&&e.filterConditions[o].callbackPush(i)):(e.filterConditions[o].values.splice(n,1),e.filters[t].list[r].visible=!1,e.filterConditions[o].callbackPop&&e.filterConditions[o].callbackPop(i)),e.filterConditions[o].excludeRule=!1,e.filterConditions[o].excludeRule=!1,e.filters[t].toggle=1,T&&console.log("Aggiunta o rimossa chiave: ",e.filterConditions[o].values," vado in stato 1")}else T&&console.log("Niente chiave, faccio toggle"),e.filterConditions[o].excludeRule||e.filterConditions[o].excludeProperty?e.filterConditions[o].excludeRule&&!e.filterConditions[o].excludeProperty?(T&&console.log("Stato 2 vado in 3"),e.filterConditions[o].excludeRule=!1,e.filterConditions[o].excludeProperty=!0,e.filters[t].toggle=3):!e.filterConditions[o].excludeRule&&e.filterConditions[o].excludeProperty&&(T&&console.log("Stato 3 vado in 1"),e.filterConditions[o].excludeRule=!1,e.filterConditions[o].excludeProperty=!1,e.filters[t].toggle=1):(T&&console.log("Stato 1 vado in 2"),e.filterConditions[o].excludeRule=!0,e.filterConditions[o].excludeProperty=!1,e.filters[t].toggle=2)},e.changeFavCat=function(t){s.show({animation:"fade-in",showBackdrop:!1,maxWidth:50,showDelay:0}),T&&console.log("cambio favCat da ",e.favCat," a ",t),e.favCat=t;for(i in e.markersFiltered)T&&console.log("cambio icona al marker ",e.markersFiltered[i]),e.markersFiltered[i].icon=e.markersFiltered[i].icons[e.favCat]?e.markersFiltered[i].icons[e.favCat]:e.markersFiltered[i].icon;s.hide(),e.closeFilterCat()},e.showWall=function(){T&&console.log("MapCtrl, showWall!"),T&&console.log("check area: ",e.area),n.fromTemplateUrl("templates/modals/wall.html",{scope:e,animation:"fade-in"}).then(function(t){e.wall=t,e.wall.show()}),e.closeWall=function(){e.wall.remove()},e.$on("modal.hidden",function(){delete e.wall}),e.$on("$destroy",function(){e.wall.remove()}),e.clickWallItem=function(t){e.closeWall(),R(t.id),W(t.id)}},e.query=null}]).run(function(e,t,i,o){self.map=e.initMap();var n=config.behaviour.bbox_reload_time,r=!1,a=function(){i.cancel(r),o.$broadcast("leafletDirectiveMap.mymap.moveend"),r=i(function(){console.log("polling!"),a()},n)};a()});