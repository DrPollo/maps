angular.module("firstlife.controllers").controller("MapCtrl",["$scope","$state","$stateParams","$ionicModal","$ionicActionSheet","$ionicPopup","$cordovaGeolocation","$ionicLoading","$q","$ionicPopover","$rootScope","$window","$location","$filter","$timeout","$log","leafletData","leafletMapEvents","entityFactory","MapService","myConfig","PlatformService","MemoryFactory","AreaService","leafletMarkersHelpers","indexingFactory",function(e,t,o,n,a,r,l,s,c,f,u,d,p,m,g,v,y,h,C,b,_,x,w,M,F,S){function I(i){var t=i.properties,n=(e.markersFilteredArray.length,{fillColor:"rgb(221,91,42)",weight:3,opacity:.5,color:"#6C93B3",dashArray:"1",fillOpacity:.5});return t.entities.length>0&&(n.fillColor="rgb(136, 186, 92)",n.color="rgb(136, 186, 92)"),t.entities.length>20&&(n.fillColor="rgb(255,179,16)",n.color="rgb(255,179,16)"),t.entities.length>40&&(n.fillColor="rgb(221,91,42)",n.color="rgb(221,91,42)"),n}function D(i){T&&console.log("markerClick! ",i),e.$broadcast("markerClick",{markerId:parseInt(i)})}function R(){var e=p.search();b.getCenter().then(function(i){T&&console.log("centro della mappa, ",i),(e.lat!=i.lat||e.lng!=i.lng||e.zoom!=i.zoom)&&B(i)},function(e){T&&console.log("updatePositionInSearch, MapService.getCenter, errore: ",e)})}function q(e){b.getCenter().then(function(i){i.entity=e,B(i)},function(e){T&&console.log("updatePlaceInSearch, MapService.getCenter, errore: ",e)})}function B(e){for(key in e)self.watchSearchEnabled=!1,p.search(key,e[key]);T&&console.log("nuovi parametri search: ",p.search(),e)}function U(e){self.watchSearchEnabled=!1,p.search(e,null),self.watchSearchEnabled=!0}function N(i){if(T&&console.log("centro su luogo, id: "+typeof i+" ",i),"object"==typeof i&&"entity"in i&&i.entity)li(i.entity);else if("number"==typeof i)li(i);else if("object"==typeof i&&"bound"in i)T&&console.log("centro su bounds: ",i),W(i);else if("object"==typeof i&&"lat"in i&&"lng"in i&&i.lat&&i.lng){T&&console.log("centro su coordinate: ",i);var t={lat:parseFloat(i.lat),lng:parseFloat(i.lng),zoom:parseInt(i.zoom?i.zoom:E.map.zoom_create)};T&&console.log("centro su coordinate: ",t),W(t)}else if("user"===i)s.show({content:'<div>Localizzazione in corso...<br> Assicurati di aver abilitato il gps o il browser!<i class="icon ion-loading-c"></i></div>',animation:"fade-in",showBackdrop:!1,maxWidth:50,showDelay:0}),l.getCurrentPosition().then(function(t){T&&console.log(i),e.markersFiltered[0]={lat:t.coords.latitude,lng:t.coords.longitude,focus:!0,draggable:!1};var o={lat:t.coords.latitude,lng:t.coords.longitude,zoom:parseInt(E.map.zoom_create)};W(o),s.hide()},function(e){T&&console.log("Location error: ",e),s.hide()});else{var t={lat:parseFloat(e.config.map.map_default_lat),lng:parseFloat(e.config.map.map_default_lng),zoom:parseInt(e.config.map.zoom_level)};W(t)}}function W(e){y.getMap("mymap").then(function(i){if(T&&console.log("MapService, setMapCenter, response: ",i," params ",e),e.bound)i.fitBounds(e.bound);else if(e.zoom){var t=new L.LatLng(e.lat,e.lng);i.setView(t,e.zoom)}else{var t=new L.LatLng(e.lat,e.lng);i.panTo(t)}var o=i.getCenter(),n=i.getZoom(),a={lat:o.lat,lng:o.lng,zoom:n};T&&console.log("Nuovo centro della mappa",a)},function(e){T&&console.log("MapService, setMapCenter, errore: ",e)})}function Z(e){v.debug("MapCtrl, backFromEditor, entityId: ",e);var i={};if(-1==e){i.title=m("translate")("ERROR"),i.text=m("translate")("UNKNOWN_ERROR");var t=a.show({titleText:i.text,cancelText:'<i class="icon ion-ios-arrow-down"></i>',cancel:function(){T&&console.log("CANCELLED")}});T&&console.log("actionSheet",t),u.actionSheet=t,u.actionStatus=!0}if(-2==e){i.title=m("translate")("SUCCESS"),i.text=m("translate")("SUCCESS_MODARATION");var t=a.show({titleText:i.text,cancelText:'<i class="icon ion-ios-arrow-down"></i>',cancel:function(){T&&console.log("CANCELLED")}});T&&console.log("actionSheet",t),u.actionSheet=t,u.actionStatus=!0}else if(e>0){i.title=m("translate")("SUCCESS"),i.text=m("translate")("SAVE_SUCCESS"),oi(e),D(e);var t=a.show({titleText:i.text,cancelText:'<i class="icon ion-ios-arrow-down"></i>',cancel:function(){T&&console.log("CANCELLED")}});T&&console.log("actionSheet",t),u.actionSheet=t,u.actionStatus=!0}else T&&console.log("creazione/modifica ok!")}function G(t){var o=!1,n=function(e,i,t){return T&&console.log("markerFilter, comparison, a, b, equal ",e,i,t),Array.isArray(e)?t?(T&&console.log(e,"==",i,"? ",e==i),e.indexOf(i)>=0):e.indexOf(i)<0:t?(T&&console.log(e,"==",i,"? ",e==i),e==i):(T&&console.log(e,"!=",i,"? ",e!=i),e!=i)};T&&console.log("entry: ",t," Condizioni: ",e.filterConditions);for(key in e.filterConditions){T&&console.log("il tipo e' da includere? ",e.filterConditions[key].includeTypes.indexOf(t.entity_type)>-1);var a=0;if(e.filterConditions[key].includeCondition){var r=t[e.filterConditions[key].includeCondition.property],l=Object.keys(e.filterConditions[key].includeCondition.value)[0];a=r.map(function(e){return e[l].id}).indexOf(e.filterConditions[key].includeCondition.value[l]),T&&console.log("check per includeCondition ",a>-1)}if(T&&console.log("il tipo e' da includere? ",e.filterConditions[key].includeTypes.indexOf(t.entity_type)>-1),!e.filterConditions[key].excludeRule&&e.filterConditions[key].includeTypes.indexOf(t.entity_type)>-1&&a>-1){if(e.filterConditions[key].excludeProperty){var s=t[e.filterConditions[key].key];if(T&&console.log("Check esclusione regola: ",e.filterConditions[key].excludeProperty,t,e.filterConditions[key].key,s),!(!s||null===s||"undefined"===s||Array.isArray(s)&&0==s.length||angular.isObject(s)&&angular.equals(s,{})))return!1;console.log("property non impostata per: ",t,"prorpieta'",e.filterConditions[key].key)}var c=e.filterConditions[key].mandatory.condition,f=e.filterConditions[key].mandatory.values,u=e.filterConditions[key].equal,d=f;for(T&&console.log("Condizione: ",e.filterConditions[key]),i=0;i<e.filterConditions[key].values.length;i++)if(T&&console.log("valore i = ",i," valore valutato ",t," per chiave ",e.filterConditions[key].key),n(t[e.filterConditions[key].key],e.filterConditions[key].values[i],u)){if(f&&c)return T&&console.log("checkValues && checkCondition: true, esco "),!1;f&&(T&&console.log("checkValues: true, check = false "),d=!1)}else T&&console.log("val[key] == $scope.filterConditions[key].values[i]"),f||(T&&console.log("!checkValues, check = true"),d=!0);if(c&&!d)return!1;d&&(o=!0)}}return T&&console.log("Test entry: ",t,o),o}function K(){function i(i){for(var t=0;t<i.length;t++){var o=i[t];o.icon=o.icons[e.favCat]?o.icons[e.favCat]:o.icon,o.eTimeline&&(o.eTimeline.icon=o.icons[e.favCat]?o.icons[e.favCat]:o.icon),T&&console.log("Check update ",o.id,!e.markersFiltered[o.id]),e.markersFiltered[o.id]||(e.markersFiltered[o.id]=o,T&&console.log("Aggiungo ",o,e.markersFiltered[o.id]))}}function t(i){for(key in e.markersFiltered){var t=e.markersFiltered[key];T&&console.log("Check delete ",t.id,i.map(function(e){return e.id}).indexOf(t.id),i.map(function(e){return e.id}).indexOf(t.id)<0),i.map(function(e){return e.id}).indexOf(t.id)<0&&(T&&console.log("Rimuovo ",e.markersFiltered[key]),delete e.markersFiltered[key])}}function o(){for(var i in e.markersFiltered){var t=e.markersFiltered[i],o=e.config.types.parent_relations[t.entity_type];for(var n in o){var a=o[n];!a.exclude&&t[a.field]&&e.markersFiltered[t[a.field]]&&delete e.markersFiltered[i]}}}e.markersFilteredArray=angular.copy(e.filtred),e.query&&(e.markersFilteredArray=m("filter")(e.markersFilteredArray,e.query)),i(e.markersFilteredArray),t(e.markersFilteredArray),u.$emit("timeline.refresh",{list:angular.copy(e.markersFiltered)}),o()}function X(){b.updateMarkersDistributed().then(function(i){T&&console.log("updateMarkersDistributed, markers: ",i),angular.extend(e.map.markers,i),K()},function(e){console.log("updateMarkersDistributed, error",e)}),R()}function Y(){b.resetMarkersDistributed().then(function(i){T&&console.log("updateMarkersDistributed, markers: ",i),e.map.markers=angular.copy(i),K()},function(e){console.log("updateMarkersDistributed, error",e)}),R()}function J(){e.markersFiltered={},e.markersFilteredArray=[],e.favCat=0,e.filters={},e.filterConditions=[];var i=e.config.types.list,t="key",o="entity_type",n=[],a={key:o,name:o,values:[],mandatory:{condition:!0,values:!1},equal:!1,excludeRule:!1,excludeProperty:!1,includeTypes:[]};e.filters[o]={list:i,toggle:1,iconSwitcher:!0,label:"TYPES",check:t,name:o,category_space:0,visible:!0};for(var r=0;r<e.filters[o].list.length;r++)e.filters[o].list[r].visible=!0,a.values.push(e.filters[o].list[r].key),a.includeTypes.push(e.filters[o].list[r].key),n.push(e.filters[o].list[r].key);e.filterConditions.push(a),T&&console.log("MapCtrl, init filtro entity_type: ",e.filters);for(var l=e.config.types.categories,r=0;r<l.length;r++){var s=l[r];if(s.is_visible){0==e.favCat&&s.is_visible&&(e.favCat=s.category_space);var o=s.name,t="id",a={key:"category_list",name:o,values:[],mandatory:{condition:!0,values:!1},equal:!1,excludeRule:!1,excludeProperty:!1,includeTypes:s.entities,includeCondition:{value:{category_space:s.category_space},property:"categories"}};for(e.filters[o]={list:s.categories,toggle:1,iconSwitcher:!0,label:o,check:t,name:o,category_space:s.category_space,visible:s.is_visible},j=0;j<e.filters[o].list.length;j++)e.filters[o].list[j].visible=!0,e.filters[o].list[j].key=e.filters[o].list[j].id,a.values.push(e.filters[o].list[j].id);e.filterConditions.push(a)}}if(e.config.map.area&&P.check&&P.list.length>1){var c="level",f="Levels",a={key:c,name:f,values:[],mandatory:{condition:!0,values:!1},equal:!1,excludeRule:!1,excludeProperty:!1,includeTypes:n,callbackPush:function(e){fi(e)},callbackPop:function(){}};e.filters[f]={list:P.list,toggle:1,iconSwitcher:!1,label:"Level",check:c,name:f,visible:!0};for(var r=0;r<e.filters[f].list.length;r++)e.filters[f].list[r].visible=!0,a.values.push(e.filters[f].list[r].key);e.filterConditions.push(a),T&&console.log("MapCtrl, init filtro level: ",e.filters[f],a)}}function ii(){var i=[],o=m("orderBy")(e.config.types.list,"id");for(k in o){var n="",r=m("translate")(o[k].name);n=n.concat('<i class="icon ').concat(o[k].icon).concat('"></i>'),n=n.concat(" ").concat(r),T&&console.log("test ",r),T&&console.log("MapCtrl, creazione dell'action sheet, aggiungo bottone: ",n),i.push({text:n,type:o[k].slug,simple_editor:o[k].simple_editor})}var l=m("translate")("CREATION_TEXT");T&&console.log("test ",l);var s=a.show({titleText:l,buttons:i,cancelText:'<i class="icon ion-ios-arrow-down"></i>',cancel:function(){T&&console.log("CANCELLED")},buttonClicked:function(i,o){T&&console.log("BUTTON CLICKED",i,o),e.switchEditMode(),s(),b.getCenter().then(function(i){var n={lat:i.lat,lng:i.lng,id:null,entity_type:o.type};o.simple_editor?e.$broadcast("simpleInsert",n):(console.log("MapCtrl, clickToAdd, params ",e.map,n),t.go("app.editor",n))},function(e){console.log("MapCtrl, clickToAdd, MapService.getCenter, error ",e)})}});T&&console.log("actionSheet",s),u.actionSheet=s,u.actionStatus=!0}function ti(i){var t=ni(i);return t>-1?(delete e.map.markers[t],!0):!1}function oi(i){return 1>i?!1:void b.get(i).then(function(t){T&&console.log("MapCtrl, updateMarker, entityFactory.get, refresh marker ",i,t);var o=ni(t.id);o>-1?e.map.markers[o]=t:e.map.markers.push(t)},function(e){console.log("MapCtrl, updateMarker, entityFactory.get, errore ",e)})}function ni(i){var t=e.map.markers.map(function(e){return e.id}).indexOf(i);return t>-1?t:-1}function ai(i){if(i===!1)for(var t in e.map.layers.overlays)console.log("spengo livello ",t),e.map.layers.overlays[t].visible=!1;else if(i===!0)for(var o in e.map.layers.overlays)e.map.layers.overlays[o].visible=!0;else if(0!==i||e.map.layers.overlays[0].visible)if(0===i&&e.map.layers.overlays[0].visible)for(var a in self.map.layers.overlays)e.map.layers.overlays[a].visible=!1;else e.map.layers.overlays[i].visible=e.map.layers.overlays[i].visible?!1:!0;else for(var n in self.map.layers.overlays)e.map.layers.overlays[n].visible=!0}function ri(i){switch(i){case"edit":e.editMode=!0;break;default:e.editMode=!1}b.changeMode(i),ai(!e.editMode)}function li(i){var t=ni(i);if(t>-1){var o=e.map.markers[t];T&&console.log("Location: ",o);var n={lat:o.lat,lng:o.lng};W(n),T&&console.log("nuova posizione",self.map.center)}else T&&console.log("chiamo per :",i),b.get(i).then(function(i){T&&console.log("Location: ",i),T&&console.log("nuova posizione",e.map.center);var t={lat:i.lat,lng:i.lng};W(t)},function(e){T&&console.log("Location error: ",e)})}function fi(i){e.geojson&&e.geojson.data&&e.config.map.area&&e.config.map.area.data&&(e.geojson.data=m("filter")(e.config.map.area.data.features,ui("level",i)),e.$broadcast("timeline.groups.setgroup",{group:i}),e.$apply(function(){di("level",i)}))}function ui(e,i){return function(t){return!t.properties[e]&&0!==t.properties[e]||t.properties[e]==i?!0:!1}}function di(i,t){var o=e.config.design.colors[e.config.design.disabled_color];for(var n in e.markersFiltered)if(e.markersFiltered[n][i]!==t){var a=angular.copy(e.markersFiltered[n].icons[e.favCat]?e.markersFiltered[n].icons[e.favCat]:e.markersFiltered[n].icon),r='<div class="pin-marker" style="background-color:'+o+'"></div><div class="icon-box"><i class="icon '+a.icon+'"></i></div>';a.html=r,a.color=o,a.index=e.config.design.disabled_color,e.markersFiltered[n].icon=a}else e.markersFiltered[n].icon=e.markersFiltered[n].icons[e.favCat]?e.markersFiltered[n].icons[e.favCat]:e.markersFiltered[n].icons[0]}function pi(i){for(var o=E.map.filters,n=0;n<o.length;n++){var a=o[n].search_param,r=o[n],l=e.filterConditions.map(function(e){return e.name}).indexOf(r.key);if(!r.skip)if(i[a]){var s={key:r.property,name:r.key,values:[i[a]],mandatory:{condition:!0,values:!1},equal:!1,excludeRule:!1,excludeProperty:!1,includeTypes:E.types.list.map(function(e){return e.key})};l>-1?e.filterConditions[l]=s:e.filterConditions.push(s)}else{var l=e.filterConditions.map(function(e){return e.name}).indexOf(r.key);l>-1&&e.filterConditions.splice(l,1)}}}function mi(){if($){var i=E.map.min_zoom_geometry_layer;y.getMap("mymap").then(function(t){var o=t.getBounds(),n=t.getZoom(),a={lat:o._southWest.lat,lng:o._southWest.lng},r={lat:o._northEast.lat,lng:o._northEast.lng};n>=i?S.get(n,a,r).then(function(i){e.geojson.data=i},function(e){v.error(e)}):e.geojson.data.features=[]},function(e){v.error("MapService, getMapBounds, errore: ",e)})}}function gi(i){if(i.embed)switch(v.debug("modalita embed",i.embed),i.embed){case"viewer":e.viewer=!0}else e.viewer=!1}function vi(i){i.lat&&i.lng&&i.zoom&&(e.map.center.lat!=i.lat||i.lng!=e.map.center.lng||i.zoom!=e.map.center.zoom)&&N(i)}function yi(i,t){i.entity?(T&&console.log("trovato parametro entity, devo aprire una modal: ",i.entity),D(i.entity),N(parseInt(i.entity))):t.entity&&e.$broadcast("markerClickClose")}function hi(i,t){if(!i)return!1;var o=i.q,n=t&&t.q?t.q:null;return o&&n&&o==n?!1:(o&&""!=o?(v.debug("modalita filtro per testo q = ",o),e.query=o,K()):""==o&&p.search("q",null),void(n&&""!=n&&!o&&(e.query=null,K())))}var T=!1,P={check:!1};_.map.area.levels&&(P={check:!0},P.list=e.config.map.area.levels),e.config||(e.config=_);var E=_,$=E.map.geometry_layer;e.isMobile||(e.isMobile=ionic.Platform.isIPad()||ionic.Platform.isIOS()||ionic.Platform.isAndroid()||ionic.Platform.isWindowsPhone()),e.locate||(e.locate=N),e.area||(e.area=M.getArea(),e.buildings=e.area.places,T&&console.log("Area e favPlaces: ",e.area)),"undefined"===e.isLoggedIn&&(e.isLoggedIn=!1),"undefined"===self.watchSearchEnabled&&(self.watchSearchEnabled=!0),(!e.map||angular.equals(e.map,{}))&&(e.map=map),e.categories||(e.categories=e.config.types.categories),e.events={map:{enable:["click","moveend","focus","drag"],logic:"broadcast"},marker:{enable:["click"],logic:"broadcast"}},e.options1=null,e.details1="",e.editMode=!1;{var z,O=E.behaviour.moveend_delay;E.behaviour.bbox_reload_time}e.markersFiltered||J(),e.geojson={data:{type:"FeatureCollection",features:[]},style:I},e.config.map.area&&e.config.map.area.data&&(e.geojson.data=angular.copy(e.config.map.area.data),e.config.map.area.style&&(e.geojson.style=angular.copy(e.config.map.area.style)),e.geojson.levels=P.check?P.list:null),e.$on("$stateChangeSuccess",function(){if(self.watchSearchEnabled=!1,gi(p.search()),hi(p.search()),v.log("sono in app.map e vengo da ",u.previousState,o),"app.maps"!==u.previousState){var i=w.get("user");switch(i?(T&&console.log("isLoggedIn? ",!0),e.isLoggedIn=!0):e.isLoggedIn=!1,e.map=b.getMap(),v.debug("MapCtrl, map all'ingresso di stato ",e.map),u.previousState){case"app.editor":T&&console.log("MapCtrl, cambio stato da intro: ",o),o.entity&&Z(o.entity),o.entity&&o.entity>-1&&N(o);break;case"login":N(o),o.entity&&D(o.entity),o&&pi(o,{});break;default:T&&console.log("MapCtrl, gestione stato, default",o),o.entity&&D(o.entity),o&&pi(o,{})}}else T&&console.log("MapCtrl, gestione stato, ignorato perche' vengo da ",u.previousState)}),e.$on("leafletDirectiveMarker.mymap.click",function(i,t){v.log("MARKER CLICK...controlla, args: ",t,i),i.preventMapMarkerClick||(i.preventMapMarkerClick=!0,e.editMode||(t.model.focus=!1,D(t.model.id)))}),e.$on("leafletDirectiveMap.mymap.moveend",function(i){i.preventMapMoveend||(i.preventMapMoveend=!0,T&&console.log("Event: moveend...",e.map),e.config.map.area.data||mi(),e.editMode||(O>0?(z&&(T&&console.log("clearTimeout"),clearTimeout(z)),z=setTimeout(X,O)):X()))}),e.$on("openPlaceModal",function(e,i){e.preventOpenPlaceModal||(e.preventOpenPlaceModal=!0,q(i.marker))}),e.$on("closePlaceModal",function(e){e.preventClosePlaceModal||(e.preventClosePlaceModal=!0,U("entity"))}),e.$watch(function(){return p.search()},function(e,i){self.watchSearchEnabled&&(T&&console.log("check paramentro entity, old: ",i.entity," nuovo: ",e.entity," scelta ",!i.entity&&e.entity||i&&e.entity!=parseInt(i.entity)),vi(e),yi(e,i),pi(e,i),gi(e),hi(e,i)),self.watchSearchEnabled=!0},!0),e.filtred=[],e.$watch("map.markers",function(){e.map&&e.map.markers&&(T&&console.log("cambio dei Markers: ",e.map.markers,e.map.markers.length),e.filtred=m("filter")(e.map.markers,G),T&&console.log("cambio dei Markers, nuovi markers filtrati: ",e.filtred,e.filtred.length))},!0),e.$watch("filterConditions",function(){e.map&&e.map.markers&&(e.filtred=m("filter")(e.map.markers,G))},!0),e.$watch("filtred",function(e,i){angular.equals(e,i)||K()},!0),e.$watch("query",function(e,i){v.debug("change query ",e),angular.equals(e,i)||hi(e,i)},!0),e.$on("startEditing",function(i,t){e.updateEntity=t,v.debug("check start editing ",t),t.skip?e.showASEdit():(N(t),ri("edit"))}),e.$on("endEditing",function(e,i){Z(i.marker.id),e.preventDefault()}),e.$on("deleteMarker",function(e,i){ti(i.id),e.preventDefault()}),u.$on("timeUpdate",function(e){Y(),e.preventDefault()}),e.$on("clickMarker",function(e,i){D(i.id),N(i.id),e.preventDefault()}),e.$on("switchMapLevel",function(e,i){P.check&&fi(i.level),e.preventDefault()}),e.isString=function(e){return"string"==typeof e?!0:!1},e.greaterThan=function(e,i){return function(t){return t[e]>i}},e.differentThan=function(e,i){return function(t){return t[e]!=i}},e.switchEditMode=function(){e.config.dev&&T&&console.log("MapCtrl, switchEditMode editMode ",e.map.mode),e.editMode?(ri("view"),e.updateEntity=null):ri("edit")},e.showModalFavPlace=function(){e.filterFavPlace={},T&&console.log("check area: ",e.area),n.fromTemplateUrl("templates/form/filterFavPlace.html",{scope:e,animation:"fade-in",backdropClickToClose:!0,hardwareBackButtonClose:!0,focusFirstInput:!0}).then(function(i){e.filterFavPlace.modal=i,e.openFilterFavPlace(),u.modal=i,u.modalStatus=!0}),e.openFilterFavPlace=function(){e.filterFavPlace.modal.show()},e.closeFilterFavPlace=function(){e.filterFavPlace.modal.remove()},e.$on("modal.hidden",function(){delete e.filterFavPlace.modal}),e.$on("$destroy",function(){e.filterFavPlace.modal.remove()})},e.showMFilterCat=function(){e.filterCat={},n.fromTemplateUrl("templates/modals/filterCat.html",{scope:e,animation:"fade-in"}).then(function(i){e.filterCat.modal=i,e.openFilterCat(),u.modal=i,u.modalStatus=!0}),e.openFilterCat=function(){e.filterCat.modal.show()},e.closeFilterCat=function(){e.filterCat.modal.remove()},e.$on("modal.hidden",function(){delete e.filterCat.modal}),e.$on("$destroy",function(){e.filterCat.modal.remove()})},e.showASEdit=function(){if(e.updateEntity&&e.updateEntity.id){var i={lat:e.map.center.lat,lng:e.map.center.lng,id:e.updateEntity.id};t.go("app.editor",i),ri("view")}if(e.updateEntity){var i={};for(var o in e.updateEntity)i[o]=e.updateEntity[o];i.lat=e.map.center.lat,i.lng=e.map.center.lng,t.go("app.editor",i),ri("view")}else ii()},e.toggleFilter=function(i,t){var o=e.filterConditions.map(function(e){return e.name}).indexOf(i);if(v.debug("Indice regola filtro: ",o,i,t),0>o&&(e.filterConditions[o]={},e.filterConditions[o].values=[null],e.filterConditions[o].mandatory={condition:!0,values:!1},e.filterConditions[o].equal=!1,e.filterConditions[o].excludeRule=!1,e.filterConditions[o].excludeProperty=!1,T&&console.log("Init della regola: ",e.filterConditions[o])),T&&console.log("Chiave? ",t),t||0===t){var n=e.filterConditions[o].values.indexOf(t);T&&console.log("Aggiungo/rimuovo chiave: ",t," a ",e.filterConditions[o].values," indice: ",n),T&&console.log("Intervengo qui: ",e.filters[i].list);var a=e.filters[i].list.map(function(e){return e.key}).indexOf(t);0>n?(e.filterConditions[o].values.push(t),e.filters[i].list[a].visible=!0,e.filterConditions[o].callbackPush&&e.filterConditions[o].callbackPush(t)):(e.filterConditions[o].values.splice(n,1),e.filters[i].list[a].visible=!1,e.filterConditions[o].callbackPop&&e.filterConditions[o].callbackPop(t)),e.filterConditions[o].excludeRule=!1,e.filterConditions[o].excludeRule=!1,e.filters[i].toggle=1,T&&console.log("Aggiunta o rimossa chiave: ",e.filterConditions[o].values," vado in stato 1")}else T&&console.log("Niente chiave, faccio toggle"),e.filterConditions[o].excludeRule||e.filterConditions[o].excludeProperty?e.filterConditions[o].excludeRule&&!e.filterConditions[o].excludeProperty?(T&&console.log("Stato 2 vado in 3"),e.filterConditions[o].excludeRule=!1,e.filterConditions[o].excludeProperty=!0,e.filters[i].toggle=3):!e.filterConditions[o].excludeRule&&e.filterConditions[o].excludeProperty&&(T&&console.log("Stato 3 vado in 1"),e.filterConditions[o].excludeRule=!1,e.filterConditions[o].excludeProperty=!1,e.filters[i].toggle=1):(T&&console.log("Stato 1 vado in 2"),e.filterConditions[o].excludeRule=!0,e.filterConditions[o].excludeProperty=!1,e.filters[i].toggle=2)},e.changeFavCat=function(t){s.show({animation:"fade-in",showBackdrop:!1,maxWidth:50,showDelay:0}),T&&console.log("cambio favCat da ",e.favCat," a ",t),e.favCat=t;for(i in e.markersFiltered)T&&console.log("cambio icona al marker ",e.markersFiltered[i]),e.markersFiltered[i].icon=e.markersFiltered[i].icons[e.favCat]?e.markersFiltered[i].icons[e.favCat]:e.markersFiltered[i].icon;s.hide(),e.closeFilterCat()},e.showWall=function(){T&&console.log("MapCtrl, showWall!"),T&&console.log("check area: ",e.area),n.fromTemplateUrl("templates/modals/wall.html",{scope:e,animation:"fade-in"}).then(function(i){e.wall=i,e.wall.show()}),e.closeWall=function(){e.wall.remove()},e.$on("modal.hidden",function(){delete e.wall}),e.$on("$destroy",function(){e.wall.remove()}),e.clickWallItem=function(i){e.closeWall(),D(i.id),N(i.id)}},e.query=null}]).run(function(e,i,t,o){self.map=e.initMap();var n=config.behaviour.bbox_reload_time,a=!1,r=function(){t.cancel(a),o.$broadcast("leafletDirectiveMap.mymap.moveend"),a=t(function(){console.log("polling!"),r()},n)};r()});