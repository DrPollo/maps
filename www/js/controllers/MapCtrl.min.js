angular.module("firstlife.controllers").controller("MapCtrl",["$scope","$state","$stateParams","$ionicModal","$ionicActionSheet","$ionicPopup","$cordovaGeolocation","$ionicLoading","$q","$ionicPopover","$rootScope","$window","$location","$filter","$timeout","$log","leafletData","leafletMapEvents","entityFactory","MapService","myConfig","PlatformService","MemoryFactory","AreaService","leafletMarkersHelpers","indexingFactory",function(e,t,o,r,a,n,l,s,c,d,f,u,g,p,m,v,y,E,h,_,C,S,T,A,O,I){function D(t){var o=t.properties,i=e.markersFilteredArray.length,r={fillColor:"#6C93B3",weight:2,opacity:.5,color:"#6C93B3",dashArray:"1",fillOpacity:.05};return o.entities.length>0&&(r.fillColor="rgb(136, 186, 92)",r.color="rgb(136, 186, 92)",r.fillOpacity=o.entities.length/20),o.entities.length>20&&(r.fillColor="rgb(255,179,16)",r.color="rgb(255,179,16)",r.fillOpacity=o.entities.length/60),o.entities.length>40&&(r.fillColor="rgb(221,91,42)",r.color="rgb(221,91,42)",r.fillOpacity=o.entities.length/(3*i)),r}function z(t){P&&console.log("markerClick! ",t),e.$broadcast("markerClick",{markerId:parseInt(t)})}function U(){var e=g.search();_.getCenter().then(function(t){P&&console.log("centro della mappa, ",t),(e.lat!=t.lat||e.lng!=t.lng||e.zoom!=t.zoom)&&x(t)},function(e){P&&console.log("updatePositionInSearch, MapService.getCenter, errore: ",e)})}function $(e){_.getCenter().then(function(t){t.entity=e,x(t)},function(e){P&&console.log("updatePlaceInSearch, MapService.getCenter, errore: ",e)})}function x(e){for(key in e)self.watchSearchEnabled=!1,g.search(key,e[key]);P&&console.log("nuovi parametri search: ",g.search(),e)}function G(e){self.watchSearchEnabled=!1,g.search(e,null),self.watchSearchEnabled=!0}function B(t){if(P&&console.log("centro su luogo, id: "+typeof t+" ",t),"object"==typeof t&&"entity"in t&&t.entity)lt(t.entity);else if("number"==typeof t)lt(t);else if("object"==typeof t&&"bound"in t)P&&console.log("centro su bounds: ",t),H(t);else if("object"==typeof t&&"lat"in t&&"lng"in t&&t.lat&&t.lng){P&&console.log("centro su coordinate: ",t);var o={lat:parseFloat(t.lat),lng:parseFloat(t.lng),zoom:parseInt(t.zoom?t.zoom:M.map.zoom_create)};P&&console.log("centro su coordinate: ",o),H(o)}else if("user"===t)s.show({content:'<div>Localizzazione in corso...<br> Assicurati di aver abilitato il gps o il browser!<i class="icon ion-loading-c"></i></div>',animation:"fade-in",showBackdrop:!1,maxWidth:50,showDelay:0}),l.getCurrentPosition().then(function(o){P&&console.log(t),e.markersFiltered[0]={lat:o.coords.latitude,lng:o.coords.longitude,focus:!0,draggable:!1};var i={lat:o.coords.latitude,lng:o.coords.longitude,zoom:parseInt(M.map.zoom_create)};H(i),s.hide()},function(e){P&&console.log("Location error: ",e),s.hide()});else{var o={lat:parseFloat(e.config.map.map_default_lat),lng:parseFloat(e.config.map.map_default_lng),zoom:parseInt(e.config.map.zoom_level)};H(o)}}function H(e){y.getMap("mymap").then(function(t){if(P&&console.log("MapService, setMapCenter, response: ",t," params ",e),e.bound)t.fitBounds(e.bound);else if(e.zoom){var o=new L.LatLng(e.lat,e.lng);t.setView(o,e.zoom)}else{var o=new L.LatLng(e.lat,e.lng);t.panTo(o)}var i=t.getCenter(),r=t.getZoom(),a={lat:i.lat,lng:i.lng,zoom:r};P&&console.log("Nuovo centro della mappa",a)},function(e){P&&console.log("MapService, setMapCenter, errore: ",e)})}function V(e){v.debug("MapCtrl, backFromEditor, entityId: ",e);var t={};if(-1==e){t.title=p("translate")("ERROR"),t.text=p("translate")("UNKNOWN_ERROR");var o=a.show({titleText:t.text,cancelText:'<i class="icon ion-ios-arrow-down"></i>',cancel:function(){P&&console.log("CANCELLED")}});P&&console.log("actionSheet",o),f.actionSheet=o,f.actionStatus=!0}if(-2==e){t.title=p("translate")("SUCCESS"),t.text=p("translate")("SUCCESS_MODARATION");var o=a.show({titleText:t.text,cancelText:'<i class="icon ion-ios-arrow-down"></i>',cancel:function(){P&&console.log("CANCELLED")}});P&&console.log("actionSheet",o),f.actionSheet=o,f.actionStatus=!0}else if(e>0){t.title=p("translate")("SUCCESS"),t.text=p("translate")("SAVE_SUCCESS"),it(e),z(e);var o=a.show({titleText:t.text,cancelText:'<i class="icon ion-ios-arrow-down"></i>',cancel:function(){P&&console.log("CANCELLED")}});P&&console.log("actionSheet",o),f.actionSheet=o,f.actionStatus=!0}else P&&console.log("creazione/modifica ok!")}function W(t){var o=!1,r=function(e,t,o){return P&&console.log("markerFilter, comparison, a, b, equal ",e,t,o),Array.isArray(e)?o?(P&&console.log(e,"==",t,"? ",e==t),e.indexOf(t)>=0):e.indexOf(t)<0:o?(P&&console.log(e,"==",t,"? ",e==t),e==t):(P&&console.log(e,"!=",t,"? ",e!=t),e!=t)};P&&console.log("entry: ",t," Condizioni: ",e.filterConditions);for(key in e.filterConditions){P&&console.log("il tipo e' da includere? ",e.filterConditions[key].includeTypes.indexOf(t.entity_type)>-1);var a=0;if(e.filterConditions[key].includeCondition){var n=t[e.filterConditions[key].includeCondition.property],l=Object.keys(e.filterConditions[key].includeCondition.value)[0];a=n.map(function(e){return e[l].id}).indexOf(e.filterConditions[key].includeCondition.value[l]),P&&console.log("check per includeCondition ",a>-1)}if(P&&console.log("il tipo e' da includere? ",e.filterConditions[key].includeTypes.indexOf(t.entity_type)>-1),!e.filterConditions[key].excludeRule&&e.filterConditions[key].includeTypes.indexOf(t.entity_type)>-1&&a>-1){if(e.filterConditions[key].excludeProperty){var s=t[e.filterConditions[key].key];if(P&&console.log("Check esclusione regola: ",e.filterConditions[key].excludeProperty,t,e.filterConditions[key].key,s),!(!s||null===s||"undefined"===s||Array.isArray(s)&&0==s.length||angular.isObject(s)&&angular.equals(s,{})))return!1;console.log("property non impostata per: ",t,"prorpieta'",e.filterConditions[key].key)}var c=e.filterConditions[key].mandatory.condition,d=e.filterConditions[key].mandatory.values,f=e.filterConditions[key].equal,u=d;for(P&&console.log("Condizione: ",e.filterConditions[key]),i=0;i<e.filterConditions[key].values.length;i++)if(P&&console.log("valore i = ",i," valore valutato ",t," per chiave ",e.filterConditions[key].key),r(t[e.filterConditions[key].key],e.filterConditions[key].values[i],f)){if(d&&c)return P&&console.log("checkValues && checkCondition: true, esco "),!1;d&&(P&&console.log("checkValues: true, check = false "),u=!1)}else P&&console.log("val[key] == $scope.filterConditions[key].values[i]"),d||(P&&console.log("!checkValues, check = true"),u=!0);if(c&&!u)return!1;u&&(o=!0)}}return P&&console.log("Test entry: ",t,o),o}function Y(){function t(t){for(var o=0;o<t.length;o++){var i=t[o];i.icon=i.icons[e.favCat]?i.icons[e.favCat]:i.icon,i.eTimeline&&(i.eTimeline.icon=i.icons[e.favCat]?i.icons[e.favCat]:i.icon),P&&console.log("Check update ",i.id,!e.markersFiltered[i.id]),e.markersFiltered[i.id]||(e.markersFiltered[i.id]=i,P&&console.log("Aggiungo ",i,e.markersFiltered[i.id]))}}function o(t){for(key in e.markersFiltered){var o=e.markersFiltered[key];P&&console.log("Check delete ",o.id,t.map(function(e){return e.id}).indexOf(o.id),t.map(function(e){return e.id}).indexOf(o.id)<0),t.map(function(e){return e.id}).indexOf(o.id)<0&&(P&&console.log("Rimuovo ",e.markersFiltered[key]),delete e.markersFiltered[key])}}function i(){for(var t in e.markersFiltered){var o=e.markersFiltered[t],i=e.config.types.parent_relations[o.entity_type];for(var r in i){var a=i[r];!a.exclude&&o[a.field]&&e.markersFiltered[o[a.field]]&&delete e.markersFiltered[t]}}}e.markersFilteredArray=angular.copy(e.filtred),e.query&&(e.markersFilteredArray=p("filter")(e.markersFilteredArray,e.query)),t(e.markersFilteredArray),o(e.markersFilteredArray),f.$emit("timeline.refresh",{list:angular.copy(e.markersFiltered)}),i()}function J(){_.updateMarkersDistributed().then(function(t){P&&console.log("updateMarkersDistributed, markers: ",t),angular.extend(e.map.markers,t),Y()},function(e){console.log("updateMarkersDistributed, error",e)}),U()}function X(){_.resetMarkersDistributed().then(function(t){P&&console.log("updateMarkersDistributed, markers: ",t),e.map.markers=angular.copy(t),Y()},function(e){console.log("updateMarkersDistributed, error",e)}),U()}function Z(){e.markersFiltered={},e.markersFilteredArray=[],e.favCat=0,e.filters={},e.filterConditions=[];var t=e.config.types.list,o="key",i="entity_type",r=[],a={key:i,name:i,values:[],mandatory:{condition:!0,values:!1},equal:!1,excludeRule:!1,excludeProperty:!1,includeTypes:[]};e.filters[i]={list:t,toggle:1,iconSwitcher:!0,label:"TYPES",check:o,name:i,category_space:0,visible:!0};for(var n=0;n<e.filters[i].list.length;n++)e.filters[i].list[n].visible=!0,a.values.push(e.filters[i].list[n].key),a.includeTypes.push(e.filters[i].list[n].key),r.push(e.filters[i].list[n].key);e.filterConditions.push(a),P&&console.log("MapCtrl, init filtro entity_type: ",e.filters);for(var l=e.config.types.categories,n=0;n<l.length;n++){var s=l[n];if(s.is_visible){0==e.favCat&&s.is_visible&&(e.favCat=s.category_space);var i=s.name,o="id",a={key:"category_list",name:i,values:[],mandatory:{condition:!0,values:!1},equal:!1,excludeRule:!1,excludeProperty:!1,includeTypes:s.entities,includeCondition:{value:{category_space:s.category_space},property:"categories"}};for(e.filters[i]={list:s.categories,toggle:1,iconSwitcher:!0,label:i,check:o,name:i,category_space:s.category_space,visible:s.is_visible},j=0;j<e.filters[i].list.length;j++)e.filters[i].list[j].visible=!0,e.filters[i].list[j].key=e.filters[i].list[j].id,a.values.push(e.filters[i].list[j].id);e.filterConditions.push(a)}}if(e.config.map.area&&w.check&&w.list.length>1){var c="level",d="Levels",a={key:c,name:d,values:[],mandatory:{condition:!0,values:!1},equal:!1,excludeRule:!1,excludeProperty:!1,includeTypes:r,callbackPush:function(e){dt(e)},callbackPop:function(){}};e.filters[d]={list:w.list,toggle:1,iconSwitcher:!1,label:"Level",check:c,name:d,visible:!0};for(var n=0;n<e.filters[d].list.length;n++)e.filters[d].list[n].visible=!0,a.values.push(e.filters[d].list[n].key);e.filterConditions.push(a),P&&console.log("MapCtrl, init filtro level: ",e.filters[d],a)}}function tt(){var o=[],i=p("orderBy")(e.config.types.list,"id");for(k in i){var r="",n=p("translate")(i[k].name);r=r.concat('<i class="icon ').concat(i[k].icon).concat('"></i>'),r=r.concat(" ").concat(n),P&&console.log("test ",n),P&&console.log("MapCtrl, creazione dell'action sheet, aggiungo bottone: ",r),o.push({text:r,type:i[k].slug,simple_editor:i[k].simple_editor})}var l=p("translate")("CREATION_TEXT");P&&console.log("test ",l);var s=a.show({titleText:l,buttons:o,cancelText:'<i class="icon ion-ios-arrow-down"></i>',cancel:function(){P&&console.log("CANCELLED")},buttonClicked:function(o,i){P&&console.log("BUTTON CLICKED",o,i),e.switchEditMode(),s(),_.getCenter().then(function(o){var r={lat:o.lat,lng:o.lng,id:null,entity_type:i.type};i.simple_editor?e.$broadcast("simpleInsert",r):(console.log("MapCtrl, clickToAdd, params ",e.map,r),t.go("app.editor",r))},function(e){console.log("MapCtrl, clickToAdd, MapService.getCenter, error ",e)})}});P&&console.log("actionSheet",s),f.actionSheet=s,f.actionStatus=!0}function ot(t){var o=rt(t);return o>-1?(delete e.map.markers[o],!0):!1}function it(t){return 1>t?!1:void _.get(t).then(function(o){P&&console.log("MapCtrl, updateMarker, entityFactory.get, refresh marker ",t,o);var i=rt(o.id);i>-1?e.map.markers[i]=o:e.map.markers.push(o)},function(e){console.log("MapCtrl, updateMarker, entityFactory.get, errore ",e)})}function rt(t){var o=e.map.markers.map(function(e){return e.id}).indexOf(t);return o>-1?o:-1}function at(t){if(t===!1)for(var o in e.map.layers.overlays)console.log("spengo livello ",o),e.map.layers.overlays[o].visible=!1;else if(t===!0)for(var i in e.map.layers.overlays)e.map.layers.overlays[i].visible=!0;else if(0!==t||e.map.layers.overlays[0].visible)if(0===t&&e.map.layers.overlays[0].visible)for(var a in self.map.layers.overlays)e.map.layers.overlays[a].visible=!1;else e.map.layers.overlays[t].visible=e.map.layers.overlays[t].visible?!1:!0;else for(var r in self.map.layers.overlays)e.map.layers.overlays[r].visible=!0}function nt(t){switch(t){case"edit":e.editMode=!0;break;default:e.editMode=!1}_.changeMode(t),at(!e.editMode)}function lt(t){var o=rt(t);if(o>-1){var i=e.map.markers[o];P&&console.log("Location: ",i);var r={lat:i.lat,lng:i.lng};H(r),P&&console.log("nuova posizione",self.map.center)}else P&&console.log("chiamo per :",t),_.get(t).then(function(t){P&&console.log("Location: ",t),P&&console.log("nuova posizione",e.map.center);var o={lat:t.lat,lng:t.lng};H(o)},function(e){P&&console.log("Location error: ",e)})}function dt(t){e.geojson&&e.geojson.data&&e.config.map.area&&e.config.map.area.data&&(e.geojson.data=p("filter")(e.config.map.area.data.features,ft("level",t)),e.$broadcast("timeline.groups.setgroup",{group:t}),e.$apply(function(){ut("level",t)}))}function ft(e,t){return function(o){return!o.properties[e]&&0!==o.properties[e]||o.properties[e]==t?!0:!1}}function ut(t,o){var i=e.config.design.colors[e.config.design.disabled_color];for(var r in e.markersFiltered)if(e.markersFiltered[r][t]!==o){var a=angular.copy(e.markersFiltered[r].icons[e.favCat]?e.markersFiltered[r].icons[e.favCat]:e.markersFiltered[r].icon),n='<div class="pin-marker" style="background-color:'+i+'"></div><div class="icon-box"><i class="icon '+a.icon+'"></i></div>';a.html=n,a.color=i,a.index=e.config.design.disabled_color,e.markersFiltered[r].icon=a}else e.markersFiltered[r].icon=e.markersFiltered[r].icons[e.favCat]?e.markersFiltered[r].icons[e.favCat]:e.markersFiltered[r].icons[0]}function gt(t){for(var i=M.map.filters,r=0;r<i.length;r++){var a=i[r].search_param,n=i[r],l=e.filterConditions.map(function(e){return e.name}).indexOf(n.key);if(!n.skip)if(t[a]){var s={key:n.property,name:n.key,values:[t[a]],mandatory:{condition:!0,values:!1},equal:!1,excludeRule:!1,excludeProperty:!1,includeTypes:M.types.list.map(function(e){return e.key})};l>-1?e.filterConditions[l]=s:e.filterConditions.push(s)}else{var l=e.filterConditions.map(function(e){return e.name}).indexOf(n.key);l>-1&&e.filterConditions.splice(l,1)}}}function pt(){if(R){var t=M.map.min_zoom_geometry_layer;y.getMap("mymap").then(function(o){var i=o.getBounds(),r=o.getZoom(),a={lat:i._southWest.lat,lng:i._southWest.lng},n={lat:i._northEast.lat,lng:i._northEast.lng};r>=t?I.get(r,a,n).then(function(t){e.geojson.data=t},function(e){v.error(e)}):e.geojson.data.features=[]},function(e){v.error("MapService, getMapBounds, errore: ",e)})}}function mt(t){if(t.embed)switch(v.debug("modalita embed",t.embed),t.embed){case"viewer":e.viewer=!0}else e.viewer=!1}function vt(t){t.lat&&t.lng&&t.zoom&&(e.map.center.lat!=t.lat||t.lng!=e.map.center.lng||t.zoom!=e.map.center.zoom)&&B(t)}function yt(t,o){t.entity?(P&&console.log("trovato parametro entity, devo aprire una modal: ",t.entity),z(t.entity),B(parseInt(t.entity))):o.entity&&e.$broadcast("markerClickClose")}function Et(t,o){if(!t)return!1;var i=t.q,r=o&&o.q?o.q:null;return i&&r&&i==r?!1:(i&&""!=i?(v.debug("modalita filtro per testo q = ",i),e.query=i,Y()):""==i&&g.search("q",null),void(r&&""!=r&&!i&&(e.query=null,Y())))}var P=!1,w={check:!1};C.map.area.levels&&(w={check:!0},w.list=e.config.map.area.levels),e.config||(e.config=C);var M=C,R=M.map.geometry_layer;e.isMobile||(e.isMobile=ionic.Platform.isIPad()||ionic.Platform.isIOS()||ionic.Platform.isAndroid()||ionic.Platform.isWindowsPhone()),e.locate||(e.locate=B),e.area||(e.area=A.getArea(),e.buildings=e.area.places,P&&console.log("Area e favPlaces: ",e.area)),"undefined"===e.isLoggedIn&&(e.isLoggedIn=!1),"undefined"===self.watchSearchEnabled&&(self.watchSearchEnabled=!0),(!e.map||angular.equals(e.map,{}))&&(e.map=map),e.categories||(e.categories=e.config.types.categories),e.events={map:{enable:["click","moveend","focus","drag"],logic:"broadcast"},marker:{enable:["click"],logic:"broadcast"}},e.options1=null,e.details1="",e.editMode=!1;{var b,F=M.behaviour.moveend_delay;M.behaviour.bbox_reload_time}e.markersFiltered||Z(),e.geojson={data:{type:"FeatureCollection",features:[]},style:D},e.config.map.area&&e.config.map.area.data&&(e.geojson.data=angular.copy(e.config.map.area.data),e.config.map.area.style&&(e.geojson.style=angular.copy(e.config.map.area.style)),e.geojson.levels=w.check?w.list:null),e.$on("$stateChangeSuccess",function(){if(self.watchSearchEnabled=!1,mt(g.search()),Et(g.search()),v.log("sono in app.map e vengo da ",f.previousState,o),"app.maps"!==f.previousState){var t=T.get("user");switch(t?(P&&console.log("isLoggedIn? ",!0),e.isLoggedIn=!0):e.isLoggedIn=!1,e.map=_.getMap(),P&&console.log("MapCtrl, map all'ingresso di stato ",e.map),f.previousState){case"app.editor":P&&console.log("MapCtrl, cambio stato da intro: ",o),o.entity&&V(o.entity),o.entity&&o.entity>-1&&B(o);break;case"login":B(o),o.entity&&z(o.entity),o&&gt(o,{});break;default:P&&console.log("MapCtrl, gestione stato, default",o),o.entity&&z(o.entity),o&&gt(o,{})}}else P&&console.log("MapCtrl, gestione stato, ignorato perche' vengo da ",f.previousState)}),e.$on("leafletDirectiveMarker.mymap.click",function(t,o){v.log("MARKER CLICK...controlla, args: ",o,t),t.preventMapMarkerClick||(t.preventMapMarkerClick=!0,e.editMode||(o.model.focus=!1,z(o.model.id)))}),e.$on("leafletDirectiveMap.mymap.moveend",function(t){t.preventMapMoveend||(t.preventMapMoveend=!0,P&&console.log("Event: moveend...",e.map),e.config.map.area.data||pt(),e.editMode||(F>0?(b&&(P&&console.log("clearTimeout"),clearTimeout(b)),b=setTimeout(J,F)):J()))}),e.$on("openPlaceModal",function(e,t){e.preventOpenPlaceModal||(e.preventOpenPlaceModal=!0,$(t.marker))}),e.$on("closePlaceModal",function(e){e.preventClosePlaceModal||(e.preventClosePlaceModal=!0,G("entity"))}),e.$watch(function(){return g.search()},function(e,t){self.watchSearchEnabled&&(P&&console.log("check paramentro entity, old: ",t.entity," nuovo: ",e.entity," scelta ",!t.entity&&e.entity||t&&e.entity!=parseInt(t.entity)),vt(e),yt(e,t),gt(e,t),mt(e),Et(e,t)),self.watchSearchEnabled=!0},!0),e.filtred=[],e.$watch("map.markers",function(){e.map&&e.map.markers&&(P&&console.log("cambio dei Markers: ",e.map.markers,e.map.markers.length),e.filtred=p("filter")(e.map.markers,W),P&&console.log("cambio dei Markers, nuovi markers filtrati: ",e.filtred,e.filtred.length))},!0),e.$watch("filterConditions",function(){e.map&&e.map.markers&&(e.filtred=p("filter")(e.map.markers,W))},!0),e.$watch("filtred",function(e,t){angular.equals(e,t)||Y()},!0),e.$watch("query",function(e,t){v.debug("change query ",e),angular.equals(e,t)||Et(e,t)},!0),e.$on("startEditing",function(t,o){e.updateEntity=o,v.debug("check start editing ",o),o.skip?e.showASEdit():(B(o),nt("edit"))}),e.$on("endEditing",function(e,t){V(t.marker.id),e.preventDefault()}),e.$on("deleteMarker",function(e,t){ot(t.id),e.preventDefault()}),f.$on("timeUpdate",function(e){X(),e.preventDefault()}),e.$on("clickMarker",function(e,t){z(t.id),B(t.id),e.preventDefault()}),e.$on("switchMapLevel",function(e,t){w.check&&dt(t.level),e.preventDefault()}),e.isString=function(e){return"string"==typeof e?!0:!1},e.greaterThan=function(e,t){return function(o){return o[e]>t}},e.differentThan=function(e,t){return function(o){return o[e]!=t}},e.switchEditMode=function(){e.config.dev&&P&&console.log("MapCtrl, switchEditMode editMode ",e.map.mode),e.editMode?(nt("view"),e.updateEntity=null):nt("edit")},e.showModalFavPlace=function(){e.filterFavPlace={},P&&console.log("check area: ",e.area),r.fromTemplateUrl("templates/form/filterFavPlace.html",{scope:e,animation:"fade-in",backdropClickToClose:!0,hardwareBackButtonClose:!0,focusFirstInput:!0}).then(function(t){e.filterFavPlace.modal=t,e.openFilterFavPlace(),f.modal=t,f.modalStatus=!0}),e.openFilterFavPlace=function(){e.filterFavPlace.modal.show()},e.closeFilterFavPlace=function(){e.filterFavPlace.modal.remove()},e.$on("modal.hidden",function(){delete e.filterFavPlace.modal}),e.$on("$destroy",function(){e.filterFavPlace.modal.remove()})},e.showMFilterCat=function(){e.filterCat={},r.fromTemplateUrl("templates/modals/filterCat.html",{scope:e,animation:"fade-in"}).then(function(t){e.filterCat.modal=t,e.openFilterCat(),f.modal=t,f.modalStatus=!0}),e.openFilterCat=function(){e.filterCat.modal.show()},e.closeFilterCat=function(){e.filterCat.modal.remove()},e.$on("modal.hidden",function(){delete e.filterCat.modal}),e.$on("$destroy",function(){e.filterCat.modal.remove()})},e.showASEdit=function(){if(e.updateEntity&&e.updateEntity.id){var o={lat:e.map.center.lat,lng:e.map.center.lng,id:e.updateEntity.id};t.go("app.editor",o),nt("view")}if(e.updateEntity){var o={};for(var i in e.updateEntity)o[i]=e.updateEntity[i];o.lat=e.map.center.lat,o.lng=e.map.center.lng,t.go("app.editor",o),nt("view")}else tt()},e.toggleFilter=function(t,o){var i=e.filterConditions.map(function(e){return e.name}).indexOf(t);if(v.debug("Indice regola filtro: ",i,t,o),0>i&&(e.filterConditions[i]={},e.filterConditions[i].values=[null],e.filterConditions[i].mandatory={condition:!0,values:!1},e.filterConditions[i].equal=!1,e.filterConditions[i].excludeRule=!1,e.filterConditions[i].excludeProperty=!1,P&&console.log("Init della regola: ",e.filterConditions[i])),P&&console.log("Chiave? ",o),o||0===o){var r=e.filterConditions[i].values.indexOf(o);P&&console.log("Aggiungo/rimuovo chiave: ",o," a ",e.filterConditions[i].values," indice: ",r),P&&console.log("Intervengo qui: ",e.filters[t].list);var a=e.filters[t].list.map(function(e){return e.key}).indexOf(o);0>r?(e.filterConditions[i].values.push(o),e.filters[t].list[a].visible=!0,e.filterConditions[i].callbackPush&&e.filterConditions[i].callbackPush(o)):(e.filterConditions[i].values.splice(r,1),e.filters[t].list[a].visible=!1,e.filterConditions[i].callbackPop&&e.filterConditions[i].callbackPop(o)),e.filterConditions[i].excludeRule=!1,e.filterConditions[i].excludeRule=!1,e.filters[t].toggle=1,P&&console.log("Aggiunta o rimossa chiave: ",e.filterConditions[i].values," vado in stato 1")}else P&&console.log("Niente chiave, faccio toggle"),e.filterConditions[i].excludeRule||e.filterConditions[i].excludeProperty?e.filterConditions[i].excludeRule&&!e.filterConditions[i].excludeProperty?(P&&console.log("Stato 2 vado in 3"),e.filterConditions[i].excludeRule=!1,e.filterConditions[i].excludeProperty=!0,e.filters[t].toggle=3):!e.filterConditions[i].excludeRule&&e.filterConditions[i].excludeProperty&&(P&&console.log("Stato 3 vado in 1"),e.filterConditions[i].excludeRule=!1,e.filterConditions[i].excludeProperty=!1,e.filters[t].toggle=1):(P&&console.log("Stato 1 vado in 2"),e.filterConditions[i].excludeRule=!0,e.filterConditions[i].excludeProperty=!1,e.filters[t].toggle=2)},e.changeFavCat=function(t){s.show({animation:"fade-in",showBackdrop:!1,maxWidth:50,showDelay:0}),P&&console.log("cambio favCat da ",e.favCat," a ",t),e.favCat=t;for(i in e.markersFiltered)P&&console.log("cambio icona al marker ",e.markersFiltered[i]),e.markersFiltered[i].icon=e.markersFiltered[i].icons[e.favCat]?e.markersFiltered[i].icons[e.favCat]:e.markersFiltered[i].icon;s.hide(),e.closeFilterCat()},e.showWall=function(){P&&console.log("MapCtrl, showWall!"),P&&console.log("check area: ",e.area),r.fromTemplateUrl("templates/modals/wall.html",{scope:e,animation:"fade-in"}).then(function(t){e.wall=t,e.wall.show()}),e.closeWall=function(){e.wall.remove()},e.$on("modal.hidden",function(){delete e.wall}),e.$on("$destroy",function(){e.wall.remove()}),e.clickWallItem=function(t){e.closeWall(),z(t.id),B(t.id)}},e.query=null}]).run(function(e,t,o,i){self.map=e.initMap();var r=config.behaviour.bbox_reload_time,a=!1,n=function(){o.cancel(a),i.$broadcast("leafletDirectiveMap.mymap.moveend"),a=o(function(){console.log("polling!"),n()},r)};n()});