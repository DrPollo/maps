angular.module("firstlife.controllers").controller("MapCtrl",["$scope","$state","$stateParams","$ionicModal","$ionicActionSheet","$ionicPopup","$cordovaGeolocation","$ionicLoading","$q","$ionicPopover","$rootScope","$window","$location","$filter","$timeout","$log","leafletData","leafletMapEvents","entityFactory","MapService","myConfig","PlatformService","MemoryFactory","AreaService","leafletMarkersHelpers","indexingFactory","tilesFactory",function(e,t,o,n,a,l,r,s,c,f,u,d,p,g,m,v,y,h,C,b,M,F,x,w,S,P,_){function q(i){var t=i.properties,n=(e.markersFilteredArray.length,{fillColor:"#6C93B3",weight:3,opacity:1,color:"#6C93B3",dashArray:"1",fillOpacity:.5});return t.entities.length>0&&(n.fillColor="rgb(136, 186, 92)"),t.entities.length>20&&(n.fillColor="rgb(255,179,16)"),t.entities.length>40&&(n.fillColor="rgb(221,91,42)"),n}function D(i){$&&console.log("markerClick! ",i),e.$broadcast("markerClick",{markerId:parseInt(i)})}function N(){var e=p.search();b.getCenter().then(function(i){$&&console.log("centro della mappa, ",i),(e.lat!=i.lat||e.lng!=i.lng||e.zoom!=i.zoom)&&B(i)},function(e){$&&console.log("updatePositionInSearch, MapService.getCenter, errore: ",e)})}function W(e){b.getCenter().then(function(i){i.entity=e,B(i)},function(e){$&&console.log("updatePlaceInSearch, MapService.getCenter, errore: ",e)})}function B(e){for(key in e)self.watchSearchEnabled=!1,p.search(key,e[key]);$&&console.log("nuovi parametri search: ",p.search(),e)}function U(e){self.watchSearchEnabled=!1,p.search(e,null),self.watchSearchEnabled=!0}function V(i){if($&&console.log("centro su luogo, id: "+typeof i+" ",i),"object"==typeof i&&"entity"in i&&i.entity)ci(i.entity);else if("number"==typeof i)ci(i);else if("object"==typeof i&&"bound"in i)$&&console.log("centro su bounds: ",i),K(i);else if("object"==typeof i&&"lat"in i&&"lng"in i&&i.lat&&i.lng){$&&console.log("centro su coordinate: ",i);var t={lat:parseFloat(i.lat),lng:parseFloat(i.lng),zoom:parseInt(i.zoom?i.zoom:T.map.zoom_create)};$&&console.log("centro su coordinate: ",t),K(t)}else if("user"===i)s.show({content:'<div>Localizzazione in corso...<br> Assicurati di aver abilitato il gps o il browser!<i class="icon ion-loading-c"></i></div>',animation:"fade-in",showBackdrop:!1,maxWidth:50,showDelay:0}),r.getCurrentPosition().then(function(t){$&&console.log(i),e.markersFiltered[0]={lat:t.coords.latitude,lng:t.coords.longitude,focus:!0,draggable:!1};var o={lat:t.coords.latitude,lng:t.coords.longitude,zoom:parseInt(T.map.zoom_create)};K(o),s.hide()},function(e){$&&console.log("Location error: ",e),s.hide()});else{var t={lat:parseFloat(e.config.map.map_default_lat),lng:parseFloat(e.config.map.map_default_lng),zoom:parseInt(e.config.map.zoom_level)};K(t)}}function K(e){y.getMap("mymap").then(function(i){if($&&console.log("MapService, setMapCenter, response: ",i," params ",e),e.bound)i.fitBounds(e.bound);else if(e.zoom){var t=new L.LatLng(e.lat,e.lng);i.setView(t,e.zoom)}else{var t=new L.LatLng(e.lat,e.lng);i.panTo(t)}var o=i.getCenter(),n=i.getZoom(),a={lat:o.lat,lng:o.lng,zoom:n};$&&console.log("Nuovo centro della mappa",a)},function(e){$&&console.log("MapService, setMapCenter, errore: ",e)})}function Z(e){v.debug("MapCtrl, backFromEditor, entityId: ",e);var i={};if(-1==e){i.title=g("translate")("ERROR"),i.text=g("translate")("UNKNOWN_ERROR");var t=a.show({titleText:i.text,cancelText:'<i class="icon ion-ios-arrow-down"></i>',cancel:function(){$&&console.log("CANCELLED")}});$&&console.log("actionSheet",t),u.actionSheet=t,u.actionStatus=!0}if(-2==e){i.title=g("translate")("SUCCESS"),i.text=g("translate")("SUCCESS_MODARATION");var t=a.show({titleText:i.text,cancelText:'<i class="icon ion-ios-arrow-down"></i>',cancel:function(){$&&console.log("CANCELLED")}});$&&console.log("actionSheet",t),u.actionSheet=t,u.actionStatus=!0}else if(e>0){i.title=g("translate")("SUCCESS"),i.text=g("translate")("SAVE_SUCCESS"),ai(e),D(e);var t=a.show({titleText:i.text,cancelText:'<i class="icon ion-ios-arrow-down"></i>',cancel:function(){$&&console.log("CANCELLED")}});$&&console.log("actionSheet",t),u.actionSheet=t,u.actionStatus=!0}else $&&console.log("creazione/modifica ok!")}function H(t){var o=!1,n=function(e,i,t){return $&&console.log("markerFilter, comparison, a, b, equal ",e,i,t),Array.isArray(e)?t?($&&console.log(e,"==",i,"? ",e==i),e.indexOf(i)>=0):e.indexOf(i)<0:t?($&&console.log(e,"==",i,"? ",e==i),e==i):($&&console.log(e,"!=",i,"? ",e!=i),e!=i)};$&&console.log("entry: ",t," Condizioni: ",e.filterConditions);for(key in e.filterConditions){$&&console.log("il tipo e' da includere? ",e.filterConditions[key].includeTypes.indexOf(t.entity_type)>-1);var a=0;if(e.filterConditions[key].includeCondition){var l=t[e.filterConditions[key].includeCondition.property],r=Object.keys(e.filterConditions[key].includeCondition.value)[0];a=l.map(function(e){return e[r].id}).indexOf(e.filterConditions[key].includeCondition.value[r]),$&&console.log("check per includeCondition ",a>-1)}if($&&console.log("il tipo e' da includere? ",e.filterConditions[key].includeTypes.indexOf(t.entity_type)>-1),!e.filterConditions[key].excludeRule&&e.filterConditions[key].includeTypes.indexOf(t.entity_type)>-1&&a>-1){if(e.filterConditions[key].excludeProperty){var s=t[e.filterConditions[key].key];if($&&console.log("Check esclusione regola: ",e.filterConditions[key].excludeProperty,t,e.filterConditions[key].key,s),!(!s||null===s||"undefined"===s||Array.isArray(s)&&0==s.length||angular.isObject(s)&&angular.equals(s,{})))return!1;console.log("property non impostata per: ",t,"prorpieta'",e.filterConditions[key].key)}var c=e.filterConditions[key].mandatory.condition,f=e.filterConditions[key].mandatory.values,u=e.filterConditions[key].equal,d=f;for($&&console.log("Condizione: ",e.filterConditions[key]),i=0;i<e.filterConditions[key].values.length;i++)if($&&console.log("valore i = ",i," valore valutato ",t," per chiave ",e.filterConditions[key].key),n(t[e.filterConditions[key].key],e.filterConditions[key].values[i],u)){if(f&&c)return $&&console.log("checkValues && checkCondition: true, esco "),!1;f&&($&&console.log("checkValues: true, check = false "),d=!1)}else $&&console.log("val[key] == $scope.filterConditions[key].values[i]"),f||($&&console.log("!checkValues, check = true"),d=!0);if(c&&!d)return!1;d&&(o=!0)}}return $&&console.log("Test entry: ",t,o),o}function X(){function i(i){for(var t=0;t<i.length;t++){var o=i[t];o.icon=o.icons[e.favCat]?o.icons[e.favCat]:o.icon,o.eTimeline&&(o.eTimeline.icon=o.icons[e.favCat]?o.icons[e.favCat]:o.icon),$&&console.log("Check update ",o.id,!e.markersFiltered[o.id]),e.markersFiltered[o.id]||(e.markersFiltered[o.id]=o,$&&console.log("Aggiungo ",o,e.markersFiltered[o.id]))}}function t(i){for(key in e.markersFiltered){var t=e.markersFiltered[key];$&&console.log("Check delete ",t.id,i.map(function(e){return e.id}).indexOf(t.id),i.map(function(e){return e.id}).indexOf(t.id)<0),i.map(function(e){return e.id}).indexOf(t.id)<0&&($&&console.log("Rimuovo ",e.markersFiltered[key]),delete e.markersFiltered[key])}}function o(){for(var i in e.markersFiltered){var t=e.markersFiltered[i],o=e.config.types.parent_relations[t.entity_type];for(var n in o){var a=o[n];!a.exclude&&t[a.field]&&e.markersFiltered[t[a.field]]&&delete e.markersFiltered[i]}}}e.markersFilteredArray=angular.copy(e.filtred),e.query&&(e.markersFilteredArray=g("filter")(e.markersFilteredArray,e.query)),i(e.markersFilteredArray),t(e.markersFilteredArray),u.$emit("timeline.refresh",{list:angular.copy(e.markersFiltered)}),o()}function J(){b.updateMarkersDistributed().then(function(i){$&&console.log("updateMarkersDistributed, markers: ",i),angular.extend(e.map.markers,i),X()},function(e){console.log("updateMarkersDistributed, error",e)}),N()}function Q(){b.resetMarkersDistributed().then(function(i){$&&console.log("updateMarkersDistributed, markers: ",i),e.map.markers=angular.copy(i),X()},function(e){console.log("updateMarkersDistributed, error",e)}),N()}function ei(){e.markersFiltered={},e.markersFilteredArray=[],e.favCat=0,e.filters={},e.filterConditions=[];var i=e.config.types.list,t="key",o="entity_type",n=[],a={key:o,name:o,values:[],mandatory:{condition:!0,values:!1},equal:!1,excludeRule:!1,excludeProperty:!1,includeTypes:[]};e.filters[o]={list:i,toggle:1,iconSwitcher:!0,label:"TYPES",check:t,name:o,category_space:0,visible:!0};for(var l=0;l<e.filters[o].list.length;l++)e.filters[o].list[l].visible=!0,a.values.push(e.filters[o].list[l].key),a.includeTypes.push(e.filters[o].list[l].key),n.push(e.filters[o].list[l].key);e.filterConditions.push(a),$&&console.log("MapCtrl, init filtro entity_type: ",e.filters);for(var r=e.config.types.categories,l=0;l<r.length;l++){var s=r[l];if(s.is_visible){0==e.favCat&&s.is_visible&&(e.favCat=s.category_space);var o=s.name,t="id",a={key:"category_list",name:o,values:[],mandatory:{condition:!0,values:!1},equal:!1,excludeRule:!1,excludeProperty:!1,includeTypes:s.entities,includeCondition:{value:{category_space:s.category_space},property:"categories"}};for(e.filters[o]={list:s.categories,toggle:1,iconSwitcher:!0,label:o,check:t,name:o,category_space:s.category_space,visible:s.is_visible},j=0;j<e.filters[o].list.length;j++)e.filters[o].list[j].visible=!0,e.filters[o].list[j].key=e.filters[o].list[j].id,a.values.push(e.filters[o].list[j].id);e.filterConditions.push(a)}}if(e.config.map.area&&E.check&&E.list.length>1){var c="level",f="Levels",a={key:c,name:f,values:[],mandatory:{condition:!0,values:!1},equal:!1,excludeRule:!1,excludeProperty:!1,includeTypes:n,callbackPush:function(e){di(e)},callbackPop:function(){}};e.filters[f]={list:E.list,toggle:1,iconSwitcher:!1,label:"Level",check:c,name:f,visible:!0};for(var l=0;l<e.filters[f].list.length;l++)e.filters[f].list[l].visible=!0,a.values.push(e.filters[f].list[l].key);e.filterConditions.push(a),$&&console.log("MapCtrl, init filtro level: ",e.filters[f],a)}}function oi(){var i=[],o=g("orderBy")(e.config.types.list,"id");for(k in o){var n="",l=g("translate")(o[k].name);n=n.concat('<i class="icon ').concat(o[k].icon).concat('"></i>'),n=n.concat(" ").concat(l),$&&console.log("test ",l),$&&console.log("MapCtrl, creazione dell'action sheet, aggiungo bottone: ",n),i.push({text:n,type:o[k].slug,simple_editor:o[k].simple_editor})}var r=g("translate")("CREATION_TEXT");$&&console.log("test ",r);var s=a.show({titleText:r,buttons:i,cancelText:'<i class="icon ion-ios-arrow-down"></i>',cancel:function(){$&&console.log("CANCELLED")},buttonClicked:function(i,o){$&&console.log("BUTTON CLICKED",i,o),e.switchEditMode(),s(),b.getCenter().then(function(i){var n={lat:i.lat,lng:i.lng,id:null,entity_type:o.type};o.simple_editor?e.$broadcast("simpleInsert",n):(console.log("MapCtrl, clickToAdd, params ",e.map,n),t.go("app.editor",n))},function(e){console.log("MapCtrl, clickToAdd, MapService.getCenter, error ",e)})}});$&&console.log("actionSheet",s),u.actionSheet=s,u.actionStatus=!0}function ni(i){var t=li(i);return t>-1?(delete e.map.markers[t],!0):!1}function ai(i){return 1>i?!1:void b.get(i).then(function(t){$&&console.log("MapCtrl, updateMarker, entityFactory.get, refresh marker ",i,t);var o=li(t.id);o>-1?e.map.markers[o]=t:e.map.markers.push(t)},function(e){console.log("MapCtrl, updateMarker, entityFactory.get, errore ",e)})}function li(i){var t=e.map.markers.map(function(e){return e.id}).indexOf(i);return t>-1?t:-1}function ri(i){if(i===!1)for(var t in e.map.layers.overlays)console.log("spengo livello ",t),e.map.layers.overlays[t].visible=!1;else if(i===!0)for(var o in e.map.layers.overlays)e.map.layers.overlays[o].visible=!0;else if(0!==i||e.map.layers.overlays[0].visible)if(0===i&&e.map.layers.overlays[0].visible)for(var a in self.map.layers.overlays)e.map.layers.overlays[a].visible=!1;else e.map.layers.overlays[i].visible=e.map.layers.overlays[i].visible?!1:!0;else for(var n in self.map.layers.overlays)e.map.layers.overlays[n].visible=!0}function si(i){switch(i){case"edit":e.editMode=!0;break;default:e.editMode=!1}b.changeMode(i),ri(!e.editMode)}function ci(i){var t=li(i);if(t>-1){var o=e.map.markers[t];$&&console.log("Location: ",o);var n={lat:o.lat,lng:o.lng};K(n),$&&console.log("nuova posizione",self.map.center)}else $&&console.log("chiamo per :",i),b.get(i).then(function(i){$&&console.log("Location: ",i),$&&console.log("nuova posizione",e.map.center);var t={lat:i.lat,lng:i.lng};K(t)},function(e){$&&console.log("Location error: ",e)})}function di(i){e.geojson&&e.geojson.data&&e.config.map.area&&e.config.map.area.data&&(e.geojson.data=g("filter")(e.config.map.area.data.features,pi("level",i)),e.$broadcast("timeline.groups.setgroup",{group:i}),e.$apply(function(){gi("level",i)}))}function pi(e,i){return function(t){return!t.properties[e]&&0!==t.properties[e]||t.properties[e]==i?!0:!1}}function gi(i,t){var o=e.config.design.colors[e.config.design.disabled_color];for(var n in e.markersFiltered)if(e.markersFiltered[n][i]!==t){var a=angular.copy(e.markersFiltered[n].icons[e.favCat]?e.markersFiltered[n].icons[e.favCat]:e.markersFiltered[n].icon),l='<div class="pin-marker" style="background-color:'+o+'"></div><div class="icon-box"><i class="icon '+a.icon+'"></i></div>';a.html=l,a.color=o,a.index=e.config.design.disabled_color,e.markersFiltered[n].icon=a}else e.markersFiltered[n].icon=e.markersFiltered[n].icons[e.favCat]?e.markersFiltered[n].icons[e.favCat]:e.markersFiltered[n].icons[0]}function mi(i){for(var o=T.map.filters,n=0;n<o.length;n++){var a=o[n].search_param,l=o[n],r=e.filterConditions.map(function(e){return e.name}).indexOf(l.key);if(!l.skip)if(i[a]){var s={key:l.property,name:l.key,values:[i[a]],mandatory:{condition:!0,values:!1},equal:!1,excludeRule:!1,excludeProperty:!1,includeTypes:T.types.list.map(function(e){return e.key})};r>-1?e.filterConditions[r]=s:e.filterConditions.push(s)}else{var r=e.filterConditions.map(function(e){return e.name}).indexOf(l.key);r>-1&&e.filterConditions.splice(r,1)}}}function vi(){if(A){var i=T.map.min_zoom_geometry_layer;y.getMap("mymap").then(function(t){var o=t.getBounds(),n=t.getZoom(),a={lat:o._southWest.lat,lng:o._southWest.lng},l={lat:o._northEast.lat,lng:o._northEast.lng};n>=i?P.get(n,a,l).then(function(i){e.geojson.data=i},function(e){v.error(e)}):e.geojson.data.features=[]},function(e){v.error("MapService, getMapBounds, errore: ",e)})}}function yi(i){if(i.embed)switch(v.debug("modalita embed",i.embed),i.embed){case"viewer":e.viewer=!0}else e.viewer=!1}function ki(i){i.lat&&i.lng&&i.zoom&&(e.map.center.lat!=i.lat||i.lng!=e.map.center.lng||i.zoom!=e.map.center.zoom)&&V(i)}function hi(i,t){i.entity?($&&console.log("trovato parametro entity, devo aprire una modal: ",i.entity),D(i.entity),V(parseInt(i.entity))):t.entity&&e.$broadcast("markerClickClose")}function Ci(i,t){if(!i)return!1;var o=i.q,n=t&&t.q?t.q:null;return o&&n&&o==n?!1:(o&&""!=o?(v.debug("modalita filtro per testo q = ",o),e.query=o,X()):""==o&&p.search("q",null),void(n&&""!=n&&!o&&(e.query=null,X())))}var $=!1,E={check:!1};M.map.area.levels&&(E={check:!0},E.list=e.config.map.area.levels),e.config||(e.config=M);var T=M,A=T.map.geometry_layer;e.isMobile||(e.isMobile=ionic.Platform.isIPad()||ionic.Platform.isIOS()||ionic.Platform.isAndroid()||ionic.Platform.isWindowsPhone()),e.locate||(e.locate=V),e.area||(e.area=w.getArea(),e.buildings=e.area.places,$&&console.log("Area e favPlaces: ",e.area)),"undefined"===e.isLoggedIn&&(e.isLoggedIn=!1),"undefined"===self.watchSearchEnabled&&(self.watchSearchEnabled=!0),(!e.map||angular.equals(e.map,{}))&&(e.map=map),e.categories||(e.categories=e.config.types.categories),e.events={map:{enable:["click","moveend","focus","drag"],logic:"broadcast"},marker:{enable:["click"],logic:"broadcast"}},e.options1=null,e.details1="",e.editMode=!1;{var I,O=T.behaviour.moveend_delay;T.behaviour.bbox_reload_time}e.markersFiltered||ei(),e.geojson={data:{type:"FeatureCollection",features:[]},style:q},e.config.map.area&&e.config.map.area.data&&(e.geojson.data=angular.copy(e.config.map.area.data),e.config.map.area.style&&(e.geojson.style=angular.copy(e.config.map.area.style)),e.geojson.levels=E.check?E.list:null);var R=null;R||y.getMap("mymap").then(function(e){return R=new L.TileLayer.Functional(function(e){_.subscribe(e.x,e.y,e.z)},function(e){v.info("unsubscribe tile x",e.x," y ",e.y," z ",e.z),_.unsubscribe(e.x,e.y,e.z)}),R.addTo(e),v.debug("init map",e),null},{reuseTiles:!1,updateWhenIdle:!0,unloadInvisibleTiles:!0}),e.$on("$stateChangeSuccess",function(){if(self.watchSearchEnabled=!1,yi(p.search()),Ci(p.search()),v.log("sono in app.map e vengo da ",u.previousState,o),"app.maps"!==u.previousState){var i=x.get("user");switch(i?($&&console.log("isLoggedIn? ",!0),e.isLoggedIn=!0):e.isLoggedIn=!1,e.map=b.getMap(),v.debug("MapCtrl, map all'ingresso di stato ",e.map),u.previousState){case"app.editor":$&&console.log("MapCtrl, cambio stato da intro: ",o),o.entity&&Z(o.entity),o.entity&&o.entity>-1&&V(o);break;case"login":V(o),o.entity&&D(o.entity),o&&mi(o,{});break;default:$&&console.log("MapCtrl, gestione stato, default",o),o.entity&&D(o.entity),o&&mi(o,{})}}else $&&console.log("MapCtrl, gestione stato, ignorato perche' vengo da ",u.previousState)}),e.$on("leafletDirectiveMarker.mymap.click",function(i,t){v.log("MARKER CLICK...controlla, args: ",t,i),i.preventMapMarkerClick||(i.preventMapMarkerClick=!0,e.editMode||(t.model.focus=!1,D(t.model.id)))}),e.$on("leafletDirectiveMap.mymap.moveend",function(i){i.preventMapMoveend||(i.preventMapMoveend=!0,$&&console.log("Event: moveend...",e.map),e.config.map.area.data||vi(),e.editMode||(O>0?(I&&($&&console.log("clearTimeout"),clearTimeout(I)),I=setTimeout(J,O)):J()))}),e.$on("openPlaceModal",function(e,i){e.preventOpenPlaceModal||(e.preventOpenPlaceModal=!0,W(i.marker))}),e.$on("closePlaceModal",function(e){e.preventClosePlaceModal||(e.preventClosePlaceModal=!0,U("entity"))}),e.$watch(function(){return p.search()},function(e,i){self.watchSearchEnabled&&($&&console.log("check paramentro entity, old: ",i.entity," nuovo: ",e.entity," scelta ",!i.entity&&e.entity||i&&e.entity!=parseInt(i.entity)),ki(e),hi(e,i),mi(e,i),yi(e),Ci(e,i)),self.watchSearchEnabled=!0},!0),e.filtred=[],e.$watch("map.markers",function(){e.map&&e.map.markers&&($&&console.log("cambio dei Markers: ",e.map.markers,e.map.markers.length),e.filtred=g("filter")(e.map.markers,H),$&&console.log("cambio dei Markers, nuovi markers filtrati: ",e.filtred,e.filtred.length))},!0),e.$watch("filterConditions",function(){e.map&&e.map.markers&&(e.filtred=g("filter")(e.map.markers,H))},!0),e.$watch("filtred",function(e,i){angular.equals(e,i)||X()},!0),e.$watch("query",function(e,i){v.debug("change query ",e),angular.equals(e,i)||Ci(e,i)},!0),e.$on("startEditing",function(i,t){e.updateEntity=t,v.debug("check start editing ",t),t.skip?e.showASEdit():(V(t),si("edit"))}),e.$on("endEditing",function(e,i){Z(i.marker.id),e.preventDefault()}),e.$on("deleteMarker",function(e,i){ni(i.id),e.preventDefault()}),u.$on("timeUpdate",function(e){Q(),e.preventDefault()}),e.$on("clickMarker",function(e,i){D(i.id),V(i.id),e.preventDefault()}),e.$on("switchMapLevel",function(e,i){E.check&&di(i.level),e.preventDefault()}),e.isString=function(e){return"string"==typeof e?!0:!1},e.greaterThan=function(e,i){return function(t){return t[e]>i}},e.differentThan=function(e,i){return function(t){return t[e]!=i}},e.switchEditMode=function(){e.config.dev&&$&&console.log("MapCtrl, switchEditMode editMode ",e.map.mode),e.editMode?(si("view"),e.updateEntity=null):si("edit")},e.showModalFavPlace=function(){e.filterFavPlace={},$&&console.log("check area: ",e.area),n.fromTemplateUrl("templates/form/filterFavPlace.html",{scope:e,animation:"fade-in",backdropClickToClose:!0,hardwareBackButtonClose:!0,focusFirstInput:!0}).then(function(i){e.filterFavPlace.modal=i,e.openFilterFavPlace(),u.modal=i,u.modalStatus=!0}),e.openFilterFavPlace=function(){e.filterFavPlace.modal.show()},e.closeFilterFavPlace=function(){e.filterFavPlace.modal.remove()},e.$on("modal.hidden",function(){delete e.filterFavPlace.modal}),e.$on("$destroy",function(){e.filterFavPlace.modal.remove()})},e.showMFilterCat=function(){e.filterCat={},n.fromTemplateUrl("templates/modals/filterCat.html",{scope:e,animation:"fade-in"}).then(function(i){e.filterCat.modal=i,e.openFilterCat(),u.modal=i,u.modalStatus=!0}),e.openFilterCat=function(){e.filterCat.modal.show()},e.closeFilterCat=function(){e.filterCat.modal.remove()},e.$on("modal.hidden",function(){delete e.filterCat.modal}),e.$on("$destroy",function(){e.filterCat.modal.remove()})},e.showASEdit=function(){if(e.updateEntity&&e.updateEntity.id){var i={lat:e.map.center.lat,lng:e.map.center.lng,id:e.updateEntity.id};t.go("app.editor",i),si("view")}if(e.updateEntity){var i={};for(var o in e.updateEntity)i[o]=e.updateEntity[o];i.lat=e.map.center.lat,i.lng=e.map.center.lng,t.go("app.editor",i),si("view")}else oi()},e.toggleFilter=function(i,t){var o=e.filterConditions.map(function(e){return e.name}).indexOf(i);if(v.debug("Indice regola filtro: ",o,i,t),0>o&&(e.filterConditions[o]={},e.filterConditions[o].values=[null],e.filterConditions[o].mandatory={condition:!0,values:!1},e.filterConditions[o].equal=!1,e.filterConditions[o].excludeRule=!1,e.filterConditions[o].excludeProperty=!1,$&&console.log("Init della regola: ",e.filterConditions[o])),$&&console.log("Chiave? ",t),t||0===t){var n=e.filterConditions[o].values.indexOf(t);$&&console.log("Aggiungo/rimuovo chiave: ",t," a ",e.filterConditions[o].values," indice: ",n),$&&console.log("Intervengo qui: ",e.filters[i].list);var a=e.filters[i].list.map(function(e){return e.key}).indexOf(t);0>n?(e.filterConditions[o].values.push(t),e.filters[i].list[a].visible=!0,e.filterConditions[o].callbackPush&&e.filterConditions[o].callbackPush(t)):(e.filterConditions[o].values.splice(n,1),e.filters[i].list[a].visible=!1,e.filterConditions[o].callbackPop&&e.filterConditions[o].callbackPop(t)),e.filterConditions[o].excludeRule=!1,e.filterConditions[o].excludeRule=!1,e.filters[i].toggle=1,$&&console.log("Aggiunta o rimossa chiave: ",e.filterConditions[o].values," vado in stato 1")}else $&&console.log("Niente chiave, faccio toggle"),e.filterConditions[o].excludeRule||e.filterConditions[o].excludeProperty?e.filterConditions[o].excludeRule&&!e.filterConditions[o].excludeProperty?($&&console.log("Stato 2 vado in 3"),e.filterConditions[o].excludeRule=!1,e.filterConditions[o].excludeProperty=!0,e.filters[i].toggle=3):!e.filterConditions[o].excludeRule&&e.filterConditions[o].excludeProperty&&($&&console.log("Stato 3 vado in 1"),e.filterConditions[o].excludeRule=!1,e.filterConditions[o].excludeProperty=!1,e.filters[i].toggle=1):($&&console.log("Stato 1 vado in 2"),e.filterConditions[o].excludeRule=!0,e.filterConditions[o].excludeProperty=!1,e.filters[i].toggle=2)},e.changeFavCat=function(t){s.show({animation:"fade-in",showBackdrop:!1,maxWidth:50,showDelay:0}),$&&console.log("cambio favCat da ",e.favCat," a ",t),e.favCat=t;for(i in e.markersFiltered)$&&console.log("cambio icona al marker ",e.markersFiltered[i]),e.markersFiltered[i].icon=e.markersFiltered[i].icons[e.favCat]?e.markersFiltered[i].icons[e.favCat]:e.markersFiltered[i].icon;s.hide(),e.closeFilterCat()},e.showWall=function(){$&&console.log("MapCtrl, showWall!"),$&&console.log("check area: ",e.area),n.fromTemplateUrl("templates/modals/wall.html",{scope:e,animation:"fade-in"}).then(function(i){e.wall=i,e.wall.show()}),e.closeWall=function(){e.wall.remove()},e.$on("modal.hidden",function(){delete e.wall}),e.$on("$destroy",function(){e.wall.remove()}),e.clickWallItem=function(i){e.closeWall(),D(i.id),V(i.id)}},e.query=null}]).run(function(e,i,t,o){self.map=e.initMap();var n=config.behaviour.bbox_reload_time,a=!1,l=function(){t.cancel(a),o.$broadcast("leafletDirectiveMap.mymap.moveend"),a=t(function(){console.log("polling!"),l()},n)};l()});